<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PredictFootball.ai â€“ League Table</title>
<style>
  :root{
    --bg: #30A278;
    --card: #000000;
    --border: #1a1a1a;
    --text: #FFFFFF;
    --muted: #EAEAEA;
    --accent: #FFFFFF;
    --accentText: #000000;
  }
  html, body { height:100%; }
  body{
    margin:0; background:#111; color:#fff; font-family:Inter,system-ui,Arial;
    display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  }
  .wrap{
    max-width:750px; width:100%; margin:24px 12px; background:var(--bg);
    color:var(--text); border-radius:14px; padding:16px;
  }
  h2{ margin:0 0 12px; }
  .card{
    background:var(--card); color:var(--text); border:1px solid var(--border);
    border-radius:12px; padding:12px; margin-bottom:12px;
  }
  .muted{ color:var(--muted); }
  .table{
    width:100%; border-collapse:collapse; font-size:14px;
  }
  .table th, .table td{
    padding:10px 8px; border-bottom:1px solid #1f1f1f; text-align:left;
    white-space:nowrap;
  }
  .table th{
    font-size:12px; letter-spacing:.3px; color:#cfcfcf; text-transform:uppercase;
  }
  .table tr:last-child td{ border-bottom:none; }
  .pos{ width:64px; }
  .user{ max-width:260px; overflow:hidden; text-overflow:ellipsis; }
  .acc, .pts{ width:90px; text-align:right; }
  .highlight{
    background:var(--accent); color:var(--accentText) !important;
  }
  .highlight td{ color:var(--accentText) !important; }
  .section-title{
    font-weight:700; margin:8px 0 8px; display:flex; align-items:center; gap:8px;
  }
  .scroll{
    max-height:420px; overflow:auto; border-radius:12px;
  }
  .pill{
    display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
    background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);
  }
</style>
</head>
<body>
  <div class="wrap">
    <h2>League Table</h2>

    <!-- Top 5 -->
    <div class="card">
      <div class="section-title">Top 5 <span id="totalCount" class="pill"></span></div>
      <table class="table" id="top5">
        <thead>
          <tr>
            <th class="pos">Pos</th>
            <th>Username</th>
            <th class="acc">% Accuracy</th>
            <th class="pts">Points</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Your position (if not in top 5) -->
    <div class="card" id="yoursection" style="display:none">
      <div class="section-title">Your Position</div>
      <table class="table" id="yourrowtbl">
        <thead>
          <tr>
            <th class="pos">Pos</th>
            <th>Username</th>
            <th class="acc">% Accuracy</th>
            <th class="pts">Points</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Full table (scrollable) -->
    <div class="card">
      <div class="section-title">All Players</div>
      <div class="scroll">
        <table class="table" id="fulltbl">
          <thead>
            <tr>
              <th class="pos">Pos</th>
              <th>Username</th>
              <th class="acc">% Accuracy</th>
              <th class="pts">Points</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">Sorted by points, then accuracy.</div>
    </div>
  </div>

<script>
const base = '/.netlify/functions';
const qs = new URLSearchParams(location.search);
const highlightUserId = qs.get('userId') || ''; // highlight this user if present

function pct(acc){ return (Math.round(acc*1000)/10).toFixed(1); } // 1 decimal
function tr(row, highlight=false){
  const tr = document.createElement('tr');
  if (highlight) tr.classList.add('highlight');
  tr.innerHTML = `
    <td class="pos">${row.position}</td>
    <td class="user">${escapeHTML(row.name)}</td>
    <td class="acc">${pct(row.accuracy)}%</td>
    <td class="pts">${row.points}</td>
  `;
  return tr;
}
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function load() {
  const res = await fetch(`${base}/leaderboard`, { cache: 'no-store' });
  if (!res.ok) {
    console.error(await res.text());
    alert('Failed to load leaderboard');
    return;
  }
  const data = await res.json();
  const rows = data.leaderboard || [];

  // Top 5
  const top5Body = document.querySelector('#top5 tbody');
  top5Body.innerHTML = '';
  rows.slice(0,5).forEach(r => top5Body.appendChild(tr(r, String(r.id)===String(highlightUserId))));
  document.getElementById('totalCount').textContent = `${rows.length} players`;

  // Your row (if not already in top 5)
  const yourSection = document.getElementById('yoursection');
  if (highlightUserId) {
    const me = rows.find(r => String(r.id) === String(highlightUserId));
    if (me && me.position > 5) {
      yourSection.style.display = '';
      const body = document.querySelector('#yourrowtbl tbody');
      body.innerHTML = '';
      body.appendChild(tr(me, true));
    }
  }

  // Full table (scrollable)
  const fullBody = document.querySelector('#fulltbl tbody');
  fullBody.innerHTML = '';
  rows.forEach(r => fullBody.appendChild(tr(r, String(r.id)===String(highlightUserId))));
}

load();
</script>
</body>
</html>
