<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Who Am I?</title>
<style>
:root {
  --bg: #0a0f0d;
  --card: #1a3a2a;
  --card-dark: #0f2a1f;
  --ink: #fff;
  --muted: #a8c4b8;
  --btn: #2d5a45;
  --btn-hover: #3d7a5a;
  --danger: #e05555;
  --accent: #4ade80;
  --accent-dim: #22c55e;
  --gold: #fbbf24;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100vh;
  padding: 12px;
  line-height: 1.4;
}

.container { max-width: 480px; margin: 0 auto; }

.back-link {
  display: inline-block;
  color: var(--muted);
  text-decoration: none;
  font-size: 13px;
  margin-bottom: 8px;
}
.back-link:hover { color: var(--accent); }

.header {
  text-align: center;
  padding: 16px 0 8px;
}
.header h1 {
  font-size: 26px;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.header h1 span { color: var(--accent); }
.header .subtitle {
  color: var(--muted);
  font-size: 13px;
  margin-top: 4px;
}

.card {
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.card h2 { font-size: 17px; font-weight: 700; margin-bottom: 12px; }

.option-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 16px;
}
.option-btn {
  background: var(--card-dark);
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 12px 10px;
  color: var(--ink);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.option-btn:hover { border-color: var(--accent-dim); background: var(--btn); }
.option-btn.selected { border-color: var(--accent); background: var(--btn); }
.option-btn .color-dot {
  display: inline-block;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  vertical-align: middle;
  margin-bottom: 4px;
  border: 1px solid rgba(255,255,255,0.2);
}
.option-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }
.option-btn.wide { grid-column: 1 / -1; }

.go-btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.5px;
}
.go-btn.primary { background: var(--accent); color: #000; }
.go-btn.primary:hover { background: var(--accent-dim); }
.go-btn:disabled { background: var(--btn); color: var(--muted); cursor: not-allowed; }
.go-btn.secondary { background: var(--btn); color: var(--ink); margin-top: 10px; }
.go-btn.secondary:hover { background: var(--btn-hover); }

/* ====== GAME AREA ====== */
.blanks {
  text-align: center;
  padding: 24px 0;
  font-size: 28px;
  font-weight: 800;
  letter-spacing: 4px;
  font-family: 'Courier New', monospace;
  word-spacing: 12px;
  color: var(--accent);
  line-height: 1.6;
}

.clue-list {
  list-style: none;
}
.clue-item {
  padding: 14px 16px;
  background: var(--card-dark);
  border-radius: 12px;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--ink);
  border-left: 3px solid var(--accent);
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.4s ease;
}
.clue-item.revealed {
  opacity: 1;
  transform: translateY(0);
}
.clue-item.locked {
  opacity: 0.3;
  border-left-color: var(--btn);
  color: var(--muted);
}
.clue-item .clue-number {
  display: inline-block;
  background: var(--accent);
  color: #000;
  font-size: 10px;
  font-weight: 800;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  border-radius: 50%;
  margin-right: 10px;
}
.clue-item.locked .clue-number { background: var(--btn); color: var(--muted); }

.guess-area {
  margin-top: 16px;
}
.guess-input {
  width: 100%;
  padding: 14px 16px;
  background: var(--card-dark);
  border: 2px solid transparent;
  border-radius: 12px;
  color: var(--ink);
  font-size: 15px;
  outline: none;
  margin-bottom: 8px;
}
.guess-input:focus { border-color: var(--accent); }
.guess-input::placeholder { color: var(--muted); }

.guess-feedback {
  text-align: center;
  padding: 8px;
  font-size: 14px;
  font-weight: 600;
  min-height: 36px;
}
.guess-feedback.wrong { color: var(--danger); }
.guess-feedback.correct { color: var(--accent); }

.reveal-card {
  text-align: center;
  padding: 24px;
}
.reveal-card .player-name {
  font-size: 28px;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: 8px;
}
.reveal-card .player-meta {
  font-size: 14px;
  color: var(--muted);
}
.reveal-card .result-badge {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  margin-top: 12px;
}
.reveal-card .result-badge.win { background: var(--accent); color: #000; }
.reveal-card .result-badge.lose { background: var(--danger); color: #fff; }

.clue-counter {
  text-align: center;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 8px;
}

.scope-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--card-dark);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 12px;
}
.scope-badge .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--muted);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.hidden { display: none !important; }

.btn-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.btn-row .go-btn { flex: 1; }
</style>
</head>
<body>

<div class="container">
  <a href="games.html" class="back-link">&larr; All Games</a>

  <div class="header">
    <h1>Who Am <span>I?</span></h1>
    <div class="subtitle">Guess the mystery player from clues</div>
  </div>

  <!-- STEP 1: SETUP -->
  <div id="step1">
    <div class="card">
      <h2>Choose Scope</h2>
      <div class="option-grid" id="scopeGrid"></div>
    </div>
    <button class="go-btn primary" id="startBtn" disabled>Start Game</button>
  </div>

  <!-- STEP 2: GAME -->
  <div id="step2" class="hidden">
    <div class="scope-badge" id="gameBadge"></div>

    <div class="card">
      <div class="blanks" id="blanksDisplay"></div>
    </div>

    <div class="card">
      <div class="clue-counter" id="clueCounter">Clue 1 of 5</div>
      <ul class="clue-list" id="clueList"></ul>

      <button class="go-btn secondary" id="nextClueBtn">Reveal Next Clue</button>
    </div>

    <div class="card">
      <div class="guess-area">
        <input type="text" class="guess-input" id="guessInput" placeholder="Type your guess..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        <div class="guess-feedback" id="guessFeedback"></div>
        <button class="go-btn primary" id="guessBtn" disabled>Guess</button>
      </div>
    </div>

    <!-- Reveal card (shown on win or give up) -->
    <div id="revealCard" class="card hidden">
      <div class="reveal-card">
        <div class="player-name" id="revealName"></div>
        <div class="player-meta" id="revealMeta"></div>
        <div class="result-badge" id="resultBadge"></div>
      </div>
    </div>

    <div class="btn-row" id="actionBtns" class="hidden">
      <button class="go-btn secondary" id="giveUpBtn">Give Up</button>
      <button class="go-btn primary hidden" id="playAgainBtn">Play Again</button>
    </div>
  </div>
</div>

<footer style="text-align:center;padding:16px 16px 72px;font-size:11px;color:var(--muted);opacity:0.6;">
  Build: 2026-02-11 | Who Am I? v1.0
</footer>

<script>
const API_BASE = '/.netlify/functions';
const $ = id => document.getElementById(id);

const CLUB_COLOURS = {
  'club_sunderland': '#EB172B',
  'club_manutd': '#DA291C',
  'club_arsenal': '#EF0107',
  'club_liverpool': '#C8102E',
  'club_chelsea': '#034694',
};

const SCOPES = [
  { id: 'epl_alltime', label: 'Premier League (All-time)', type: 'league' },
  { id: 'club_sunderland', label: 'Sunderland', type: 'club' },
  { id: 'club_manutd', label: 'Manchester United', type: 'club' },
  { id: 'club_arsenal', label: 'Arsenal', type: 'club' },
  { id: 'club_liverpool', label: 'Liverpool', type: 'club' },
  { id: 'club_chelsea', label: 'Chelsea', type: 'club' },
];

let selectedScope = null;
let gameData = null;
let cluesRevealed = 0;
let gameOver = false;
let guessCount = 0;

function init() {
  const grid = $('scopeGrid');
  for (const scope of SCOPES) {
    const btn = document.createElement('button');
    btn.className = 'option-btn' + (scope.type === 'league' ? ' wide' : '');
    const colour = CLUB_COLOURS[scope.id];
    if (scope.type === 'league') {
      btn.innerHTML = `<span class="emoji">&#127942;</span>${scope.label}`;
    } else {
      btn.innerHTML = `<span class="color-dot" style="background:${colour || '#555'}"></span>${scope.label}`;
    }
    btn.onclick = () => {
      selectedScope = scope.id;
      grid.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      $('startBtn').disabled = false;
    };
    grid.appendChild(btn);
  }

  $('startBtn').onclick = startGame;
  $('nextClueBtn').onclick = revealNextClue;
  $('guessBtn').onclick = submitGuess;
  $('giveUpBtn').onclick = giveUp;
  $('playAgainBtn').onclick = resetToSetup;

  $('guessInput').addEventListener('input', () => {
    $('guessBtn').disabled = $('guessInput').value.trim().length < 2;
  });
  $('guessInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !$('guessBtn').disabled) submitGuess();
  });
}

async function startGame() {
  $('startBtn').disabled = true;
  $('startBtn').innerHTML = '<span class="spinner"></span> Loading...';

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'start_game', scopeId: selectedScope }),
    });
    gameData = await res.json();

    if (gameData.error) throw new Error(gameData.error);

    cluesRevealed = 0;
    gameOver = false;
    guessCount = 0;

    // Setup UI
    const scopeLabel = SCOPES.find(s => s.id === selectedScope)?.label || '';
    $('gameBadge').innerHTML = `<span class="dot"></span> ${scopeLabel}`;

    // Display blanks
    $('blanksDisplay').textContent = gameData.blanks;

    // Setup clue items (all locked initially)
    const clueList = $('clueList');
    clueList.innerHTML = '';
    for (let i = 0; i < gameData.clues.length; i++) {
      const li = document.createElement('li');
      li.className = 'clue-item locked';
      li.id = `clue${i}`;
      li.innerHTML = `<span class="clue-number">${i + 1}</span> ?`;
      clueList.appendChild(li);
    }

    // Reveal first clue
    revealNextClue();

    // Show game
    $('step1').classList.add('hidden');
    $('step2').classList.remove('hidden');
    $('revealCard').classList.add('hidden');
    $('playAgainBtn').classList.add('hidden');
    $('giveUpBtn').classList.remove('hidden');
    $('guessInput').value = '';
    $('guessFeedback').textContent = '';
    $('guessFeedback').className = 'guess-feedback';
    $('guessBtn').disabled = true;
    $('guessInput').disabled = false;
    $('nextClueBtn').classList.remove('hidden');

    setTimeout(() => $('guessInput').focus(), 200);

  } catch (err) {
    alert('Failed to start game: ' + err.message);
  }

  $('startBtn').disabled = false;
  $('startBtn').textContent = 'Start Game';
}

function revealNextClue() {
  if (cluesRevealed >= gameData.clues.length || gameOver) return;

  const clueEl = $(`clue${cluesRevealed}`);
  const clueText = gameData.clues[cluesRevealed];
  clueEl.innerHTML = `<span class="clue-number">${cluesRevealed + 1}</span> ${clueText}`;
  clueEl.classList.remove('locked');
  clueEl.classList.add('revealed');

  cluesRevealed++;
  $('clueCounter').textContent = `Clue ${cluesRevealed} of ${gameData.clues.length}`;

  if (cluesRevealed >= gameData.clues.length) {
    $('nextClueBtn').classList.add('hidden');
  }
}

async function submitGuess() {
  const guess = $('guessInput').value.trim();
  if (guess.length < 2 || gameOver) return;

  guessCount++;
  $('guessBtn').disabled = true;
  $('guessBtn').innerHTML = '<span class="spinner"></span>';

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'check_answer',
        scopeId: selectedScope,
        playerId: gameData.playerId,
        guess,
      }),
    });
    const result = await res.json();

    if (result.correct) {
      gameOver = true;
      showResult(true, result.player);
    } else {
      $('guessFeedback').textContent = `Wrong! Try again...`;
      $('guessFeedback').className = 'guess-feedback wrong';
      $('guessInput').value = '';
      $('guessInput').focus();
    }
  } catch (err) {
    $('guessFeedback').textContent = 'Error checking answer. Try again.';
    $('guessFeedback').className = 'guess-feedback wrong';
  }

  $('guessBtn').disabled = false;
  $('guessBtn').textContent = 'Guess';
}

async function giveUp() {
  gameOver = true;

  // Fetch the answer
  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'check_answer',
        scopeId: selectedScope,
        playerId: gameData.playerId,
        guess: '__GIVE_UP__',
        giveUp: true,
      }),
    });
    const result = await res.json();
    showResult(false, result.player);
  } catch (err) {
    $('guessFeedback').textContent = 'Failed to reveal answer.';
  }
}

function showResult(won, player) {
  // Reveal all remaining clues
  for (let i = cluesRevealed; i < gameData.clues.length; i++) {
    const clueEl = $(`clue${i}`);
    const clueText = gameData.clues[i];
    clueEl.innerHTML = `<span class="clue-number">${i + 1}</span> ${clueText}`;
    clueEl.classList.remove('locked');
    clueEl.classList.add('revealed');
  }
  $('nextClueBtn').classList.add('hidden');

  // Show reveal card
  $('revealName').textContent = player.name;
  const apps = player.stats ? player.stats.appearances : (player.appearances || 0);
  const goals = player.stats ? player.stats.goals : (player.goals || 0);
  const natLabel = player.nationalityLabel || player.nationality || '';
  $('revealMeta').textContent = `${natLabel} | ${apps} apps | ${goals} goals`;

  const badge = $('resultBadge');
  if (won) {
    const clueWord = cluesRevealed === 1 ? 'clue' : 'clues';
    badge.textContent = `Guessed in ${guessCount} ${guessCount === 1 ? 'try' : 'tries'} with ${cluesRevealed} ${clueWord}!`;
    badge.className = 'result-badge win';
  } else {
    badge.textContent = 'Better luck next time!';
    badge.className = 'result-badge lose';
  }

  $('revealCard').classList.remove('hidden');
  $('giveUpBtn').classList.add('hidden');
  $('playAgainBtn').classList.remove('hidden');
  $('guessInput').disabled = true;
  $('guessBtn').disabled = true;
}

function resetToSetup() {
  $('step2').classList.add('hidden');
  $('step1').classList.remove('hidden');
  gameData = null;
  cluesRevealed = 0;
  gameOver = false;
  guessCount = 0;
}

init();
</script>
</body>
</html>
