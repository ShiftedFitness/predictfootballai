<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Football 501</title>
<style>
:root {
  --bg: #0a0f0d;
  --card: #1a3a2a;
  --card-dark: #0f2a1f;
  --ink: #fff;
  --muted: #a8c4b8;
  --btn: #2d5a45;
  --btn-hover: #3d7a5a;
  --danger: #e05555;
  --accent: #4ade80;
  --accent-dim: #22c55e;
  --gold: #fbbf24;
  --used: #666;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100vh;
  padding: 16px;
  line-height: 1.4;
}
.card {
  max-width: 560px;
  margin: 0 auto;
  background: var(--card);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
h2 { margin: 0 0 16px; font-size: 20px; font-weight: 700; }
.subtitle { color: var(--muted); font-size: 14px; margin: -12px 0 16px; }

/* Form elements */
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 13px; color: var(--muted); font-weight: 600; margin-bottom: 6px; }
input, select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid transparent;
  border-radius: 12px;
  font-size: 16px;
  background: rgba(255,255,255,.95);
  color: #1a1a1a;
  transition: border-color .2s;
}
input:focus, select:focus { outline: none; border-color: var(--accent); }
input::placeholder { color: #888; }

/* Buttons */
button {
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
  min-height: 48px;
}
.btn-primary { background: var(--accent); color: #0a0f0d; }
.btn-primary:hover:not(:disabled) { background: var(--accent-dim); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }
.btn-secondary { background: var(--btn); color: #fff; }
.btn-secondary:hover:not(:disabled) { background: var(--btn-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-text { background: none; color: var(--muted); text-decoration: underline; font-size: 14px; padding: 8px; width: auto; min-height: auto; }
.btn-back { background: var(--card-dark); color: var(--muted); margin-bottom: 12px; font-size: 14px; padding: 10px 16px; }
.btn-back:hover { background: var(--btn); color: #fff; }
.row-btns { display: flex; gap: 10px; margin-top: 12px; }
.row-btns button { flex: 1; }

/* Category sections */
.section { background: var(--card-dark); border-radius: 14px; margin-bottom: 10px; overflow: hidden; }
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  cursor: pointer;
  transition: background .2s;
}
.section-header:hover { background: rgba(255,255,255,.03); }
.section-title { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
.section-count { font-size: 12px; color: var(--muted); font-weight: 400; }
.chev { opacity: .7; transition: transform .2s; font-size: 12px; }
.section.open .chev { transform: rotate(180deg); }
.section-body { display: none; padding: 8px 12px 12px; }
.section.open .section-body { display: block; }
.section.disabled .section-header { opacity: .5; cursor: not-allowed; }
.section.disabled .section-body { display: none; }
.section-desc { display: none; font-size: 12px; color: var(--muted); padding: 0 16px 8px; line-height: 1.4; }
.section.open .section-desc { display: block; }
.disabled-note { font-size: 12px; color: var(--muted); padding: 12px; text-align: center; }

/* Game cards */
.game-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,.04);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: background .2s, transform .1s;
}
.game-card:hover { background: rgba(255,255,255,.08); }
.game-card:active { transform: scale(.98); }
.game-card .flag { font-size: 18px; margin-right: 10px; }
.game-card .title { font-weight: 600; font-size: 13px; }
.game-card .meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
.game-card .arrow { opacity: .5; font-size: 14px; }
.stars { color: var(--gold); letter-spacing: 1px; font-size: 10px; }

/* Loading screen with trivia */
.loading-screen { text-align: center; padding: 20px 0; }
.loading-spinner {
  width: 48px; height: 48px;
  border: 4px solid rgba(255,255,255,.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 16px; margin-bottom: 20px; }
.ready-badge {
  display: inline-block;
  background: var(--accent);
  color: #0a0f0d;
  font-weight: 700;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  margin-bottom: 16px;
  animation: pulse 1.5s ease infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }

/* Trivia */
.trivia-box { background: var(--card-dark); border-radius: 14px; padding: 16px; margin-top: 16px; text-align: left; }
.trivia-q { font-weight: 600; margin-bottom: 12px; font-size: 15px; }
.trivia-opts { display: flex; flex-direction: column; gap: 8px; }
.trivia-opt {
  background: rgba(255,255,255,.06);
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 12px 14px;
  cursor: pointer;
  transition: all .2s;
  font-size: 14px;
}
.trivia-opt:hover { background: rgba(255,255,255,.1); }
.trivia-opt.selected { border-color: var(--accent); background: rgba(74,222,128,.1); }
.trivia-opt.correct { background: rgba(74,222,128,.3); border-color: var(--accent); }
.trivia-opt.wrong { background: rgba(224,85,85,.2); border-color: var(--danger); }

/* Order reveal */
.order-reveal { text-align: center; padding: 20px 0; }
.order-list {
  background: var(--card-dark);
  border-radius: 12px;
  padding: 14px;
  margin: 16px 0;
  font-size: 15px;
}

/* Scoreboard */
.scores { display: grid; gap: 8px; margin-bottom: 14px; }
.scores.p1 { grid-template-columns: 1fr; }
.scores.p2 { grid-template-columns: 1fr 1fr; }
.scores.p3 { grid-template-columns: 1fr 1fr 1fr; }
.scores.p4 { grid-template-columns: 1fr 1fr; }
.scores.p5, .scores.p6 { grid-template-columns: 1fr 1fr 1fr; }
.pill {
  background: var(--card-dark);
  border-radius: 14px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  border: 2px solid transparent;
}
.pill.active { border-color: var(--accent); background: rgba(74,222,128,.1); }
.pill .name { font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pill .score { font-size: 26px; font-weight: 800; }
.pill.bust-anim { animation: shake .4s ease; }
.pill.win-anim { animation: celebrate .6s ease; }
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-4px); }
  40%, 80% { transform: translateX(4px); }
}
@keyframes celebrate {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
.turn-info { text-align: center; font-weight: 700; margin-bottom: 10px; font-size: 14px; }
.hint-bar { text-align: center; font-size: 12px; color: var(--accent); margin-bottom: 10px; padding: 8px; background: rgba(74,222,128,.08); border-radius: 10px; }

/* Selection list (fuzzy matches) */
.selection-list {
  background: var(--card-dark);
  border-radius: 12px;
  margin-top: 10px;
  overflow: hidden;
  max-height: 280px;
  overflow-y: auto;
}
.selection-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  cursor: pointer;
  transition: background .15s;
  border-bottom: 1px solid rgba(255,255,255,.05);
}
.selection-item:last-child { border-bottom: none; }
.selection-item:hover:not(.used) { background: rgba(255,255,255,.06); }
.selection-item .info { flex: 1; }
.selection-item .name { font-weight: 600; font-size: 14px; }
.selection-item .nat { font-size: 11px; color: var(--muted); }
.selection-item.used { opacity: .5; cursor: not-allowed; }
.selection-item.used .name { color: var(--used); text-decoration: line-through; }
.used-badge {
  font-size: 9px;
  background: var(--danger);
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 700;
  text-transform: uppercase;
}

/* Result toast */
.result { min-height: 18px; text-align: center; margin: 8px 0; font-size: 13px; }
.inline-toast {
  background: var(--card-dark);
  border-radius: 14px;
  padding: 14px;
  margin-top: 10px;
  opacity: 0;
  transform: translateY(8px);
  transition: all .25s;
}
.inline-toast.show { opacity: 1; transform: translateY(0); }
.inline-toast.bust-effect { border: 2px solid var(--danger); }
.inline-toast.win-effect { border: 2px solid var(--gold); background: rgba(251,191,36,.1); }
.toast-row { display: flex; align-items: flex-start; gap: 12px; }
.toast-badge {
  min-width: 52px; height: 52px;
  background: var(--accent);
  color: #0a0f0d;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  flex-shrink: 0;
}
.toast-badge.bust { background: var(--danger); color: #fff; font-size: 24px; }
.toast-badge.win { background: var(--gold); color: #000; font-size: 20px; }
.toast-body { flex: 1; min-width: 0; }
.toast-title { font-weight: 700; font-size: 15px; }
.toast-sub { color: var(--muted); font-size: 12px; margin-top: 2px; }
.toast-clubs { font-size: 11px; color: var(--muted); margin-top: 4px; }
.toast-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
.toast-meta span {
  background: rgba(255,255,255,.06);
  padding: 4px 7px;
  border-radius: 5px;
  font-size: 10px;
  color: var(--muted);
}

/* Bust/Win overlays */
.effect-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  pointer-events: none;
}
.effect-overlay.show { display: flex; }
.effect-text {
  font-size: 48px;
  font-weight: 900;
  text-transform: uppercase;
  animation: effectPop .5s ease-out forwards;
  opacity: 0;
}
.effect-text.bust { color: var(--danger); text-shadow: 0 4px 20px rgba(224,85,85,.5); }
.effect-text.win { color: var(--gold); text-shadow: 0 4px 20px rgba(251,191,36,.5); }
@keyframes effectPop {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 0; }
}

/* Progress modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 16px;
}
.modal-backdrop.show { display: flex; }
.modal {
  width: 100%;
  max-width: 480px;
  max-height: 80vh;
  overflow-y: auto;
  background: var(--card);
  border-radius: 18px;
  padding: 20px;
  transform: translateY(10px);
  opacity: 0;
  transition: all .25s;
}
.modal.show { transform: translateY(0); opacity: 1; }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.modal-title { font-weight: 800; font-size: 17px; }
.close-btn { background: var(--btn); border: none; color: #fff; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; }
.chain { background: var(--card-dark); padding: 12px; border-radius: 10px; font-family: monospace; font-size: 13px; overflow-x: auto; word-break: break-all; }
.pick-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
.pick {
  background: var(--card-dark);
  padding: 10px;
  border-radius: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}
.pick.bust { border-left: 3px solid var(--danger); }
.pick b { font-weight: 700; }
.pick .meta { color: var(--muted); font-size: 11px; }

/* Confirm dialog */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1100;
  padding: 16px;
}
.confirm-overlay.show { display: flex; }
.confirm-box {
  background: var(--card);
  border-radius: 16px;
  padding: 24px;
  max-width: 340px;
  text-align: center;
}
.confirm-box p { margin: 0 0 20px; font-size: 16px; }
.confirm-btns { display: flex; gap: 10px; }
.confirm-btns button { flex: 1; }

.hidden { display: none !important; }
</style>
</head>
<body>

<!-- SETUP CARD -->
<div class="card" id="setupCard">
  <!-- Step 1: Game Mode Selection -->
  <div id="step1">
    <h2>Football 501</h2>
    <p class="subtitle">Guess players, subtract their stats, hit exactly 0 to win!</p>
    <div class="field">
      <label>Choose game mode</label>
    </div>
    <div class="row-btns" style="margin-top: 8px;">
      <button class="btn-primary" id="singlePlayerBtn">Single Player</button>
      <button class="btn-secondary" id="multiplayerBtn">Multiplayer</button>
    </div>
  </div>

  <!-- Step 1b: Multiplayer count -->
  <div id="step1b" class="hidden">
    <button class="btn-back" id="backToStep1Mode">‚Üê Back</button>
    <h2>Multiplayer</h2>
    <p class="subtitle">Select number of players</p>
    <div class="field">
      <label>Number of players</label>
      <select id="numPlayers">
        <option value="2" selected>2 Players</option>
        <option value="3">3 Players</option>
        <option value="4">4 Players</option>
        <option value="5">5 Players</option>
        <option value="6">6 Players</option>
      </select>
    </div>
    <button class="btn-primary" id="toStep2">Continue</button>
  </div>

  <!-- Step 2: Player names -->
  <div id="step2" class="hidden">
    <button class="btn-back" id="backToStep1">‚Üê Back</button>
    <h2>Player Names</h2>
    <div id="nameFields"></div>
    <button class="btn-primary" id="toStep3">Continue</button>
  </div>

  <!-- Step 3: Choose category -->
  <div id="step3" class="hidden">
    <button class="btn-back" id="backToStep2">‚Üê Back</button>
    <h2>Choose Category</h2>
    <p class="subtitle">Select a game mode to start</p>

    <div class="section" id="sec-country">
      <div class="section-header" onclick="toggleSection('sec-country')">
        <div class="section-title">Countries <span class="section-count" id="countCountry">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Player appearances by country in Premier League history (up to 2024/25 season).</div>
      <div class="section-body" id="countryGames"></div>
    </div>

    <div class="section" id="sec-club">
      <div class="section-header" onclick="toggleSection('sec-club')">
        <div class="section-title">Clubs (Apps) <span class="section-count" id="countClub">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Player appearances for each club in Premier League history (up to 2024/25 season).</div>
      <div class="section-body" id="clubGames"></div>
    </div>

    <div class="section" id="sec-goals">
      <div class="section-header" onclick="toggleSection('sec-goals')">
        <div class="section-title">Goals <span class="section-count" id="countGoals">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Total Premier League goals (overall and by club) (up to 2024/25 season).</div>
      <div class="section-body" id="goalsGames"></div>
    </div>

    <div class="section disabled" id="sec-positions">
      <div class="section-header">
        <div class="section-title">Positions <span class="section-count">(Coming Soon)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Coming soon ‚Äî requires position data.</div>
      <div class="section-body">
        <div class="disabled-note">Position data not yet available. Check back soon!</div>
      </div>
    </div>
  </div>

  <!-- Loading screen with trivia -->
  <div id="loadingScreen" class="hidden loading-screen">
    <button class="btn-back" id="backFromLoading">‚Üê Back</button>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading match data...</div>
    <div id="readyBadge" class="ready-badge hidden">Game Ready!</div>
    <div id="triviaContainer"></div>
    <button id="skipTrivia" class="btn-secondary hidden" style="margin-top:16px">Start Match</button>
  </div>

  <!-- Order reveal -->
  <div id="orderScreen" class="hidden order-reveal">
    <h2>Turn Order</h2>
    <div id="orderList" class="order-list"></div>
    <button id="beginMatch" class="btn-primary">Start Match</button>
  </div>
</div>

<!-- GAMEPLAY CARD -->
<div class="card hidden" id="playCard">
  <div id="scoreGrid" class="scores p2"></div>
  <div id="turnInfo" class="turn-info"></div>
  <div id="hintBar" class="hint-bar hidden"></div>

  <div class="field">
    <label id="guessLabel">Your guess</label>
    <input id="guess" type="text" placeholder="Type a player name..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
  </div>

  <div id="selectionList" class="selection-list hidden"></div>

  <div class="row-btns">
    <button id="submitBtn" class="btn-primary" disabled>Submit</button>
    <button id="endBtn" class="btn-text">End Game</button>
  </div>

  <div id="result" class="result"></div>
  <div id="inlineToast" class="inline-toast"></div>
</div>

<!-- Effect Overlay -->
<div id="effectOverlay" class="effect-overlay">
  <div id="effectText" class="effect-text"></div>
</div>

<!-- Progress Modal -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="modal" class="modal">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Progress</div>
      <button id="closeModal" class="close-btn">Close</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Score chain</div>
    <div id="chain" class="chain">501</div>
    <div id="pickList" class="pick-list"></div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-box">
    <p id="confirmText">End this game?</p>
    <div class="confirm-btns">
      <button id="confirmNo" class="btn-secondary">Cancel</button>
      <button id="confirmYes" class="btn-danger">End Game</button>
    </div>
  </div>
</div>

<script>
// ============== CONFIGURATION ==============
const API_BASE = '/.netlify/functions';
const CACHE_TTL = 90 * 60 * 1000; // 90 minutes
const DEBOUNCE_MS = 300;

// ============== CATEGORIES (must match backend) ==============
const CATEGORIES = {
  country: [
    { id: 'country_FRA', title: 'France', flag: 'üá´üá∑' },
    { id: 'country_ESP', title: 'Spain', flag: 'üá™üá∏' },
    { id: 'country_ARG', title: 'Argentina', flag: 'üá¶üá∑' },
    { id: 'country_NED', title: 'Netherlands', flag: 'üá≥üá±' },
    { id: 'country_POR', title: 'Portugal', flag: 'üáµüáπ' },
    { id: 'country_IRL', title: 'Ireland', flag: 'üáÆüá™' },
    { id: 'country_SCO', title: 'Scotland', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø' },
    { id: 'country_WAL', title: 'Wales', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø' },
    { id: 'country_NIR', title: 'N. Ireland', flag: 'üá¨üáß' },
    { id: 'country_NOR', title: 'Norway', flag: 'üá≥üá¥' },
    { id: 'country_DEN', title: 'Denmark', flag: 'üá©üá∞' },
    { id: 'country_BEL', title: 'Belgium', flag: 'üáßüá™' },
    { id: 'country_GER', title: 'Germany', flag: 'üá©üá™' },
  ],
  club: [
    { id: 'club_Arsenal', title: 'Arsenal', flag: '‚öΩ' },
    { id: 'club_ManUtd', title: 'Man Utd', flag: '‚öΩ' },
    { id: 'club_Liverpool', title: 'Liverpool', flag: '‚öΩ' },
    { id: 'club_Chelsea', title: 'Chelsea', flag: '‚öΩ' },
    { id: 'club_ManCity', title: 'Man City', flag: '‚öΩ' },
    { id: 'club_Tottenham', title: 'Spurs', flag: '‚öΩ' },
    { id: 'club_Everton', title: 'Everton', flag: '‚öΩ' },
    { id: 'club_Newcastle', title: 'Newcastle', flag: '‚öΩ' },
    { id: 'club_AstonVilla', title: 'Aston Villa', flag: '‚öΩ' },
    { id: 'club_WestHam', title: 'West Ham', flag: '‚öΩ' },
    { id: 'club_Southampton', title: 'Southampton', flag: '‚öΩ' },
    { id: 'club_Leicester', title: 'Leicester', flag: '‚öΩ' },
    { id: 'club_Fulham', title: 'Fulham', flag: '‚öΩ' },
    { id: 'club_Blackburn', title: 'Blackburn', flag: '‚öΩ' },
    { id: 'club_CrystalPalace', title: 'Crystal Palace', flag: '‚öΩ' },
    { id: 'club_Sunderland', title: 'Sunderland', flag: '‚öΩ' },
    { id: 'club_Middlesbrough', title: 'Middlesbrough', flag: '‚öΩ' },
    { id: 'club_Leeds', title: 'Leeds', flag: '‚öΩ' },
  ],
  goals: [
    { id: 'goals_overall', title: 'All EPL Goals', flag: '‚öΩ' },
    { id: 'goals_Arsenal', title: 'Arsenal Goals', flag: '‚öΩ' },
    { id: 'goals_Chelsea', title: 'Chelsea Goals', flag: '‚öΩ' },
    { id: 'goals_ManUtd', title: 'Man Utd Goals', flag: '‚öΩ' },
    { id: 'goals_Liverpool', title: 'Liverpool Goals', flag: '‚öΩ' },
    { id: 'goals_Tottenham', title: 'Spurs Goals', flag: '‚öΩ' },
    { id: 'goals_ManCity', title: 'Man City Goals', flag: '‚öΩ' },
  ],
};

// ============== STATE ==============
let state = null;
let eligiblePlayers = [];
let currentCategory = null;
let currentMeta = null;
let triviaData = [];
let triviaIndex = 0;
let matchDataReady = false;
let debounceTimer = null;

// ============== UTILITIES ==============
function $(id) { return document.getElementById(id); }
function show(id) { $(id)?.classList.remove('hidden'); }
function hide(id) { $(id)?.classList.add('hidden'); }

function normalize(s) {
  return String(s || '').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s.-]/g, '').trim();
}

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  if (!m) return n;
  if (!n) return m;
  const d = Array.from({ length: m + 1 }, (_, i) => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) d[i][0] = i;
  for (let j = 0; j <= n; j++) d[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
    }
  }
  return d[m][n];
}

function similarity(a, b) {
  const na = normalize(a), nb = normalize(b);
  if (!na || !nb) return 0;
  return 1 - (levenshtein(na, nb) / Math.max(na.length, nb.length));
}

function formatNum(n) {
  return Number(n || 0).toLocaleString('en-GB');
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

// ============== CACHING ==============
function getCacheKey(categoryId) {
  return `f501_${categoryId}`;
}

function getCachedData(categoryId) {
  const key = getCacheKey(categoryId);
  const tsKey = `${key}_ts`;
  const cached = localStorage.getItem(key);
  const ts = parseInt(localStorage.getItem(tsKey) || '0', 10);
  if (cached && (Date.now() - ts) < CACHE_TTL) {
    try {
      return JSON.parse(cached);
    } catch { }
  }
  return null;
}

function setCachedData(categoryId, data) {
  const key = getCacheKey(categoryId);
  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem(`${key}_ts`, String(Date.now()));
}

// ============== SETUP FLOW ==============

// Single Player: skip directly to categories
$('singlePlayerBtn').onclick = () => {
  window.gameSetup = { names: ['You'], isSinglePlayer: true };
  buildCategorySections();
  hide('step1');
  show('step3');
};

// Multiplayer: go to player count selection
$('multiplayerBtn').onclick = () => {
  hide('step1');
  show('step1b');
};

$('backToStep1Mode').onclick = () => {
  hide('step1b');
  show('step1');
};

$('toStep2').onclick = () => {
  const n = parseInt($('numPlayers').value, 10);
  const wrap = $('nameFields');
  wrap.innerHTML = '';
  for (let i = 1; i <= n; i++) {
    const div = document.createElement('div');
    div.className = 'field';
    div.innerHTML = `<label>Player ${i}</label><input id="pname${i}" type="text" placeholder="Enter name" autocomplete="off"/>`;
    wrap.appendChild(div);
  }
  hide('step1b');
  show('step2');
  $('pname1')?.focus();
};

$('backToStep1').onclick = () => {
  hide('step2');
  show('step1b');
};

$('toStep3').onclick = () => {
  const n = parseInt($('numPlayers').value, 10);
  const names = [];
  for (let i = 1; i <= n; i++) {
    const val = $(`pname${i}`)?.value?.trim() || `Player ${i}`;
    names.push(val);
  }
  window.gameSetup = { names };
  buildCategorySections();
  hide('step2');
  show('step3');
};

$('backToStep2').onclick = () => {
  hide('step3');
  show('step2');
};

$('backFromLoading').onclick = () => {
  hide('loadingScreen');
  show('step3');
  matchDataReady = false;
};

function toggleSection(id) {
  const sec = $(id);
  if (sec.classList.contains('disabled')) return;
  sec.classList.toggle('open');
}

function buildCategorySections() {
  buildSection('countryGames', CATEGORIES.country, 'countCountry');
  buildSection('clubGames', CATEGORIES.club, 'countClub');
  buildSection('goalsGames', CATEGORIES.goals, 'countGoals');
}

function buildSection(containerId, list, countId) {
  const cont = $(containerId);
  cont.innerHTML = '';
  $(countId).textContent = `(${list.length})`;

  list.forEach(cat => {
    const card = document.createElement('div');
    card.className = 'game-card';
    card.innerHTML = `
      <div style="display:flex;align-items:center">
        <span class="flag">${cat.flag}</span>
        <div>
          <div class="title">${cat.title}</div>
          <div class="meta" id="meta-${cat.id}">Loading...</div>
        </div>
      </div>
      <div class="arrow">‚Üí</div>
    `;
    card.onclick = () => chooseCategory(cat);
    cont.appendChild(card);
    preloadCategoryStats(cat);
  });
}

async function preloadCategoryStats(cat) {
  const metaEl = $(`meta-${cat.id}`);
  if (!metaEl) return;

  const cached = getCachedData(cat.id);
  if (cached) {
    const count = cached.eligiblePlayers?.length || 0;
    const metric = cached.meta?.metricLabel || 'Apps';
    const diff = getDifficulty(count);
    metaEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5 - diff)}</span> ${formatNum(count)} players`;
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/match_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ categoryId: cat.id }),
    });
    const data = await res.json();
    if (data.eligiblePlayers) {
      setCachedData(cat.id, data);
      const count = data.eligiblePlayers.length;
      const diff = getDifficulty(count);
      metaEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5 - diff)}</span> ${formatNum(count)} players`;
    }
  } catch {
    metaEl.textContent = '‚Äî';
  }
}

function getDifficulty(count) {
  if (count >= 400) return 1;
  if (count >= 250) return 2;
  if (count >= 150) return 3;
  if (count >= 100) return 4;
  return 5;
}

// ============== CATEGORY SELECTION & LOADING ==============
async function chooseCategory(cat) {
  currentCategory = cat;
  matchDataReady = false;
  triviaIndex = 0;

  hide('step3');
  show('loadingScreen');
  hide('readyBadge');
  hide('skipTrivia');
  $('triviaContainer').innerHTML = '';

  const cached = getCachedData(cat.id);
  if (cached) {
    eligiblePlayers = cached.eligiblePlayers || [];
    currentMeta = cached.meta || {};
    triviaData = cached.meta?.trivia || [];
    matchDataReady = true;
    showReadyState();
    showTrivia();
    return;
  }

  const fetchPromise = (async () => {
    try {
      const res = await fetch(`${API_BASE}/match_start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categoryId: cat.id }),
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      setCachedData(cat.id, data);
      eligiblePlayers = data.eligiblePlayers || [];
      currentMeta = data.meta || {};
      triviaData = data.meta?.trivia || [];
      matchDataReady = true;
      showReadyState();
    } catch (err) {
      alert('Failed to load: ' + err.message);
      show('step3');
      hide('loadingScreen');
    }
  })();

  await sleep(500);
  showTrivia();
  await fetchPromise;
}

function showReadyState() {
  show('readyBadge');
  show('skipTrivia');
  $('skipTrivia').textContent = 'Start Match';
}

function showTrivia() {
  if (!triviaData.length) {
    if (matchDataReady) proceedToOrderReveal();
    return;
  }

  if (triviaIndex >= triviaData.length) {
    if (matchDataReady) proceedToOrderReveal();
    return;
  }

  const q = triviaData[triviaIndex];
  const container = $('triviaContainer');
  container.innerHTML = `
    <div class="trivia-box">
      <div class="trivia-q">${q.q}</div>
      <div class="trivia-opts">
        ${q.options.map((opt, i) => `<div class="trivia-opt" data-idx="${i}">${opt}</div>`).join('')}
      </div>
    </div>
  `;

  container.querySelectorAll('.trivia-opt').forEach(el => {
    el.onclick = () => handleTriviaAnswer(parseInt(el.dataset.idx, 10), q.answer);
  });
}

function handleTriviaAnswer(selected, correct) {
  const opts = $('triviaContainer').querySelectorAll('.trivia-opt');
  opts.forEach((el, i) => {
    el.onclick = null;
    if (i === correct) el.classList.add('correct');
    else if (i === selected) el.classList.add('wrong');
  });

  setTimeout(() => {
    triviaIndex++;
    showTrivia();
  }, 1200);
}

$('skipTrivia').onclick = () => {
  if (matchDataReady) proceedToOrderReveal();
};

// ============== ORDER REVEAL ==============
async function proceedToOrderReveal() {
  hide('loadingScreen');
  show('orderScreen');

  const names = [...(window.gameSetup?.names || ['Player 1', 'Player 2'])];

  const orderEl = $('orderList');
  for (let i = 0; i < 8; i++) {
    names.sort(() => Math.random() - 0.5);
    orderEl.innerHTML = names.map((n, i) => `<div>${i + 1}. ${n}</div>`).join('');
    await sleep(100);
  }
  names.sort(() => Math.random() - 0.5);
  orderEl.innerHTML = names.map((n, i) => `<div><strong>${i + 1}.</strong> ${n}</div>`).join('');

  window.gameSetup.orderedNames = names;
}

$('beginMatch').onclick = () => {
  const names = window.gameSetup?.orderedNames || window.gameSetup?.names || ['Player 1', 'Player 2'];
  startMatch(names);
};

// ============== MATCH START ==============
function startMatch(names) {
  const metricLabel = currentMeta?.metricLabel || 'Apps';
  $('guessLabel').textContent = `Your guess (‚àí${metricLabel})`;

  state = {
    players: names,
    scores: Array(names.length).fill(501),
    turn: 0,
    turnCount: 1,
    used: new Set(),
    retry: false,
    historyScores: names.map(() => [501]),
    picks: names.map(() => []),
  };

  hide('setupCard');
  show('playCard');

  const grid = $('scoreGrid');
  grid.className = `scores p${names.length}`;

  renderScoreboard();
  updateTurnUI();
  $('guess').focus();
}

// ============== SCOREBOARD ==============
function renderScoreboard() {
  const grid = $('scoreGrid');
  grid.innerHTML = '';
  state.players.forEach((name, idx) => {
    const pill = document.createElement('div');
    pill.className = 'pill' + (idx === state.turn ? ' active' : '');
    pill.id = `pill_${idx}`;
    pill.innerHTML = `<div class="name">${name}</div><div class="score" id="score_${idx}">${state.scores[idx]}</div>`;
    pill.onclick = () => openProgressModal(idx);
    grid.appendChild(pill);
  });
}

function updateTurnUI() {
  $('turnInfo').innerHTML = `<span style="color:var(--accent)">Turn ${state.turnCount}</span> &nbsp;‚Äî&nbsp; ${state.players[state.turn]}'s turn`;
  document.querySelectorAll('.pill').forEach((el, i) => {
    el.classList.toggle('active', i === state.turn);
  });
  updateHintBar();
}

function updateHintBar() {
  const hintBar = $('hintBar');
  const remaining = state.scores[state.turn];

  if (remaining <= 0 || eligiblePlayers.length === 0) {
    hintBar.classList.add('hidden');
    return;
  }

  const available = eligiblePlayers.filter(p => !state.used.has(p.normalized));
  const direct = available.filter(p => p.subtractValue === remaining).length;

  const freq = new Map();
  for (const p of available) {
    const v = p.subtractValue;
    if (v > 0 && v <= remaining) {
      freq.set(v, (freq.get(v) || 0) + 1);
    }
  }
  let pairs = 0;
  for (const [m, c] of freq.entries()) {
    const n = remaining - m;
    if (n < m) continue;
    if (!freq.has(n)) continue;
    pairs += (n === m) ? c * (c - 1) / 2 : c * freq.get(n);
  }

  hintBar.innerHTML = `Checkout: <strong>${direct || 'no'}</strong> direct ‚Ä¢ <strong>${pairs > 10 ? '>10' : pairs}</strong> two-player combos`;
  hintBar.classList.remove('hidden');
}

// ============== INPUT HANDLING ==============
const guessInput = $('guess');
const submitBtn = $('submitBtn');

guessInput.oninput = () => {
  const val = guessInput.value.trim();
  submitBtn.disabled = !val;
  hideSelectionList();
  hideToast();

  clearTimeout(debounceTimer);
  if (val.length >= 2) {
    debounceTimer = setTimeout(() => showFuzzyMatches(val), DEBOUNCE_MS);
  }
};

guessInput.onkeydown = (e) => {
  if (e.key === 'Enter' && !submitBtn.disabled) {
    e.preventDefault();
    handleSubmit();
  }
};

submitBtn.onclick = handleSubmit;

function showFuzzyMatches(input) {
  const norm = normalize(input);
  if (norm.length < 2) return;

  // Include ALL players (used and available) for display
  const scored = eligiblePlayers.map(p => ({
    player: p,
    isUsed: state.used.has(p.normalized),
    score: p.normalized.includes(norm) ? 0.95 : similarity(p.normalized, norm),
    exactStart: p.normalized.startsWith(norm),
  }));

  const matches = scored
    .filter(m => m.score >= 0.5 || m.exactStart)
    .sort((a, b) => {
      // Sort by: available first, then by score
      if (a.isUsed !== b.isUsed) return a.isUsed ? 1 : -1;
      if (a.exactStart !== b.exactStart) return b.exactStart - a.exactStart;
      return b.score - a.score;
    })
    .slice(0, 6);

  if (matches.length === 0) return;

  // Check for exact match among available
  const exactAvailable = eligiblePlayers.find(p => p.normalized === norm && !state.used.has(p.normalized));
  if (exactAvailable) return;

  const list = $('selectionList');
  list.innerHTML = matches.map(m => `
    <div class="selection-item${m.isUsed ? ' used' : ''}" data-norm="${m.player.normalized}" data-used="${m.isUsed}">
      <div class="info">
        <div class="name">${m.player.name}</div>
        <div class="nat">${m.player.nationality}</div>
      </div>
      ${m.isUsed ? '<span class="used-badge">Used</span>' : ''}
    </div>
  `).join('');

  list.querySelectorAll('.selection-item').forEach(el => {
    el.onclick = () => {
      if (el.dataset.used === 'true') {
        setResult('‚ö†Ô∏è Already used this match!');
        return;
      }
      selectPlayer(el.dataset.norm);
    };
  });

  list.classList.remove('hidden');
}

function selectPlayer(normalized) {
  const player = eligiblePlayers.find(p => p.normalized === normalized);
  if (player) {
    guessInput.value = player.name;
    submitBtn.disabled = false;
    hideSelectionList();
    handleSubmit();
  }
}

function hideSelectionList() {
  $('selectionList').classList.add('hidden');
}

// ============== SUBMIT LOGIC ==============
async function handleSubmit() {
  const raw = guessInput.value.trim();
  if (!raw) return;

  submitBtn.disabled = true;
  hideSelectionList();

  const norm = normalize(raw);

  if (state.used.has(norm)) {
    if (!state.retry) {
      state.retry = true;
      setResult('‚ö†Ô∏è Already used. Try once more.');
      submitBtn.disabled = false;
      guessInput.select();
      return;
    }
    state.retry = false;
    setResult('‚ùå Duplicate. Turn passes.');
    nextTurn();
    return;
  }

  const available = eligiblePlayers.filter(p => !state.used.has(p.normalized));

  let match = available.find(p => p.normalized === norm);

  if (!match) {
    match = available.find(p => p.normalized.includes(norm));
  }

  if (!match) {
    let best = null;
    let bestScore = 0;
    for (const p of available) {
      const s = similarity(p.normalized, norm);
      if (s > bestScore) {
        best = p;
        bestScore = s;
      }
    }
    if (best && bestScore >= 0.78) {
      match = best;
    }
  }

  if (!match) {
    if (!state.retry) {
      state.retry = true;
      setResult('‚ùå Not found. Try once more.');
      submitBtn.disabled = false;
      guessInput.select();
      return;
    }
    state.retry = false;
    setResult('‚ùå Not found. Turn passes.');
    nextTurn();
    return;
  }

  state.retry = false;

  if (state.used.has(match.normalized)) {
    setResult('‚ö†Ô∏è Already used. Turn passes.');
    nextTurn();
    return;
  }

  const before = state.scores[state.turn];
  const deduct = match.subtractValue;
  const after = before - deduct;

  let bust = false;
  let win = false;

  if (deduct === 0) {
    bust = true;
  } else if (after < 0) {
    bust = true;
  } else if (after === 0) {
    win = true;
  }

  const metricLabel = currentMeta?.metricLabel || 'Apps';

  state.picks[state.turn].unshift({
    name: match.name,
    value: deduct,
    from: before,
    to: bust ? before : after,
    bust,
  });

  if (bust) {
    setResult(`üí• Bust! ${match.name} has ${formatNum(deduct)} ${metricLabel.toLowerCase()}. Score stays ${formatNum(before)}.`);
    showToast(match, before, before, 'bust');
    showEffect('bust');
    const pill = $(`pill_${state.turn}`);
    pill?.classList.add('bust-anim');
    setTimeout(() => pill?.classList.remove('bust-anim'), 500);
  } else {
    state.scores[state.turn] = after;
    state.historyScores[state.turn].push(after);
    state.used.add(match.normalized);

    animateScore(state.turn, before, after);

    if (win) {
      const winnerName = state.players[state.turn];
      const turnsText = state.turnCount === 1 ? '1 turn' : `${state.turnCount} turns`;
      setResult(`üéØ ${winnerName} wins with ${match.name} (${formatNum(deduct)})!`);
      showToast(match, before, after, 'win');
      showEffect('win');
      const pill = $(`pill_${state.turn}`);
      pill?.classList.add('win-anim');
      setTimeout(() => {
        if (confirm(`üèÜ ${winnerName} wins in ${turnsText}! Play again?`)) {
          location.reload();
        }
      }, 1500);
      return;
    } else {
      setResult(`‚úÖ ${match.name}: ‚àí${formatNum(deduct)}`);
      showToast(match, before, after, 'normal');
    }
  }

  nextTurn();
}

function nextTurn() {
  guessInput.value = '';
  submitBtn.disabled = true;
  state.turn = (state.turn + 1) % state.players.length;
  state.turnCount++;
  renderScoreboard();
  updateTurnUI();
  guessInput.focus();
}

function setResult(msg) {
  $('result').textContent = msg;
}

// ============== EFFECT OVERLAY ==============
function showEffect(type) {
  const overlay = $('effectOverlay');
  const text = $('effectText');
  text.className = 'effect-text ' + type;
  text.textContent = type === 'bust' ? 'BUST!' : 'CHECKOUT!';
  overlay.classList.add('show');
  setTimeout(() => overlay.classList.remove('show'), 600);
}

// ============== TOAST ==============
let toastTimer = null;

function showToast(player, before, after, type) {
  const toast = $('inlineToast');
  const o = player.overlay || {};
  const metricLabel = currentMeta?.metricLabel || 'Apps';

  // Build clubs display
  let clubsHtml = '';
  if (player.clubs && player.clubs.length > 0) {
    const displayClubs = player.clubs.slice(0, 3);
    const moreCount = player.clubCount - 3;
    clubsHtml = `<div class="toast-clubs">Clubs: ${displayClubs.join(', ')}${moreCount > 0 ? ` +${moreCount} more` : ''}</div>`;
  }

  // Build seasons display
  let seasonsHtml = '';
  if (player.seasonsCount) {
    seasonsHtml = `<span>Seasons: ${player.seasonsCount}</span>`;
  }

  let badgeClass = '';
  let badgeContent = '-' + formatNum(player.subtractValue);
  if (type === 'bust') {
    badgeClass = ' bust';
    badgeContent = 'üí•';
  } else if (type === 'win') {
    badgeClass = ' win';
    badgeContent = 'üéØ';
  }

  toast.className = 'inline-toast';
  if (type === 'bust') toast.classList.add('bust-effect');
  if (type === 'win') toast.classList.add('win-effect');

  toast.innerHTML = `
    <div class="toast-row">
      <div class="toast-badge${badgeClass}">${badgeContent}</div>
      <div class="toast-body">
        <div class="toast-title">${player.name}</div>
        <div class="toast-sub">${formatNum(before)} ‚Üí ${formatNum(after)}</div>
        ${clubsHtml}
        <div class="toast-meta">
          <span>${metricLabel} ${formatNum(o[currentMeta?.metric === 'goals_total' ? 'goals' : 'apps'] || player.subtractValue)}</span>
          ${o.goals && currentMeta?.metric !== 'goals_total' ? `<span>Goals ${formatNum(o.goals)}</span>` : ''}
          ${o.starts ? `<span>Starts ${formatNum(o.starts)}</span>` : ''}
          ${seasonsHtml}
        </div>
      </div>
    </div>
  `;
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 6000);
}

function hideToast() {
  $('inlineToast').classList.remove('show');
}

// ============== SCORE ANIMATION ==============
function animateScore(idx, from, to) {
  const el = $(`score_${idx}`);
  if (!el) return;
  const start = performance.now();
  const duration = 800;
  const diff = to - from;

  function step(time) {
    const progress = Math.min(1, (time - start) / duration);
    const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
    el.textContent = Math.round(from + diff * ease);
    if (progress < 1) {
      requestAnimationFrame(step);
    } else {
      el.textContent = to;
    }
  }
  requestAnimationFrame(step);
}

// ============== PROGRESS MODAL ==============
function openProgressModal(idx) {
  $('modalTitle').textContent = `${state.players[idx]} ‚Äî Progress`;
  $('chain').textContent = state.historyScores[idx].join(' ‚Üí ');

  const picks = state.picks[idx];
  const metricLabel = currentMeta?.metricLabel || 'Apps';
  if (picks.length === 0) {
    $('pickList').innerHTML = '<div class="pick"><div>No picks yet</div></div>';
  } else {
    $('pickList').innerHTML = picks.slice(0, 15).map(p => `
      <div class="pick${p.bust ? ' bust' : ''}">
        <div><b>${p.name}</b> <span class="meta">-${formatNum(p.value)}</span></div>
        <div class="meta">${formatNum(p.from)} ‚Üí ${formatNum(p.to)}${p.bust ? ' (bust)' : ''}</div>
      </div>
    `).join('');
  }

  $('modalBackdrop').classList.add('show');
  requestAnimationFrame(() => $('modal').classList.add('show'));
}

function closeModal() {
  $('modal').classList.remove('show');
  setTimeout(() => $('modalBackdrop').classList.remove('show'), 200);
}

$('closeModal').onclick = closeModal;
$('modalBackdrop').onclick = (e) => {
  if (e.target.id === 'modalBackdrop') closeModal();
};

// ============== END GAME CONFIRMATION ==============
$('endBtn').onclick = () => {
  $('confirmOverlay').classList.add('show');
};

$('confirmNo').onclick = () => {
  $('confirmOverlay').classList.remove('show');
};

$('confirmYes').onclick = () => {
  location.reload();
};

// ============== INIT ==============
(function init() {
  // No pre-initialization needed - mode selection handles the flow
})();
</script>
</body>
</html>
