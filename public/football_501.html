<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>PredictFootball.ai 501</title>
<style>
:root{
  --bg:#000;--card:#4f8b6e;--ink:#fff;--muted:#cfe5db;
  --btn:#111;--btnH:#222;--danger:#ff5a5a;--accent:#0b1;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh;padding:22px}
.card{max-width:560px;margin:0 auto;background:var(--card);border-radius:22px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,.5);position:relative}
h2{margin:0 0 14px;font-size:22px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input{width:100%;display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.label{font-size:13px;color:#e8f3ee;font-weight:700}
input,select,button{width:100%;padding:12px 14px;border:none;border-radius:12px;font-size:16px}
input{background:#f7fffbd8;color:#0c1b15}
button{background:var(--btn);color:#fff;cursor:pointer;transition:.15s}
button:hover{background:var(--btnH)}
.textbtn{background:none;color:#fff;text-decoration:underline;font-size:13px;padding:6px 4px;width:auto}
.game-card{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(0,0,0,.18);border-radius:14px;padding:14px 16px;cursor:pointer;margin-bottom:10px}
.game-meta{font-size:12px;color:#e8f3ee}
.stars{color:gold}
.scores{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 6px}
.pill{flex:1 1 45%;background:rgba(0,0,0,.25);border-radius:16px;padding:12px;text-align:center;cursor:pointer}
.pill.active{background:rgba(255,255,255,.15);outline:2px solid #fff}
.pill .name{font-weight:700}.pill .num{font-size:30px;font-weight:800}
.turn{text-align:center;margin:10px 0;font-weight:700}
.result{min-height:24px;text-align:center;margin:8px 0}
.inline-toast{margin:8px auto 0;width:100%;max-width:520px;background:rgba(0,0,0,.92);color:#fff;border-radius:16px;padding:12px 14px;box-shadow:0 10px 28px rgba(0,0,0,.5);opacity:0;transform:translateY(6px);transition:opacity .25s,transform .25s}
.inline-toast.show{opacity:1;transform:translateY(0)}
.toast-row{display:flex;align-items:center;gap:12px}
.badge{min-width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;background:#1f8a5e}
.toast-body{flex:1}.toast-title{font-weight:800;margin:0 0 4px}.toast-sub{opacity:.85;font-size:13px}
.toast-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;opacity:.85}
.toast-meta span{background:rgba(255,255,255,.08);padding:6px 8px;border-radius:9px}
.hint{margin:6px 0 8px;text-align:center;font-size:13px;color:var(--accent);font-weight:700}
.loader{display:flex;align-items:center;justify-content:center;height:240px}
.loader span{font-size:20px;animation:pulse 1.2s infinite}
@keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
.randomising{font-size:18px;text-align:center;padding:24px 0;animation:pulse 1s infinite}
.orderList{margin-top:10px;background:rgba(0,0,0,.25);border-radius:12px;padding:10px 12px}
.hidden{display:none}

/* progress modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
.modal-backdrop.show{display:flex}
.modal{width:min(520px,92vw);background:#0f2a21;color:#fff;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.7);padding:16px 16px 14px;transform:translateY(8px);opacity:0;transition:transform .25s ease,opacity .2s ease}
.modal.show{transform:translateY(0);opacity:1}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.modal-title{font-weight:900;font-size:18px}
.close-btn{background:#2a3e36;border:none;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
.chain{background:#133a2e;padding:10px 12px;border-radius:12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;overflow:auto}
.pick-list{margin-top:10px;display:grid;gap:8px}
.pick{background:#0c241c;padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.pick b{font-weight:800}.pick .meta{opacity:.85;font-size:12px}
.bust{color:#ff8a8a}
</style>
</head>
<body>

<!-- SETUP -->
<div class="card" id="setupCard">
  <div id="step1">
    <h2>1Ô∏è‚É£ Number of players</h2>
    <div class="input">
      <label class="label" for="numPlayers">Players</label>
      <select id="numPlayers">
        <option value="1">1</option><option value="2" selected>2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option>
      </select>
    </div>
    <button id="toStep2">Next</button>
  </div>

  <div id="step2" class="hidden">
    <h2>2Ô∏è‚É£ Player names</h2>
    <div id="nameFields"></div>
    <button id="toStep3">Next</button>
  </div>

  <div id="step3" class="hidden">
    <h2>3Ô∏è‚É£ Choose game</h2>
    <div id="gameOptions"></div>
  </div>

  <div id="loadingScreen" class="hidden loader"><span>Loading game‚Ä¶</span></div>

  <div id="randomisingScreen" class="hidden">
    <div class="randomising">üé≤ Randomising order‚Ä¶</div>
    <div id="orderList" class="orderList hidden"></div>
    <button id="beginMatch" class="hidden">Start Match</button>
  </div>
</div>

<!-- GAMEPLAY -->
<div class="card hidden" id="playCard">
  <div class="scores" id="scoreGrid"></div>
  <div class="turn" id="turnInfo"></div>
  <div id="checkoutHint" class="hint hidden"></div>

  <div class="input" style="margin-top:8px;">
    <label for="guess" class="label">Your pick</label>
    <input id="guess" placeholder="Type a player"/>
  </div>
  <div class="row">
    <button id="submit">Submit</button>
    <button id="end" class="textbtn">End game</button>
  </div>

  <div class="result" id="result"></div>
  <div id="inlineToast" class="inline-toast"></div>
</div>

<!-- PROGRESS MODAL -->
<div id="modalBack" class="modal-backdrop">
  <div id="modal" class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Progress</div>
      <button id="closeModal" class="close-btn">Close</button>
    </div>
    <div><strong>Checkout chain</strong></div>
    <div id="chain" class="chain">‚Äî</div>
    <div class="pick-list" id="pickList"></div>
  </div>
</div>

<script>
const API={ start:'/.netlify/functions/start-game', validate:'/.netlify/functions/validate-player', score:'/.netlify/functions/score-round' };
const COUNTRIES=[ {name:'Spain',flag:'üá™üá∏',code:'Spain'}, {name:'France',flag:'üá´üá∑',code:'France'}, {name:'Brazil',flag:'üáßüá∑',code:'Brazil'} ];
const TTL=90*60*1000;

let playersCache=[], state=null, selectedCountry=null;

/* ---------- SETUP FLOW ---------- */
document.getElementById('toStep2').onclick=()=>{
  const n=+document.getElementById('numPlayers').value;
  const wrap=document.getElementById('nameFields'); wrap.innerHTML='';
  for(let i=1;i<=n;i++){
    const c=document.createElement('div'); c.className='input';
    c.innerHTML=`<label class="label">Player ${i}</label><input id="pname${i}" placeholder="Enter name">`;
    wrap.appendChild(c);
  }
  show('step2'); hide('step1');
};

document.getElementById('toStep3').onclick=()=>{
  const n=+document.getElementById('numPlayers').value;
  const names=[]; for(let i=1;i<=n;i++){ names.push(document.getElementById(`pname${i}`).value||`Player ${i}`); }
  window.gameSetup={names};
  buildGameCards(); show('step3'); hide('step2');
};

function buildGameCards(){
  const opts=document.getElementById('gameOptions'); opts.innerHTML='';
  COUNTRIES.forEach(c=>{
    const el=document.createElement('div'); el.className='game-card';
    el.innerHTML=`<div><div><b>${c.flag} ${c.name}</b> ‚Äî players in PL</div><div class="game-meta" id="info-${c.code}">Loading‚Ä¶</div></div><div>‚û§</div>`;
    el.onclick=()=> chooseGame(c.code, c.name);
    opts.appendChild(el);
    // preload stats for difficulty
    fetch(`${API.validate}?fetchAll=1&country=${encodeURIComponent(c.code)}`).then(r=>r.json()).then(data=>{
      const total=data.length;
      const totalMatches=data.reduce((a,b)=>a+Number(b.Matches||b.matches||0),0);
      const avg = total ? totalMatches/total : 0;
      const group=(window.gameSetup?.names?.length||2);
      const base=Math.min(5,Math.ceil(avg/100));
      const groupAdj=Math.min(2,Math.ceil((group-2)/2));
      const diff=Math.min(5,Math.max(1,base+groupAdj));
      document.getElementById(`info-${c.code}`).innerHTML=`<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5-diff)}</span> ‚Ä¢ ${total} players ‚Ä¢ ${Number(totalMatches).toLocaleString()} apps`;
    }).catch(()=>{ document.getElementById(`info-${c.code}`).textContent='‚Äî'; });
  });
}

async function chooseGame(countryCode){
  selectedCountry=countryCode;
  hide('step3'); show('loadingScreen');
  try{
    playersCache = await fetchAllPlayersByCountry(countryCode);
  }catch(e){
    alert('Failed to load data. Try again.'); show('step3'); hide('loadingScreen'); return;
  }
  hide('loadingScreen'); show('randomisingScreen');
  await randomiseOrderAndShow();
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function randomiseOrderAndShow(){
  const names=[...(window.gameSetup?.names||['Player 1','Player 2'])];
  for(let i=0;i<8;i++){
    names.sort(()=>Math.random()-0.5);
    document.querySelector('#randomisingScreen .randomising').textContent='üé≤ Randomising order‚Ä¶ '+names.join(' ‚Ä¢ ');
    await sleep(120);
  }
  names.sort(()=>Math.random()-0.5);
  const orderEl=document.getElementById('orderList');
  orderEl.classList.remove('hidden');
  orderEl.innerHTML='<b>Order:</b> '+names.map((n,i)=>`${i+1}. ${n}`).join('&nbsp;&nbsp;');
  const btn=document.getElementById('beginMatch'); btn.classList.remove('hidden');
  btn.onclick=()=>beginMatch(names);
}

async function beginMatch(names){
  state={
    players:names,
    scores:Array(names.length).fill(501),
    turn:0,
    used:new Set(),
    retry:false,
    historyScores:names.map(()=>[501]),
    picks:names.map(()=>[])
  };
  renderScoreGrid(); updateTurnUI();
  show('playCard'); hide('setupCard'); document.getElementById('guess').focus();
}

/* ---------- DATA (country-scoped cache) ---------- */
async function fetchAllPlayersByCountry(country){
  const key=`players_${country}`, tsKey=`players_ts_${country}`;
  const now=Date.now(), ts=+localStorage.getItem(tsKey)||0;
  const cached=localStorage.getItem(key);
  if(cached && (now-ts)<TTL) return JSON.parse(cached);
  const res=await fetch(`${API.validate}?fetchAll=1&country=${encodeURIComponent(country)}`);
  const data=await res.json();
  localStorage.setItem(key, JSON.stringify(data)); localStorage.setItem(tsKey, String(now));
  return data;
}

/* ---------- GAMEPLAY UI ---------- */
function renderScoreGrid(){
  const grid=document.getElementById('scoreGrid'); grid.innerHTML='';
  state.players.forEach((name,idx)=>{
    const div=document.createElement('div');
    div.className='pill'+(idx===state.turn?' active':'');
    div.innerHTML=`<div class="name">${name}</div><div class="num" id="score_${idx}">${state.scores[idx]}</div>`;
    div.onclick=()=>openProgressModal(idx);
    grid.appendChild(div);
  });
}
function setActivePill(){ document.querySelectorAll('.pill').forEach((el,i)=> el.classList.toggle('active', i===state.turn)); }
function updateTurnUI(){ document.getElementById('turnInfo').textContent=`${state.players[state.turn]}'s turn`; updateCheckoutHint(); setActivePill(); }
function updateCheckoutHint(){
  const hint=document.getElementById('checkoutHint'); const remaining=state.scores[state.turn];
  if(remaining<=0 || playersCache.length===0){ hint.classList.add('hidden'); hint.textContent=''; return; }
  const available=playersCache.filter(p=>!state.used.has((p.player||'').toLowerCase()));
  const direct=available.reduce((a,p)=>a+(Number(p.Matches||p.matches||0)===remaining?1:0),0);
  const freq=new Map(); for(const p of available){ const m=+ (p.Matches||p.matches||0); if(m>0 && m<=remaining) freq.set(m,(freq.get(m)||0)+1); }
  let pairs=0; for(const [m,c] of freq.entries()){ const n=remaining-m; if(n<m) continue; if(!freq.has(n)) continue; pairs+= (n===m)? c*(c-1)/2 : c*freq.get(n); }
  hint.innerHTML=`Checkout: <strong>${direct===0?'no':direct}</strong> direct ¬∑ <strong>${pairs>10?'>10':pairs}</strong> two-player combos`;
  hint.classList.remove('hidden');
}

/* ---------- MODAL (progress) ---------- */
function openProgressModal(i){
  document.getElementById('modalTitle').textContent=`${state.players[i]} ‚Äî Progress`;
  document.getElementById('chain').textContent=state.historyScores[i].join(' ‚Üí ');
  const list=state.picks[i].slice(0,12).map(p=>`
    <div class="pick${p.bust?' bust':''}">
      <div><b>${p.name}</b> <span class="meta">-${p.matches}</span></div>
      <div class="meta">${p.from} ‚Üí ${p.to}${p.bust?' (bust)':''}</div>
    </div>`).join('') || '<div class="pick"><div>No picks yet</div></div>';
  document.getElementById('pickList').innerHTML=list;
  show('modalBack'); requestAnimationFrame(()=> show('modal'));
}
document.getElementById('closeModal').onclick=closeModal;
document.getElementById('modalBack').onclick=(e)=>{ if(e.target.id==='modalBack') closeModal(); };
function closeModal(){ hide('modal'); setTimeout(()=>hide('modalBack'),160); }

/* ---------- IMPACT OVERLAY ---------- */
let toastTimer=null;
function showImpactInline({ canonical, matches, starts, goals, mins }, before, after){
  const box=document.getElementById('inlineToast');
  const fmt=n=>Number(n||0).toLocaleString();
  box.innerHTML=`<div class="toast-row"><div class="badge">-${matches}</div>
    <div class="toast-body"><div class="toast-title">${canonical}</div>
    <div class="toast-sub">${before} ‚Üí ${after}</div>
    <div class="toast-meta"><span>Matches ${matches}</span><span>Starts ${fmt(starts)}</span><span>Goals ${fmt(goals)}</span><span>Mins ${fmt(mins)}</span></div></div></div>`;
  box.classList.add('show'); if(toastTimer) clearTimeout(toastTimer); toastTimer=setTimeout(()=> box.classList.remove('show'),5000);
}
document.getElementById('guess').addEventListener('input',()=> document.getElementById('inlineToast').classList.remove('show'));

/* ---------- SUBMIT / END ---------- */
document.getElementById('submit').onclick=onSubmit;
document.getElementById('end').onclick=()=>{ if(confirm('End this match?')) location.reload(); };

async function onSubmit(){
  const input=document.getElementById('guess'); const raw=input.value.trim(); if(!raw) return;
  const lower=raw.toLowerCase();

  // duplicate retry
  if(state.used.has(lower)){
    if(!state.retry){ state.retry=true; setResult('‚ö†Ô∏è Already used. Try once more.'); input.focus(); return; }
    state.retry=false; setResult('‚ùå Duplicate. Turn passes.'); nextTurn(); return;
  }

  // validate (PASS COUNTRY HERE)
  let v; 
  try{
    v=await fetch(`${API.validate}?country=${encodeURIComponent(selectedCountry)}`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({guess:raw})
    }).then(r=>r.json());
  }catch(_){ v={valid:false}; }

  if(!v.valid){
    if(!state.retry){ state.retry=true; setResult('‚ùå Not found. Try once more.'); input.focus(); return; }
    state.retry=false; setResult('‚ùå Not found. Turn passes.'); nextTurn(); return;
  }

  state.retry=false;
  const canonical=(v.canonical||raw).toLowerCase();
  if(state.used.has(canonical)){ setResult('‚ö†Ô∏è Already used. Turn passes.'); nextTurn(); return; }

  // score
  const before=state.scores[state.turn];
  let s;
  try{
    s=await fetch(API.score,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({player:state.turn,scores:state.scores,deduct:v.matches})
    }).then(r=>r.json());
  }catch(_){ setResult('Error scoring.'); return; }

  if(s.bust){
    setResult(`üí• Bust! ${v.canonical} has ${v.matches}. Score stays ${state.scores[state.turn]}.`);
    state.picks[state.turn].unshift({name:v.canonical,matches:v.matches,from:before,to:before,bust:true});
  }else{
    state.scores=s.scores;
    const after=state.scores[state.turn];
    const scoreEl=document.getElementById(`score_${state.turn}`);
    animateCount(scoreEl, before, after, 850);
    setResult(s.win ? `üéØ ${state.players[state.turn]} checked out with ${v.canonical} (${v.matches}).` : `‚úÖ ${v.canonical}: ‚àí${v.matches}`);
    state.used.add(canonical);
    state.historyScores[state.turn].push(after);
    state.picks[state.turn].unshift({name:v.canonical,matches:v.matches,from:before,to:after,bust:false});
    showImpactInline({canonical:v.canonical,matches:v.matches,starts:v.starts,goals:v.goals,mins:v.mins}, before, after);
  }

  if(s.win){ setTimeout(()=>location.reload(), 1200); return; }
  nextTurn();
}

function nextTurn(){ const input=document.getElementById('guess'); input.value=''; input.focus(); state.turn=(state.turn+1)%state.players.length; renderScoreGrid(); updateTurnUI(); }
function setResult(msg){ document.getElementById('result').textContent=msg; }

/* ---------- INIT ---------- */
(function initNames(){
  const n=+document.getElementById('numPlayers').value;
  const wrap=document.getElementById('nameFields');
  for(let i=1;i<=n;i++){
    const c=document.createElement('div'); c.className='input';
    c.innerHTML=`<label class="label">Player ${i}</label><input id="pname${i}" placeholder="Enter name">`;
    wrap.appendChild(c);
  }
})();
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function animateCount(el, from, to, dur=850){
  const start=performance.now(); const diff=to-from;
  function step(t){ const p=Math.min(1,(t-start)/dur); const ease=p<.5?2*p*p:-1+(4-2*p)*p; el.textContent=Math.round(from+diff*ease); if(p<1) requestAnimationFrame(step); else el.textContent=String(to); }
  requestAnimationFrame(step);
}
</script>
</body>
</html>
