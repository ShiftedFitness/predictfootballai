<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Football 501</title>
<style>
:root {
  --bg: #0a0f0d;
  --card: #1a3a2a;
  --card-dark: #0f2a1f;
  --ink: #fff;
  --muted: #a8c4b8;
  --btn: #2d5a45;
  --btn-hover: #3d7a5a;
  --danger: #e05555;
  --accent: #4ade80;
  --accent-dim: #22c55e;
  --gold: #fbbf24;
  --used: #666;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100vh;
  padding: 16px;
  line-height: 1.4;
}
.card {
  max-width: 560px;
  margin: 0 auto;
  background: var(--card);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
}
h2 { margin: 0 0 16px; font-size: 20px; font-weight: 700; }
.subtitle { color: var(--muted); font-size: 14px; margin: -12px 0 16px; }

/* Form elements */
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 13px; color: var(--muted); font-weight: 600; margin-bottom: 6px; }
input, select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid transparent;
  border-radius: 12px;
  font-size: 16px;
  background: rgba(255,255,255,.95);
  color: #1a1a1a;
  transition: border-color .2s;
}
input:focus, select:focus { outline: none; border-color: var(--accent); }
input::placeholder { color: #888; }

/* Buttons */
button {
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all .2s;
  min-height: 48px;
}
.btn-primary { background: var(--accent); color: #0a0f0d; }
.btn-primary:hover:not(:disabled) { background: var(--accent-dim); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }
.btn-secondary { background: var(--btn); color: #fff; }
.btn-secondary:hover:not(:disabled) { background: var(--btn-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-text { background: none; color: var(--muted); text-decoration: underline; font-size: 14px; padding: 8px; width: auto; min-height: auto; }
.btn-back { background: var(--card-dark); color: var(--muted); margin-bottom: 12px; font-size: 14px; padding: 10px 16px; }
.btn-back:hover { background: var(--btn); color: #fff; }
.row-btns { display: flex; gap: 10px; margin-top: 12px; }
.row-btns button { flex: 1; }

/* Category sections */
.section { background: var(--card-dark); border-radius: 14px; margin-bottom: 10px; overflow: hidden; }
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  cursor: pointer;
  transition: background .2s;
}
.section-header:hover { background: rgba(255,255,255,.03); }
.section-title { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
.section-count { font-size: 12px; color: var(--muted); font-weight: 400; }
.chev { opacity: .7; transition: transform .2s; font-size: 12px; }
.section.open .chev { transform: rotate(180deg); }
.section-body { display: none; padding: 8px 12px 12px; }
.section.open .section-body { display: block; }
.section.disabled .section-header { opacity: .5; cursor: not-allowed; }
.section.disabled .section-body { display: none; }
.section-desc { display: none; font-size: 12px; color: var(--muted); padding: 0 16px 8px; line-height: 1.4; }
.section.open .section-desc { display: block; }
.disabled-note { font-size: 12px; color: var(--muted); padding: 12px; text-align: center; }

/* Game cards */
.game-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255,255,255,.04);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: background .2s, transform .1s;
}
.game-card:hover { background: rgba(255,255,255,.08); }
.game-card:active { transform: scale(.98); }
.game-card .flag { font-size: 18px; margin-right: 10px; }
.game-card .color-dot { width: 18px; height: 18px; border-radius: 4px; margin-right: 10px; flex-shrink: 0; }
.game-card .title { font-weight: 600; font-size: 13px; }
.game-card .meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
.game-card .arrow { opacity: .5; font-size: 14px; }
.stars { color: var(--gold); letter-spacing: 1px; font-size: 10px; }

/* Loading screen with trivia */
.loading-screen { text-align: center; padding: 20px 0; }
.loading-spinner {
  width: 48px; height: 48px;
  border: 4px solid rgba(255,255,255,.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}
.loading-spinner.ready { animation: none; border-color: var(--accent); background: rgba(74,222,128,.2); }
.loading-spinner.ready::after { content: '‚úì'; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 24px; color: var(--accent); }
.loading-screen { position: relative; }
.loading-spinner-wrap { position: relative; width: 48px; height: 48px; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 16px; margin-bottom: 20px; }
.loading-text.ready { color: var(--accent); }
.ready-badge {
  display: inline-block;
  background: var(--accent);
  color: #0a0f0d;
  font-weight: 700;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  margin-bottom: 16px;
  animation: pulse 1.5s ease infinite;
}
.trivia-note { font-size: 11px; color: var(--muted); margin-top: 8px; font-style: italic; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }

/* Trivia */
.trivia-box { background: var(--card-dark); border-radius: 14px; padding: 16px; margin-top: 16px; text-align: left; }
.trivia-q { font-weight: 600; margin-bottom: 12px; font-size: 15px; }
.trivia-opts { display: flex; flex-direction: column; gap: 8px; }
.trivia-opt {
  background: rgba(255,255,255,.06);
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 12px 14px;
  cursor: pointer;
  transition: all .2s;
  font-size: 14px;
}
.trivia-opt:hover { background: rgba(255,255,255,.1); }
.trivia-opt.selected { border-color: var(--accent); background: rgba(74,222,128,.1); }
.trivia-opt.correct { background: rgba(74,222,128,.3); border-color: var(--accent); }
.trivia-opt.wrong { background: rgba(224,85,85,.2); border-color: var(--danger); }

/* Order reveal */
.order-reveal { text-align: center; padding: 20px 0; }
.order-list {
  background: var(--card-dark);
  border-radius: 12px;
  padding: 14px;
  margin: 16px 0;
  font-size: 15px;
}

/* Scoreboard */
.scores { display: grid; gap: 8px; margin-bottom: 14px; }
.scores.p1 { grid-template-columns: 1fr; }
.scores.p2 { grid-template-columns: 1fr 1fr; }
.scores.p3 { grid-template-columns: 1fr 1fr 1fr; }
.scores.p4 { grid-template-columns: 1fr 1fr; }
.scores.p5, .scores.p6 { grid-template-columns: 1fr 1fr 1fr; }
.pill {
  background: var(--card-dark);
  border-radius: 14px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  border: 2px solid transparent;
}
.pill.active { border-color: var(--accent); background: rgba(74,222,128,.1); }
.pill .name { font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pill .score { font-size: 26px; font-weight: 800; }
.pill.bust-anim { animation: shake .4s ease; }
.pill.win-anim { animation: celebrate .6s ease; }
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-4px); }
  40%, 80% { transform: translateX(4px); }
}
@keyframes celebrate {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
.turn-info { text-align: center; font-weight: 700; margin-bottom: 10px; font-size: 14px; }
.hint-bar { font-size: 12px; color: var(--accent); margin-bottom: 10px; padding: 8px 10px; background: rgba(74,222,128,.08); border-radius: 10px; display: flex; align-items: center; gap: 8px; }
.hint-bar .hint-text { flex: 1; text-align: center; }
.coverage-btn {
  width: 28px;
  height: 28px;
  min-width: 28px;
  flex-shrink: 0;
  background: rgba(255,255,255,.1);
  border: 1px solid rgba(255,255,255,.15);
  color: var(--muted);
  padding: 0;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.coverage-btn:hover { background: rgba(255,255,255,.2); color: #fff; border-color: rgba(255,255,255,.25); }
.coverage-btn:active { transform: scale(.95); }

/* Coverage modal */
.coverage-modal { max-width: 380px; }
.coverage-grid { display: flex; flex-direction: column; gap: 6px; margin: 12px 0; }
.coverage-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
.coverage-label { width: 70px; text-align: right; color: var(--muted); font-size: 11px; }
.coverage-bar-wrap { flex: 1; background: rgba(255,255,255,.1); border-radius: 4px; height: 20px; overflow: hidden; }
.coverage-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width .3s ease; }
.coverage-count { width: 36px; text-align: right; font-weight: 600; font-size: 12px; }
.coverage-stats { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.coverage-stat { background: var(--card-dark); padding: 8px 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 80px; }
.coverage-stat .label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
.coverage-stat .value { font-size: 16px; font-weight: 700; margin-top: 2px; }

/* Selection list (fuzzy matches) */
.selection-list {
  background: var(--card-dark);
  border-radius: 12px;
  margin-top: 10px;
  overflow: hidden;
  max-height: 280px;
  overflow-y: auto;
}
.selection-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  cursor: pointer;
  transition: background .15s;
  border-bottom: 1px solid rgba(255,255,255,.05);
}
.selection-item:last-child { border-bottom: none; }
.selection-item:hover:not(.used) { background: rgba(255,255,255,.06); }
.selection-item .info { flex: 1; }
.selection-item .name { font-weight: 600; font-size: 14px; }
.selection-item .nat { font-size: 11px; color: var(--muted); }
.selection-item.used { opacity: .5; cursor: not-allowed; }
.selection-item.used .name { color: var(--used); text-decoration: line-through; }
.used-badge {
  font-size: 9px;
  background: var(--danger);
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 700;
  text-transform: uppercase;
}

/* Result toast */
.result { min-height: 18px; text-align: center; margin: 8px 0; font-size: 13px; }
.inline-toast {
  background: var(--card-dark);
  border-radius: 14px;
  padding: 14px;
  margin-top: 10px;
  opacity: 0;
  transform: translateY(8px);
  transition: all .25s;
}
.inline-toast.show { opacity: 1; transform: translateY(0); }
.inline-toast.bust-effect { border: 2px solid var(--danger); }
.inline-toast.win-effect { border: 2px solid var(--gold); background: rgba(251,191,36,.1); }
.toast-row { display: flex; align-items: flex-start; gap: 12px; }
.toast-badge {
  min-width: 52px; height: 52px;
  background: var(--accent);
  color: #0a0f0d;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  flex-shrink: 0;
}
.toast-badge.bust { background: var(--danger); color: #fff; font-size: 24px; }
.toast-badge.win { background: var(--gold); color: #000; font-size: 20px; }
.toast-body { flex: 1; min-width: 0; }
.toast-title { font-weight: 700; font-size: 15px; }
.toast-sub { color: var(--muted); font-size: 12px; margin-top: 2px; }
.toast-clubs { font-size: 11px; color: var(--muted); margin-top: 4px; }
.toast-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
.toast-meta span {
  background: rgba(255,255,255,.06);
  padding: 4px 7px;
  border-radius: 5px;
  font-size: 10px;
  color: var(--muted);
}

/* Bust/Win overlays */
.effect-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  pointer-events: none;
}
.effect-overlay.show { display: flex; }
.effect-text {
  font-size: 48px;
  font-weight: 900;
  text-transform: uppercase;
  animation: effectPop .5s ease-out forwards;
  opacity: 0;
}
.effect-text.bust { color: var(--danger); text-shadow: 0 4px 20px rgba(224,85,85,.5); }
.effect-text.win { color: var(--gold); text-shadow: 0 4px 20px rgba(251,191,36,.5); }
@keyframes effectPop {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 0; }
}

/* Progress modal */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 16px;
}
.modal-backdrop.show { display: flex; }
.modal {
  width: 100%;
  max-width: 480px;
  max-height: 80vh;
  overflow-y: auto;
  background: var(--card);
  border-radius: 18px;
  padding: 20px;
  transform: translateY(10px);
  opacity: 0;
  transition: all .25s;
}
.modal.show { transform: translateY(0); opacity: 1; }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.modal-title { font-weight: 800; font-size: 17px; }
.close-btn { background: var(--btn); border: none; color: #fff; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; }
.chain { background: var(--card-dark); padding: 12px; border-radius: 10px; font-family: monospace; font-size: 13px; overflow-x: auto; word-break: break-all; }
.pick-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
.pick {
  background: var(--card-dark);
  padding: 10px;
  border-radius: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}
.pick.bust { border-left: 3px solid var(--danger); }
.pick b { font-weight: 700; }
.pick .meta { color: var(--muted); font-size: 11px; }

/* Confirm dialog */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1100;
  padding: 16px;
}
.confirm-overlay.show { display: flex; }
.confirm-box {
  background: var(--card);
  border-radius: 16px;
  padding: 24px;
  max-width: 340px;
  text-align: center;
}
.confirm-box p { margin: 0 0 20px; font-size: 16px; }
.confirm-btns { display: flex; gap: 10px; }
.confirm-btns button { flex: 1; }

.hidden { display: none !important; }

/* Custom game builder */
.custom-builder { padding: 4px 0; }
.chip-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; max-height: 200px; overflow-y: auto; }
.chip {
  background: rgba(255,255,255,.08);
  border: 2px solid transparent;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: all .2s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.chip:hover { background: rgba(255,255,255,.12); }
.chip.selected { border-color: var(--accent); background: rgba(74,222,128,.15); }
.chip .flag { font-size: 14px; }
.chip .color-dot-sm { width: 10px; height: 10px; border-radius: 2px; }
.custom-preview {
  background: var(--card);
  border-radius: 10px;
  padding: 10px 14px;
  margin: 12px 0;
  font-size: 13px;
  color: var(--muted);
}
.custom-preview strong { color: var(--accent); }
.custom-warning { background: rgba(224,85,85,.15); border: 1px solid var(--danger); border-radius: 8px; padding: 8px 12px; margin: 8px 0; font-size: 12px; color: var(--danger); }
.chip-action { background: none; border: none; color: var(--muted); font-size: 11px; cursor: pointer; padding: 2px 6px; margin-left: 8px; text-decoration: underline; }
.chip-action:hover { color: var(--accent); }

/* Session stats bar */
.session-bar {
  background: var(--card-dark);
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
}
.session-stat-item { text-align: center; }
.session-stat-item .label { color: var(--muted); font-size: 10px; text-transform: uppercase; }
.session-stat-item .value { font-weight: 700; font-size: 16px; }
.session-stat-item .value.wins { color: var(--accent); }
.session-stat-item .value.busts { color: var(--danger); }
</style>
</head>
<body>

<!-- SETUP CARD -->
<div class="card" id="setupCard">
  <!-- Step 1: Game Mode Selection -->
  <div id="step1">
    <h2>Football 501</h2>
    <p class="subtitle">Guess players, subtract their stats, hit exactly 0 to win!</p>
    <div class="field">
      <label>Choose game mode</label>
    </div>
    <div class="row-btns" style="margin-top: 8px;">
      <button class="btn-primary" id="singlePlayerBtn">Single Player</button>
      <button class="btn-secondary" id="multiplayerBtn">Multiplayer</button>
    </div>
  </div>

  <!-- Step 1b: Multiplayer count -->
  <div id="step1b" class="hidden">
    <button class="btn-back" id="backToStep1Mode">‚Üê Back</button>
    <h2>Multiplayer</h2>
    <p class="subtitle">Select number of players</p>
    <div class="field">
      <label>Number of players</label>
      <select id="numPlayers">
        <option value="2" selected>2 Players</option>
        <option value="3">3 Players</option>
        <option value="4">4 Players</option>
        <option value="5">5 Players</option>
        <option value="6">6 Players</option>
      </select>
    </div>
    <button class="btn-primary" id="toStep2">Continue</button>
  </div>

  <!-- Step 2: Player names -->
  <div id="step2" class="hidden">
    <button class="btn-back" id="backToStep1">‚Üê Back</button>
    <h2>Player Names</h2>
    <div id="nameFields"></div>
    <button class="btn-primary" id="toStep3">Continue</button>
  </div>

  <!-- Step 3: Choose category -->
  <div id="step3" class="hidden">
    <button class="btn-back" id="backToStep2">‚Üê Back</button>
    <h2>Choose Category</h2>
    <p class="subtitle">Select a game mode to start</p>

    <div class="section" id="sec-country">
      <div class="section-header" onclick="toggleSection('sec-country')">
        <div class="section-title">Countries <span class="section-count" id="countCountry">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Player appearances by country in Premier League history (up to 2024/25 season).<br><span style="color:var(--gold)">‚òÖ</span> difficulty: more stars = harder (smaller player pool)</div>
      <div class="section-body" id="countryGames"></div>
    </div>

    <div class="section" id="sec-continent">
      <div class="section-header" onclick="toggleSection('sec-continent')">
        <div class="section-title">Continents <span class="section-count" id="countContinent">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Player appearances grouped by continental region (up to 2024/25 season).<br><span style="color:var(--gold)">‚òÖ</span> difficulty: more stars = harder (smaller player pool)</div>
      <div class="section-body" id="continentGames"></div>
    </div>

    <div class="section" id="sec-club">
      <div class="section-header" onclick="toggleSection('sec-club')">
        <div class="section-title">Clubs (Apps) <span class="section-count" id="countClub">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Player appearances for each club in Premier League history (up to 2024/25 season).<br><span style="color:var(--gold)">‚òÖ</span> difficulty: more stars = harder (smaller player pool)</div>
      <div class="section-body" id="clubGames"></div>
    </div>

    <div class="section" id="sec-goals">
      <div class="section-header" onclick="toggleSection('sec-goals')">
        <div class="section-title">Goals <span class="section-count" id="countGoals">(0)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Total Premier League goals (overall and by club) (up to 2024/25 season).<br><span style="color:var(--gold)">‚òÖ</span> difficulty: more stars = harder (smaller player pool)</div>
      <div class="section-body" id="goalsGames"></div>
    </div>

    <div class="section" id="sec-custom">
      <div class="section-header" onclick="toggleSection('sec-custom')">
        <div class="section-title">üéÆ Custom Game <span class="section-count">(Build Your Own)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Create your own game by selecting a metric and filters. Use both for intersection.</div>
      <div class="section-body" id="customBuilder">
        <div class="custom-builder">
          <div class="field">
            <label>Metric to subtract</label>
            <select id="customMetric">
              <option value="apps" selected>Appearances</option>
              <option value="goals">Goals</option>
            </select>
          </div>
          <div class="field" id="nationalityFilterField">
            <label>Filter by nationality (optional, max 5) <button type="button" class="chip-action" id="clearNats">Clear</button></label>
            <div class="chip-grid" id="nationalityChips"></div>
          </div>
          <div class="field" id="clubFilterField">
            <label>Filter by club (optional, max 5) <button type="button" class="chip-action" id="clearClubs">Clear</button></label>
            <div class="chip-grid" id="clubChips"></div>
          </div>
          <div id="customPreview" class="custom-preview hidden">
            <span id="customPreviewText"></span>
          </div>
          <div id="customWarning" class="custom-warning hidden"></div>
          <button class="btn-primary" id="startCustomGame">Start Custom Game</button>
        </div>
      </div>
    </div>

    <div class="section disabled" id="sec-positions">
      <div class="section-header">
        <div class="section-title">Positions <span class="section-count">(Coming Soon)</span></div>
        <div class="chev">‚ñº</div>
      </div>
      <div class="section-desc">Coming soon ‚Äî requires position data.</div>
      <div class="section-body">
        <div class="disabled-note">Position data not yet available. Check back soon!</div>
      </div>
    </div>
  </div>

  <!-- Loading screen with trivia -->
  <div id="loadingScreen" class="hidden loading-screen">
    <button class="btn-back" id="backFromLoading">‚Üê Back</button>
    <div class="loading-spinner-wrap">
      <div class="loading-spinner" id="loadingSpinner"></div>
    </div>
    <div class="loading-text" id="loadingText">Loading match data...</div>
    <div id="readyBadge" class="ready-badge hidden">Game Ready!</div>
    <div id="triviaContainer"></div>
    <button id="skipTrivia" class="btn-primary hidden" style="margin-top:16px">Start Match ‚Üí</button>
    <div id="triviaNote" class="trivia-note hidden">Trivia is optional ‚Äî tap Start Match to begin</div>
  </div>

  <!-- Order reveal -->
  <div id="orderScreen" class="hidden order-reveal">
    <h2>Turn Order</h2>
    <div id="orderList" class="order-list"></div>
    <button id="beginMatch" class="btn-primary">Start Match</button>
  </div>
</div>

<!-- GAMEPLAY CARD -->
<div class="card hidden" id="playCard">
  <div id="sessionBar" class="session-bar hidden">
    <div class="session-stat-item">
      <div class="label">Games</div>
      <div class="value" id="sessionGames">0</div>
    </div>
    <div class="session-stat-item">
      <div class="label">Wins</div>
      <div class="value wins" id="sessionWins">0</div>
    </div>
    <div class="session-stat-item">
      <div class="label">Busts</div>
      <div class="value busts" id="sessionBusts">0</div>
    </div>
    <div class="session-stat-item">
      <div class="label">Picks</div>
      <div class="value" id="sessionPicks">0</div>
    </div>
    <div class="session-stat-item">
      <div class="label">Total</div>
      <div class="value" id="sessionTotal">0</div>
    </div>
  </div>
  <div id="scoreGrid" class="scores p2"></div>
  <div id="turnInfo" class="turn-info"></div>
  <div id="hintBar" class="hint-bar hidden">
    <span class="hint-text" id="hintText"></span>
    <button class="coverage-btn" id="coverageBtn" title="Coverage" aria-label="Coverage">?</button>
  </div>

  <div class="field">
    <label id="guessLabel">Your guess</label>
    <input id="guess" type="text" placeholder="Type a player name..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
  </div>

  <div id="selectionList" class="selection-list hidden"></div>

  <div class="row-btns">
    <button id="submitBtn" class="btn-primary" disabled>Submit</button>
    <button id="endBtn" class="btn-text">End Game</button>
  </div>

  <div id="result" class="result"></div>
  <div id="inlineToast" class="inline-toast"></div>
</div>

<!-- Effect Overlay -->
<div id="effectOverlay" class="effect-overlay">
  <div id="effectText" class="effect-text"></div>
</div>

<!-- Progress Modal -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="modal" class="modal">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Progress</div>
      <button id="closeModal" class="close-btn">Close</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Score chain</div>
    <div id="chain" class="chain">501</div>
    <div id="pickList" class="pick-list"></div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-box">
    <p id="confirmText">End this game?</p>
    <div class="confirm-btns">
      <button id="confirmNo" class="btn-secondary">Cancel</button>
      <button id="confirmYes" class="btn-danger">End Game</button>
    </div>
  </div>
</div>

<!-- Coverage Modal -->
<div id="coverageBackdrop" class="modal-backdrop">
  <div id="coverageModal" class="modal coverage-modal">
    <div class="modal-header">
      <div class="modal-title">Pick Distribution</div>
      <button id="closeCoverage" class="close-btn">Close</button>
    </div>
    <div id="coverageContent"></div>
  </div>
</div>

<script>
// ============== CONFIGURATION ==============
const API_BASE = '/.netlify/functions';
const CACHE_TTL = 90 * 60 * 1000; // 90 minutes
const DEBOUNCE_MS = 300;

// ============== CATEGORIES (must match backend) ==============
// Sorted alphabetically by title
const CATEGORIES = {
  country: [
    { id: 'country_ARG', title: 'Argentina', flag: 'üá¶üá∑' },
    { id: 'country_BEL', title: 'Belgium', flag: 'üáßüá™' },
    { id: 'country_DEN', title: 'Denmark', flag: 'üá©üá∞' },
    { id: 'country_FRA', title: 'France', flag: 'üá´üá∑' },
    { id: 'country_GER', title: 'Germany', flag: 'üá©üá™' },
    { id: 'country_IRL', title: 'Ireland', flag: 'üáÆüá™' },
    { id: 'country_NED', title: 'Netherlands', flag: 'üá≥üá±' },
    { id: 'country_NIR', title: 'N. Ireland', flag: 'üá¨üáß' },
    { id: 'country_NOR', title: 'Norway', flag: 'üá≥üá¥' },
    { id: 'country_POR', title: 'Portugal', flag: 'üáµüáπ' },
    { id: 'country_SCO', title: 'Scotland', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø' },
    { id: 'country_ESP', title: 'Spain', flag: 'üá™üá∏' },
    { id: 'country_WAL', title: 'Wales', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø' },
  ],
  continent: [
    { id: 'continent_AFRICA', title: 'Africa', flag: 'üåç' },
    { id: 'continent_ASIA_OCEANIA', title: 'Asia & Oceania', flag: 'üåè' },
    { id: 'continent_CONCACAF', title: 'CONCACAF', flag: 'üåé' },
    { id: 'continent_SOUTH_AMERICA', title: 'South America (excl. BRA/ARG)', flag: 'üåé' },
  ],
  club: [
    { id: 'club_Arsenal', title: 'Arsenal', color: '#EF0107' },
    { id: 'club_AstonVilla', title: 'Aston Villa', color: '#670E36' },
    { id: 'club_Blackburn', title: 'Blackburn', color: '#009EE0' },
    { id: 'club_Bolton', title: 'Bolton', color: '#263C7F' },
    { id: 'club_Bournemouth', title: 'Bournemouth', color: '#DA291C' },
    { id: 'club_Brighton', title: 'Brighton', color: '#0057B8' },
    { id: 'club_Burnley', title: 'Burnley', color: '#6C1D45' },
    { id: 'club_Charlton', title: 'Charlton', color: '#D4021D' },
    { id: 'club_Chelsea', title: 'Chelsea', color: '#034694' },
    { id: 'club_Coventry', title: 'Coventry', color: '#27A9E1' },
    { id: 'club_CrystalPalace', title: 'Crystal Palace', color: '#1B458F' },
    { id: 'club_Everton', title: 'Everton', color: '#003399' },
    { id: 'club_Fulham', title: 'Fulham', color: '#000000' },
    { id: 'club_Leeds', title: 'Leeds', color: '#FFCD00' },
    { id: 'club_Leicester', title: 'Leicester', color: '#003090' },
    { id: 'club_Liverpool', title: 'Liverpool', color: '#C8102E' },
    { id: 'club_ManCity', title: 'Man City', color: '#6CABDD' },
    { id: 'club_ManUtd', title: 'Man Utd', color: '#DA291C' },
    { id: 'club_Middlesbrough', title: 'Middlesbrough', color: '#E11B22' },
    { id: 'club_Newcastle', title: 'Newcastle', color: '#241F20' },
    { id: 'club_Norwich', title: 'Norwich', color: '#00A650' },
    { id: 'club_NottmForest', title: 'Nottm Forest', color: '#DD0000' },
    { id: 'club_Southampton', title: 'Southampton', color: '#D71920' },
    { id: 'club_Stoke', title: 'Stoke', color: '#E03A3E' },
    { id: 'club_Tottenham', title: 'Spurs', color: '#132257' },
    { id: 'club_Sunderland', title: 'Sunderland', color: '#EB172B' },
    { id: 'club_Watford', title: 'Watford', color: '#FBEC5D' },
    { id: 'club_WestBrom', title: 'West Brom', color: '#122F67' },
    { id: 'club_WestHam', title: 'West Ham', color: '#7A263A' },
    { id: 'club_Wigan', title: 'Wigan', color: '#0033A0' },
    { id: 'club_Wimbledon', title: 'Wimbledon', color: '#00008B' },
    { id: 'club_Wolves', title: 'Wolves', color: '#FDB913' },
  ],
  goals: [
    { id: 'goals_overall', title: 'All EPL Goals', flag: '‚öΩ' },
    { id: 'goals_Arsenal', title: 'Arsenal Goals', color: '#EF0107' },
    { id: 'goals_Chelsea', title: 'Chelsea Goals', color: '#034694' },
    { id: 'goals_Liverpool', title: 'Liverpool Goals', color: '#C8102E' },
    { id: 'goals_ManCity', title: 'Man City Goals', color: '#6CABDD' },
    { id: 'goals_ManUtd', title: 'Man Utd Goals', color: '#DA291C' },
    { id: 'goals_Tottenham', title: 'Spurs Goals', color: '#132257' },
  ],
};

// ============== STATE ==============
let state = null;
let eligiblePlayers = [];
let currentCategory = null;
let currentMeta = null;
let triviaData = [];
let triviaIndex = 0;
let matchDataReady = false;
let debounceTimer = null;

// Session stats (persists across games in same session)
let sessionStats = {
  games: 0,
  wins: 0,
  busts: 0,
  picks: 0,
  totalValue: 0,
};

// Fallback trivia questions when API doesn't return any
const FALLBACK_TRIVIA = [
  {
    q: "Which player has the most Premier League appearances of all time?",
    options: ["Ryan Giggs", "Gareth Barry", "Frank Lampard", "James Milner"],
    answer: 1
  },
  {
    q: "Who holds the record for most Premier League goals?",
    options: ["Wayne Rooney", "Andrew Cole", "Alan Shearer", "Sergio Ag√ºero"],
    answer: 2
  },
  {
    q: "Which club won the first Premier League title in 1992-93?",
    options: ["Arsenal", "Liverpool", "Manchester United", "Blackburn"],
    answer: 2
  },
  {
    q: "How many teams competed in the original 1992 Premier League?",
    options: ["18", "20", "22", "24"],
    answer: 2
  },
  {
    q: "Which goalkeeper has kept the most Premier League clean sheets?",
    options: ["David Seaman", "Peter Schmeichel", "Petr ƒåech", "Edwin van der Sar"],
    answer: 2
  }
];

// ============== UTILITIES ==============
function $(id) { return document.getElementById(id); }
function show(id) { $(id)?.classList.remove('hidden'); }
function hide(id) { $(id)?.classList.add('hidden'); }

function normalize(s) {
  return String(s || '').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9\s.-]/g, '').trim();
}

function levenshtein(a, b) {
  const m = a.length, n = b.length;
  if (!m) return n;
  if (!n) return m;
  const d = Array.from({ length: m + 1 }, (_, i) => Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) d[i][0] = i;
  for (let j = 0; j <= n; j++) d[0][j] = j;
  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
    }
  }
  return d[m][n];
}

function similarity(a, b) {
  const na = normalize(a), nb = normalize(b);
  if (!na || !nb) return 0;
  return 1 - (levenshtein(na, nb) / Math.max(na.length, nb.length));
}

function formatNum(n) {
  return Number(n || 0).toLocaleString('en-GB');
}

function updateSessionUI() {
  $('sessionGames').textContent = sessionStats.games;
  $('sessionWins').textContent = sessionStats.wins;
  $('sessionBusts').textContent = sessionStats.busts;
  $('sessionPicks').textContent = sessionStats.picks;
  $('sessionTotal').textContent = formatNum(sessionStats.totalValue);

  // Show session bar after first game completes
  if (sessionStats.games > 0) {
    $('sessionBar').classList.remove('hidden');
  }
}

function recordPick(value, isBust) {
  sessionStats.picks++;
  if (!isBust) {
    sessionStats.totalValue += value;
  }
  if (isBust) {
    sessionStats.busts++;
  }
  updateSessionUI();
}

function recordWin() {
  sessionStats.wins++;
  sessionStats.games++;
  updateSessionUI();
}

function recordGameEnd() {
  // Called when game ends without a win (end game button)
  sessionStats.games++;
  updateSessionUI();
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

// ============== CACHING ==============
function getCacheKey(categoryId) {
  return `f501_${categoryId}`;
}

function getCachedData(categoryId) {
  const key = getCacheKey(categoryId);
  const tsKey = `${key}_ts`;
  const cached = localStorage.getItem(key);
  const ts = parseInt(localStorage.getItem(tsKey) || '0', 10);
  if (cached && (Date.now() - ts) < CACHE_TTL) {
    try {
      const data = JSON.parse(cached);
      // Cache bust: if cached data has 0 players, force refetch
      if (!data.eligiblePlayers || data.eligiblePlayers.length === 0) {
        console.log('[cache] Busting cache for', categoryId, '- had 0 players');
        localStorage.removeItem(key);
        localStorage.removeItem(tsKey);
        return null;
      }
      return data;
    } catch { }
  }
  return null;
}

function setCachedData(categoryId, data) {
  const key = getCacheKey(categoryId);
  localStorage.setItem(key, JSON.stringify(data));
  localStorage.setItem(`${key}_ts`, String(Date.now()));
}

// ============== SETUP FLOW ==============

// Single Player: skip directly to categories
$('singlePlayerBtn').onclick = () => {
  window.gameSetup = { names: ['You'], isSinglePlayer: true };
  buildCategorySections();
  hide('step1');
  show('step3');
};

// Multiplayer: go to player count selection
$('multiplayerBtn').onclick = () => {
  hide('step1');
  show('step1b');
};

$('backToStep1Mode').onclick = () => {
  hide('step1b');
  show('step1');
};

$('toStep2').onclick = () => {
  const n = parseInt($('numPlayers').value, 10);
  const wrap = $('nameFields');
  wrap.innerHTML = '';
  for (let i = 1; i <= n; i++) {
    const div = document.createElement('div');
    div.className = 'field';
    div.innerHTML = `<label>Player ${i}</label><input id="pname${i}" type="text" placeholder="Enter name" autocomplete="off"/>`;
    wrap.appendChild(div);
  }
  hide('step1b');
  show('step2');
  $('pname1')?.focus();
};

$('backToStep1').onclick = () => {
  hide('step2');
  show('step1b');
};

$('toStep3').onclick = () => {
  const n = parseInt($('numPlayers').value, 10);
  const names = [];
  for (let i = 1; i <= n; i++) {
    const val = $(`pname${i}`)?.value?.trim() || `Player ${i}`;
    names.push(val);
  }
  window.gameSetup = { names };
  buildCategorySections();
  hide('step2');
  show('step3');
};

$('backToStep2').onclick = () => {
  hide('step3');
  show('step2');
};

$('backFromLoading').onclick = () => {
  hide('loadingScreen');
  show('step3');
  matchDataReady = false;
  // Reset loading screen state
  $('loadingSpinner').classList.remove('ready');
  $('loadingSpinner').style.animation = '';
  $('loadingText').textContent = 'Loading match data...';
  $('loadingText').classList.remove('ready');
  hide('readyBadge');
  hide('skipTrivia');
  hide('triviaNote');
};

function toggleSection(id) {
  const sec = $(id);
  if (sec.classList.contains('disabled')) return;
  sec.classList.toggle('open');
}

function buildCategorySections() {
  buildSection('countryGames', CATEGORIES.country, 'countCountry');
  buildSection('continentGames', CATEGORIES.continent, 'countContinent');
  buildSection('clubGames', CATEGORIES.club, 'countClub');
  buildSection('goalsGames', CATEGORIES.goals, 'countGoals');
}

function buildSection(containerId, list, countId) {
  const cont = $(containerId);
  cont.innerHTML = '';
  $(countId).textContent = `(${list.length})`;

  list.forEach(cat => {
    const card = document.createElement('div');
    card.className = 'game-card';
    // Use color dot for clubs, flag emoji for others
    const iconHtml = cat.color
      ? `<div class="color-dot" style="background:${cat.color}"></div>`
      : `<span class="flag">${cat.flag}</span>`;
    card.innerHTML = `
      <div style="display:flex;align-items:center">
        ${iconHtml}
        <div>
          <div class="title">${cat.title}</div>
          <div class="meta" id="meta-${cat.id}">Loading...</div>
        </div>
      </div>
      <div class="arrow">‚Üí</div>
    `;
    card.onclick = () => chooseCategory(cat);
    cont.appendChild(card);
    preloadCategoryStats(cat);
  });
}

async function preloadCategoryStats(cat) {
  const metaEl = $(`meta-${cat.id}`);
  if (!metaEl) return;

  const cached = getCachedData(cat.id);
  if (cached) {
    const count = cached.eligiblePlayers?.length || 0;
    const metric = cached.meta?.metricLabel || 'Apps';
    const diff = getDifficulty(count);
    metaEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5 - diff)}</span> ${formatNum(count)} players`;
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/match_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ categoryId: cat.id }),
    });
    const data = await res.json();
    if (data.eligiblePlayers) {
      setCachedData(cat.id, data);
      const count = data.eligiblePlayers.length;
      const diff = getDifficulty(count);
      metaEl.innerHTML = `<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5 - diff)}</span> ${formatNum(count)} players`;
    }
  } catch {
    metaEl.textContent = '‚Äî';
  }
}

function getDifficulty(count) {
  if (count >= 400) return 1;
  if (count >= 250) return 2;
  if (count >= 150) return 3;
  if (count >= 100) return 4;
  return 5;
}

// ============== CATEGORY SELECTION & LOADING ==============
async function chooseCategory(cat) {
  currentCategory = cat;
  matchDataReady = false;
  triviaIndex = 0;

  hide('step3');
  show('loadingScreen');
  hide('readyBadge');
  hide('skipTrivia');
  $('triviaContainer').innerHTML = '';

  const cached = getCachedData(cat.id);
  if (cached) {
    eligiblePlayers = cached.eligiblePlayers || [];
    currentMeta = cached.meta || {};
    triviaData = cached.meta?.trivia || [];
    matchDataReady = true;
    showReadyState();
    showTrivia();
    return;
  }

  const fetchPromise = (async () => {
    try {
      const res = await fetch(`${API_BASE}/match_start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categoryId: cat.id }),
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      setCachedData(cat.id, data);
      eligiblePlayers = data.eligiblePlayers || [];
      currentMeta = data.meta || {};
      triviaData = data.meta?.trivia || [];
      matchDataReady = true;
      showReadyState();
    } catch (err) {
      alert('Failed to load: ' + err.message);
      show('step3');
      hide('loadingScreen');
    }
  })();

  await sleep(500);
  showTrivia();
  await fetchPromise;
}

function showReadyState() {
  // Stop spinner and show ready state
  const spinner = $('loadingSpinner');
  spinner.classList.add('ready');
  spinner.style.animation = 'none';

  $('loadingText').textContent = 'Ready to play!';
  $('loadingText').classList.add('ready');

  show('readyBadge');
  show('skipTrivia');
  show('triviaNote');
  $('skipTrivia').textContent = 'Start Match ‚Üí';
}

function showTrivia() {
  // If no trivia from API, use fallback
  if (!triviaData.length) {
    triviaData = [FALLBACK_TRIVIA[Math.floor(Math.random() * FALLBACK_TRIVIA.length)]];
  }

  if (triviaIndex >= triviaData.length) {
    if (matchDataReady) proceedToOrderReveal();
    return;
  }

  const q = triviaData[triviaIndex];
  const container = $('triviaContainer');
  container.innerHTML = `
    <div class="trivia-box">
      <div class="trivia-q">${q.q}</div>
      <div class="trivia-opts">
        ${q.options.map((opt, i) => `<div class="trivia-opt" data-idx="${i}">${opt}</div>`).join('')}
      </div>
    </div>
  `;

  container.querySelectorAll('.trivia-opt').forEach(el => {
    el.onclick = () => handleTriviaAnswer(parseInt(el.dataset.idx, 10), q.answer);
  });
}

function handleTriviaAnswer(selected, correct) {
  const opts = $('triviaContainer').querySelectorAll('.trivia-opt');
  opts.forEach((el, i) => {
    el.onclick = null;
    if (i === correct) el.classList.add('correct');
    else if (i === selected) el.classList.add('wrong');
  });

  setTimeout(() => {
    triviaIndex++;
    showTrivia();
  }, 1200);
}

$('skipTrivia').onclick = () => {
  if (matchDataReady) proceedToOrderReveal();
};

// ============== ORDER REVEAL ==============
async function proceedToOrderReveal() {
  hide('loadingScreen');
  show('orderScreen');

  const names = [...(window.gameSetup?.names || ['Player 1', 'Player 2'])];

  const orderEl = $('orderList');
  for (let i = 0; i < 8; i++) {
    names.sort(() => Math.random() - 0.5);
    orderEl.innerHTML = names.map((n, i) => `<div>${i + 1}. ${n}</div>`).join('');
    await sleep(100);
  }
  names.sort(() => Math.random() - 0.5);
  orderEl.innerHTML = names.map((n, i) => `<div><strong>${i + 1}.</strong> ${n}</div>`).join('');

  window.gameSetup.orderedNames = names;
}

$('beginMatch').onclick = () => {
  const names = window.gameSetup?.orderedNames || window.gameSetup?.names || ['Player 1', 'Player 2'];
  startMatch(names);
};

// ============== MATCH START ==============
function startMatch(names) {
  // Ensure clean UI state before starting
  closeAllModals();
  $('guess').value = '';
  $('submitBtn').disabled = true;
  $('result').textContent = '';
  $('selectionList').innerHTML = '';
  $('selectionList').classList.add('hidden');
  $('inlineToast').classList.remove('show', 'bust-effect', 'win-effect');
  $('inlineToast').innerHTML = '';

  const metricLabel = currentMeta?.metricLabel || 'Apps';
  $('guessLabel').textContent = `Your guess (‚àí${metricLabel})`;

  state = {
    players: names,
    scores: Array(names.length).fill(501),
    turn: 0,
    turnCount: 1,
    used: new Set(),
    retry: false,
    historyScores: names.map(() => [501]),
    picks: names.map(() => []),
  };

  hide('setupCard');
  show('playCard');

  // Show session bar if there are previous games
  if (sessionStats.games > 0) {
    $('sessionBar').classList.remove('hidden');
  }

  const grid = $('scoreGrid');
  grid.className = `scores p${names.length}`;

  renderScoreboard();
  updateTurnUI();
  $('guess').focus();
}

// ============== SCOREBOARD ==============
function renderScoreboard() {
  const grid = $('scoreGrid');
  grid.innerHTML = '';
  state.players.forEach((name, idx) => {
    const pill = document.createElement('div');
    pill.className = 'pill' + (idx === state.turn ? ' active' : '');
    pill.id = `pill_${idx}`;
    pill.innerHTML = `<div class="name">${name}</div><div class="score" id="score_${idx}">${state.scores[idx]}</div>`;
    pill.onclick = () => openProgressModal(idx);
    grid.appendChild(pill);
  });
}

function updateTurnUI() {
  $('turnInfo').innerHTML = `<span style="color:var(--accent)">Turn ${state.turnCount}</span> &nbsp;‚Äî&nbsp; ${state.players[state.turn]}'s turn`;
  document.querySelectorAll('.pill').forEach((el, i) => {
    el.classList.toggle('active', i === state.turn);
  });
  updateHintBar();
}

function updateHintBar() {
  const hintBar = $('hintBar');
  const hintText = $('hintText');
  const remaining = state.scores[state.turn];

  if (remaining <= 0 || eligiblePlayers.length === 0) {
    hintBar.classList.add('hidden');
    return;
  }

  const available = eligiblePlayers.filter(p => !state.used.has(p.normalized));
  const direct = available.filter(p => p.subtractValue === remaining).length;

  const freq = new Map();
  for (const p of available) {
    const v = p.subtractValue;
    if (v > 0 && v <= remaining) {
      freq.set(v, (freq.get(v) || 0) + 1);
    }
  }
  let pairs = 0;
  for (const [m, c] of freq.entries()) {
    const n = remaining - m;
    if (n < m) continue;
    if (!freq.has(n)) continue;
    pairs += (n === m) ? c * (c - 1) / 2 : c * freq.get(n);
  }

  hintText.innerHTML = `Checkout: <strong>${direct || 'no'}</strong> direct ‚Ä¢ <strong>${pairs > 10 ? '>10' : pairs}</strong> two-player combos`;
  hintBar.classList.remove('hidden');
}

// ============== COVERAGE MODAL ==============
const COVERAGE_BUCKETS = [
  { min: 1, max: 10, label: '1‚Äì10' },
  { min: 11, max: 25, label: '11‚Äì25' },
  { min: 26, max: 50, label: '26‚Äì50' },
  { min: 51, max: 100, label: '51‚Äì100' },
  { min: 101, max: 200, label: '101‚Äì200' },
  { min: 201, max: 300, label: '201‚Äì300' },
  { min: 301, max: Infinity, label: '301+' },
];

function openCoverageModal() {
  const available = eligiblePlayers.filter(p => !state.used.has(p.normalized));
  const remaining = state.scores[state.turn];

  // Calculate bucket counts
  const buckets = COVERAGE_BUCKETS.map(b => ({
    ...b,
    count: available.filter(p => p.subtractValue >= b.min && p.subtractValue <= b.max).length,
  }));

  const maxCount = Math.max(...buckets.map(b => b.count), 1);
  const direct = available.filter(p => p.subtractValue === remaining).length;
  const smallest = available.length ? Math.min(...available.map(p => p.subtractValue)) : 0;
  const largest = available.length ? Math.max(...available.map(p => p.subtractValue)) : 0;

  const metricLabel = currentMeta?.metricLabel || 'Apps';

  const content = $('coverageContent');
  content.innerHTML = `
    <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
      ${formatNum(available.length)} players remaining ‚Ä¢ ${metricLabel} distribution
    </div>
    <div class="coverage-grid">
      ${buckets.map(b => `
        <div class="coverage-row">
          <div class="coverage-label">${b.label}</div>
          <div class="coverage-bar-wrap">
            <div class="coverage-bar" style="width:${(b.count / maxCount) * 100}%"></div>
          </div>
          <div class="coverage-count">${b.count}</div>
        </div>
      `).join('')}
    </div>
    <div class="coverage-stats">
      <div class="coverage-stat">
        <div class="label">Direct</div>
        <div class="value" style="color:var(--accent)">${direct}</div>
      </div>
      <div class="coverage-stat">
        <div class="label">Smallest</div>
        <div class="value">${formatNum(smallest)}</div>
      </div>
      <div class="coverage-stat">
        <div class="label">Largest</div>
        <div class="value">${formatNum(largest)}</div>
      </div>
    </div>
  `;

  $('coverageBackdrop').classList.add('show');
  requestAnimationFrame(() => $('coverageModal').classList.add('show'));
}

function closeCoverageModal() {
  $('coverageModal').classList.remove('show');
  setTimeout(() => $('coverageBackdrop').classList.remove('show'), 200);
}

$('coverageBtn').onclick = openCoverageModal;
$('closeCoverage').onclick = closeCoverageModal;
$('coverageBackdrop').onclick = (e) => {
  if (e.target.id === 'coverageBackdrop') closeCoverageModal();
};

// ============== INPUT HANDLING ==============
const guessInput = $('guess');
const submitBtn = $('submitBtn');

guessInput.oninput = () => {
  const val = guessInput.value.trim();
  submitBtn.disabled = !val;
  hideSelectionList();
  hideToast();

  clearTimeout(debounceTimer);
  if (val.length >= 2) {
    debounceTimer = setTimeout(() => showFuzzyMatches(val), DEBOUNCE_MS);
  }
};

guessInput.onkeydown = (e) => {
  if (e.key === 'Enter' && !submitBtn.disabled) {
    e.preventDefault();
    handleSubmit();
  }
};

submitBtn.onclick = handleSubmit;

function showFuzzyMatches(input) {
  const norm = normalize(input);
  if (norm.length < 2) return;

  // Include ALL players (used and available) for display
  const scored = eligiblePlayers.map(p => ({
    player: p,
    isUsed: state.used.has(p.normalized),
    score: p.normalized.includes(norm) ? 0.95 : similarity(p.normalized, norm),
    exactStart: p.normalized.startsWith(norm),
  }));

  const matches = scored
    .filter(m => m.score >= 0.5 || m.exactStart)
    .sort((a, b) => {
      // Sort by: available first, then by score
      if (a.isUsed !== b.isUsed) return a.isUsed ? 1 : -1;
      if (a.exactStart !== b.exactStart) return b.exactStart - a.exactStart;
      return b.score - a.score;
    })
    .slice(0, 6);

  if (matches.length === 0) return;

  // Check for exact match among available
  const exactAvailable = eligiblePlayers.find(p => p.normalized === norm && !state.used.has(p.normalized));
  if (exactAvailable) return;

  const list = $('selectionList');
  list.innerHTML = matches.map(m => `
    <div class="selection-item${m.isUsed ? ' used' : ''}" data-norm="${m.player.normalized}" data-used="${m.isUsed}">
      <div class="info">
        <div class="name">${m.player.name}</div>
        <div class="nat">${m.player.nationality}</div>
      </div>
      ${m.isUsed ? '<span class="used-badge">Used</span>' : ''}
    </div>
  `).join('');

  list.querySelectorAll('.selection-item').forEach(el => {
    el.onclick = () => {
      if (el.dataset.used === 'true') {
        setResult('‚ö†Ô∏è Already used this match!');
        return;
      }
      selectPlayer(el.dataset.norm);
    };
  });

  list.classList.remove('hidden');
}

function selectPlayer(normalized) {
  const player = eligiblePlayers.find(p => p.normalized === normalized);
  if (player) {
    guessInput.value = player.name;
    submitBtn.disabled = false;
    hideSelectionList();
    handleSubmit();
  }
}

function hideSelectionList() {
  $('selectionList').classList.add('hidden');
}

// ============== SUBMIT LOGIC ==============
async function handleSubmit() {
  const raw = guessInput.value.trim();
  if (!raw) return;

  submitBtn.disabled = true;
  hideSelectionList();

  const norm = normalize(raw);

  if (state.used.has(norm)) {
    if (!state.retry) {
      state.retry = true;
      setResult('‚ö†Ô∏è Already used. Try once more.');
      submitBtn.disabled = false;
      guessInput.select();
      return;
    }
    state.retry = false;
    setResult('‚ùå Duplicate. Turn passes.');
    nextTurn();
    return;
  }

  const available = eligiblePlayers.filter(p => !state.used.has(p.normalized));

  let match = available.find(p => p.normalized === norm);

  if (!match) {
    match = available.find(p => p.normalized.includes(norm));
  }

  if (!match) {
    let best = null;
    let bestScore = 0;
    for (const p of available) {
      const s = similarity(p.normalized, norm);
      if (s > bestScore) {
        best = p;
        bestScore = s;
      }
    }
    if (best && bestScore >= 0.78) {
      match = best;
    }
  }

  if (!match) {
    if (!state.retry) {
      state.retry = true;
      setResult('‚ùå Not found. Try once more.');
      submitBtn.disabled = false;
      guessInput.select();
      return;
    }
    state.retry = false;
    setResult('‚ùå Not found. Turn passes.');
    nextTurn();
    return;
  }

  state.retry = false;

  if (state.used.has(match.normalized)) {
    setResult('‚ö†Ô∏è Already used. Turn passes.');
    nextTurn();
    return;
  }

  const before = state.scores[state.turn];
  const deduct = match.subtractValue;
  const after = before - deduct;

  let bust = false;
  let win = false;

  if (deduct === 0) {
    bust = true;
  } else if (after < 0) {
    bust = true;
  } else if (after === 0) {
    win = true;
  }

  const metricLabel = currentMeta?.metricLabel || 'Apps';

  state.picks[state.turn].unshift({
    name: match.name,
    value: deduct,
    from: before,
    to: bust ? before : after,
    bust,
  });

  if (bust) {
    setResult(`üí• Bust! ${match.name} has ${formatNum(deduct)} ${metricLabel.toLowerCase()}. Score stays ${formatNum(before)}.`);
    showToast(match, before, before, 'bust');
    showEffect('bust');
    recordPick(deduct, true);
    const pill = $(`pill_${state.turn}`);
    pill?.classList.add('bust-anim');
    setTimeout(() => pill?.classList.remove('bust-anim'), 500);
  } else {
    state.scores[state.turn] = after;
    state.historyScores[state.turn].push(after);
    state.used.add(match.normalized);

    animateScore(state.turn, before, after);

    recordPick(deduct, false);

    if (win) {
      const winnerName = state.players[state.turn];
      const turnsText = state.turnCount === 1 ? '1 turn' : `${state.turnCount} turns`;
      setResult(`üéØ ${winnerName} wins with ${match.name} (${formatNum(deduct)})!`);
      showToast(match, before, after, 'win');
      showEffect('win');
      recordWin();
      const pill = $(`pill_${state.turn}`);
      pill?.classList.add('win-anim');
      setTimeout(() => {
        if (confirm(`üèÜ ${winnerName} wins in ${turnsText}! Play again?`)) {
          playAgain();
        }
      }, 1500);
      return;
    } else {
      setResult(`‚úÖ ${match.name}: ‚àí${formatNum(deduct)}`);
      showToast(match, before, after, 'normal');
    }
  }

  nextTurn();
}

function nextTurn() {
  guessInput.value = '';
  submitBtn.disabled = true;
  state.turn = (state.turn + 1) % state.players.length;
  state.turnCount++;
  renderScoreboard();
  updateTurnUI();
  guessInput.focus();
}

function setResult(msg) {
  $('result').textContent = msg;
}

// ============== EFFECT OVERLAY ==============
function showEffect(type) {
  const overlay = $('effectOverlay');
  const text = $('effectText');
  text.className = 'effect-text ' + type;
  text.textContent = type === 'bust' ? 'BUST!' : 'CHECKOUT!';
  overlay.classList.add('show');
  setTimeout(() => overlay.classList.remove('show'), 600);
}

// ============== TOAST ==============
let toastTimer = null;

function showToast(player, before, after, type) {
  const toast = $('inlineToast');
  const o = player.overlay || {};
  const metricLabel = currentMeta?.metricLabel || 'Apps';

  // Build clubs display
  let clubsHtml = '';
  if (player.clubs && player.clubs.length > 0) {
    const displayClubs = player.clubs.slice(0, 3);
    const moreCount = player.clubCount - 3;
    clubsHtml = `<div class="toast-clubs">Clubs: ${displayClubs.join(', ')}${moreCount > 0 ? ` +${moreCount} more` : ''}</div>`;
  }

  // Build seasons display
  let seasonsHtml = '';
  if (player.seasonsCount) {
    seasonsHtml = `<span>Seasons: ${player.seasonsCount}</span>`;
  }

  let badgeClass = '';
  let badgeContent = '-' + formatNum(player.subtractValue);
  if (type === 'bust') {
    badgeClass = ' bust';
    badgeContent = 'üí•';
  } else if (type === 'win') {
    badgeClass = ' win';
    badgeContent = 'üéØ';
  }

  toast.className = 'inline-toast';
  if (type === 'bust') toast.classList.add('bust-effect');
  if (type === 'win') toast.classList.add('win-effect');

  toast.innerHTML = `
    <div class="toast-row">
      <div class="toast-badge${badgeClass}">${badgeContent}</div>
      <div class="toast-body">
        <div class="toast-title">${player.name}</div>
        <div class="toast-sub">${formatNum(before)} ‚Üí ${formatNum(after)}</div>
        ${clubsHtml}
        <div class="toast-meta">
          <span>${metricLabel} ${formatNum(o[currentMeta?.metric === 'goals_total' ? 'goals' : 'apps'] || player.subtractValue)}</span>
          ${o.goals && currentMeta?.metric !== 'goals_total' ? `<span>Goals ${formatNum(o.goals)}</span>` : ''}
          ${o.starts ? `<span>Starts ${formatNum(o.starts)}</span>` : ''}
          ${seasonsHtml}
        </div>
      </div>
    </div>
  `;
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 6000);
}

function hideToast() {
  $('inlineToast').classList.remove('show');
}

// ============== SCORE ANIMATION ==============
function animateScore(idx, from, to) {
  const el = $(`score_${idx}`);
  if (!el) return;
  const start = performance.now();
  const duration = 800;
  const diff = to - from;

  function step(time) {
    const progress = Math.min(1, (time - start) / duration);
    const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
    el.textContent = Math.round(from + diff * ease);
    if (progress < 1) {
      requestAnimationFrame(step);
    } else {
      el.textContent = to;
    }
  }
  requestAnimationFrame(step);
}

// ============== PROGRESS MODAL ==============
function openProgressModal(idx) {
  $('modalTitle').textContent = `${state.players[idx]} ‚Äî Progress`;
  $('chain').textContent = state.historyScores[idx].join(' ‚Üí ');

  const picks = state.picks[idx];
  const metricLabel = currentMeta?.metricLabel || 'Apps';
  if (picks.length === 0) {
    $('pickList').innerHTML = '<div class="pick"><div>No picks yet</div></div>';
  } else {
    $('pickList').innerHTML = picks.slice(0, 15).map(p => `
      <div class="pick${p.bust ? ' bust' : ''}">
        <div><b>${p.name}</b> <span class="meta">-${formatNum(p.value)}</span></div>
        <div class="meta">${formatNum(p.from)} ‚Üí ${formatNum(p.to)}${p.bust ? ' (bust)' : ''}</div>
      </div>
    `).join('');
  }

  $('modalBackdrop').classList.add('show');
  requestAnimationFrame(() => $('modal').classList.add('show'));
}

function closeModal() {
  $('modal').classList.remove('show');
  setTimeout(() => $('modalBackdrop').classList.remove('show'), 200);
}

$('closeModal').onclick = closeModal;
$('modalBackdrop').onclick = (e) => {
  if (e.target.id === 'modalBackdrop') closeModal();
};

// ============== MODAL MANAGEMENT ==============
function closeAllModals() {
  // Close confirm overlay
  $('confirmOverlay').classList.remove('show');

  // Close progress modal
  $('modal').classList.remove('show');
  $('modalBackdrop').classList.remove('show');

  // Close coverage modal
  $('coverageModal').classList.remove('show');
  $('coverageBackdrop').classList.remove('show');

  // Close effect overlay
  $('effectOverlay').classList.remove('show');
}

function resetMatchState() {
  // Close all modals first
  closeAllModals();

  // Reset game state variables
  state = null;
  eligiblePlayers = [];
  currentCategory = null;
  currentMeta = null;
  triviaData = [];
  triviaIndex = 0;
  matchDataReady = false;

  // Clear debounce timer
  if (debounceTimer) {
    clearTimeout(debounceTimer);
    debounceTimer = null;
  }

  // Clear toast timer
  if (toastTimer) {
    clearTimeout(toastTimer);
    toastTimer = null;
  }

  // Reset UI elements
  $('guess').value = '';
  $('submitBtn').disabled = true;
  $('result').textContent = '';
  $('selectionList').innerHTML = '';
  $('selectionList').classList.add('hidden');
  $('inlineToast').classList.remove('show', 'bust-effect', 'win-effect');
  $('inlineToast').innerHTML = '';
  $('hintBar').classList.add('hidden');
  $('hintText').innerHTML = '';
  $('scoreGrid').innerHTML = '';
  $('turnInfo').innerHTML = '';
  $('chain').textContent = '501';
  $('pickList').innerHTML = '';
  $('triviaContainer').innerHTML = '';

  // Reset loading screen state
  $('loadingSpinner').classList.remove('ready');
  $('loadingSpinner').style.animation = '';
  $('loadingText').textContent = 'Loading match data...';
  $('loadingText').classList.remove('ready');
  hide('readyBadge');
  hide('skipTrivia');
  hide('triviaNote');

  // Reset custom builder selections
  customSelectedNats.clear();
  customSelectedClubs.clear();
  document.querySelectorAll('#nationalityChips .chip, #clubChips .chip').forEach(c => c.classList.remove('selected'));
  $('customPreview').classList.add('hidden');
  $('startCustomGame').disabled = true;
}

// ============== END GAME CONFIRMATION ==============
$('endBtn').onclick = () => {
  $('confirmOverlay').classList.add('show');
};

$('confirmNo').onclick = () => {
  $('confirmOverlay').classList.remove('show');
};

$('confirmYes').onclick = () => {
  recordGameEnd();
  playAgain();
};

function playAgain() {
  // Full reset of match state (keeps session stats)
  resetMatchState();

  // Navigate to category selection
  hide('playCard');
  show('setupCard');
  hide('orderScreen');
  show('step3');
}

// ============== CUSTOM GAME BUILDER ==============
const NATIONALITY_OPTIONS = [
  { code: 'ENG', name: 'England', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø' },
  { code: 'FRA', name: 'France', flag: 'üá´üá∑' },
  { code: 'ESP', name: 'Spain', flag: 'üá™üá∏' },
  { code: 'GER', name: 'Germany', flag: 'üá©üá™' },
  { code: 'ITA', name: 'Italy', flag: 'üáÆüáπ' },
  { code: 'BRA', name: 'Brazil', flag: 'üáßüá∑' },
  { code: 'ARG', name: 'Argentina', flag: 'üá¶üá∑' },
  { code: 'NED', name: 'Netherlands', flag: 'üá≥üá±' },
  { code: 'POR', name: 'Portugal', flag: 'üáµüáπ' },
  { code: 'BEL', name: 'Belgium', flag: 'üáßüá™' },
  { code: 'IRL', name: 'Ireland', flag: 'üáÆüá™' },
  { code: 'SCO', name: 'Scotland', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø' },
  { code: 'WAL', name: 'Wales', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø' },
  { code: 'NGA', name: 'Nigeria', flag: 'üá≥üá¨' },
  { code: 'GHA', name: 'Ghana', flag: 'üá¨üá≠' },
  { code: 'CIV', name: 'Ivory Coast', flag: 'üá®üáÆ' },
  { code: 'SEN', name: 'Senegal', flag: 'üá∏üá≥' },
  { code: 'AUS', name: 'Australia', flag: 'üá¶üá∫' },
  { code: 'USA', name: 'USA', flag: 'üá∫üá∏' },
  { code: 'JAM', name: 'Jamaica', flag: 'üáØüá≤' },
];

const CLUB_OPTIONS = [
  { id: 'Arsenal', name: 'Arsenal', color: '#EF0107' },
  { id: 'Aston Villa', name: 'Aston Villa', color: '#670E36' },
  { id: 'Chelsea', name: 'Chelsea', color: '#034694' },
  { id: 'Everton', name: 'Everton', color: '#003399' },
  { id: 'Liverpool', name: 'Liverpool', color: '#C8102E' },
  { id: 'Manchester City', name: 'Man City', color: '#6CABDD' },
  { id: 'Manchester United', name: 'Man Utd', color: '#DA291C' },
  { id: 'Newcastle United', name: 'Newcastle', color: '#241F20' },
  { id: 'Tottenham Hotspur', name: 'Spurs', color: '#132257' },
  { id: 'West Ham United', name: 'West Ham', color: '#7A263A' },
  { id: 'Leicester City', name: 'Leicester', color: '#003090' },
  { id: 'Southampton', name: 'Southampton', color: '#D71920' },
  { id: 'Fulham', name: 'Fulham', color: '#000000' },
  { id: 'Crystal Palace', name: 'Crystal Palace', color: '#1B458F' },
  { id: 'Blackburn Rovers', name: 'Blackburn', color: '#009EE0' },
  { id: 'Leeds United', name: 'Leeds', color: '#FFCD00' },
];

let customSelectedNats = new Set();
let customSelectedClubs = new Set();

function initCustomBuilder() {
  // Build nationality chips
  const natContainer = $('nationalityChips');
  natContainer.innerHTML = NATIONALITY_OPTIONS.map(n => `
    <div class="chip" data-code="${n.code}">
      <span class="flag">${n.flag}</span>
      <span>${n.name}</span>
    </div>
  `).join('');

  natContainer.querySelectorAll('.chip').forEach(chip => {
    chip.onclick = () => toggleChip(chip, 'nationality');
  });

  // Build club chips
  const clubContainer = $('clubChips');
  clubContainer.innerHTML = CLUB_OPTIONS.map(c => `
    <div class="chip" data-id="${c.id}">
      <div class="color-dot-sm" style="background:${c.color}"></div>
      <span>${c.name}</span>
    </div>
  `).join('');

  clubContainer.querySelectorAll('.chip').forEach(chip => {
    chip.onclick = () => toggleChip(chip, 'club');
  });

  // Clear buttons
  $('clearNats').onclick = (e) => {
    e.stopPropagation();
    customSelectedNats.clear();
    document.querySelectorAll('#nationalityChips .chip').forEach(c => c.classList.remove('selected'));
    updateCustomPreview();
  };

  $('clearClubs').onclick = (e) => {
    e.stopPropagation();
    customSelectedClubs.clear();
    document.querySelectorAll('#clubChips .chip').forEach(c => c.classList.remove('selected'));
    updateCustomPreview();
  };

  $('customMetric').onchange = updateCustomPreview;
}

function toggleChip(chip, type) {
  const maxSelection = 5;
  const set = type === 'nationality' ? customSelectedNats : customSelectedClubs;
  const key = type === 'nationality' ? chip.dataset.code : chip.dataset.id;

  if (chip.classList.contains('selected')) {
    chip.classList.remove('selected');
    set.delete(key);
  } else {
    if (set.size >= maxSelection) {
      return; // Max reached
    }
    chip.classList.add('selected');
    set.add(key);
  }
  updateCustomPreview();
}

function updateCustomPreview() {
  const metric = $('customMetric').value;
  const previewEl = $('customPreview');
  const previewText = $('customPreviewText');
  const warningEl = $('customWarning');

  const hasNats = customSelectedNats.size > 0;
  const hasClubs = customSelectedClubs.size > 0;

  // Hide warning by default
  warningEl.classList.add('hidden');

  if (!hasNats && !hasClubs) {
    // No filters = all EPL players
    previewEl.classList.remove('hidden');
    const metricLabel = metric === 'apps' ? 'Appearances' : 'Goals';
    previewText.innerHTML = `<strong>${metricLabel}</strong> from <strong>all EPL players</strong>`;
    return;
  }

  previewEl.classList.remove('hidden');

  const metricLabel = metric === 'apps' ? 'Appearances' : 'Goals';
  let filterParts = [];

  if (hasNats) {
    const natNames = Array.from(customSelectedNats).map(code =>
      NATIONALITY_OPTIONS.find(n => n.code === code)?.name || code
    );
    filterParts.push(`Nationality: ${natNames.join(', ')}`);
  }

  if (hasClubs) {
    const clubNames = Array.from(customSelectedClubs).map(id =>
      CLUB_OPTIONS.find(c => c.id === id)?.name || id
    );
    filterParts.push(`Club: ${clubNames.join(', ')}`);
  }

  const modeText = hasNats && hasClubs ? ' (intersection)' : '';
  previewText.innerHTML = `<strong>${metricLabel}</strong>${modeText}<br>${filterParts.join('<br>')}`;
}

function getCustomCacheKey() {
  const metric = $('customMetric').value;
  const nats = Array.from(customSelectedNats).sort().join(',');
  const clubs = Array.from(customSelectedClubs).sort().join(',');
  return `custom_${metric}_n${nats}_c${clubs}`;
}

$('startCustomGame').onclick = async () => {
  const metric = $('customMetric').value;
  const nationalities = Array.from(customSelectedNats);
  const clubs = Array.from(customSelectedClubs);

  // Build custom category object
  const cacheKey = getCustomCacheKey();
  const customCat = {
    id: cacheKey,
    title: 'Custom Game',
    flag: 'üéÆ',
    isCustom: true,
  };

  currentCategory = customCat;
  matchDataReady = false;
  triviaIndex = 0;

  hide('step3');
  show('loadingScreen');
  hide('readyBadge');
  hide('skipTrivia');
  hide('triviaNote');
  $('triviaContainer').innerHTML = '';
  $('loadingSpinner').classList.remove('ready');
  $('loadingSpinner').style.animation = '';
  $('loadingText').textContent = 'Building custom game...';
  $('loadingText').classList.remove('ready');

  // Check cache first
  const cached = getCachedData(cacheKey);
  if (cached) {
    eligiblePlayers = cached.eligiblePlayers || [];
    currentMeta = cached.meta || {};
    triviaData = cached.meta?.trivia || [];
    matchDataReady = true;
    showReadyState();
    showTrivia();
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/match_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        categoryId: 'custom',
        metric: metric === 'goals' ? 'goals_total' : 'apps_total',
        nationalities: nationalities.length > 0 ? nationalities : null,
        clubs: clubs.length > 0 ? clubs : null,
      }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // Cache the result
    setCachedData(cacheKey, data);

    eligiblePlayers = data.eligiblePlayers || [];
    currentMeta = data.meta || {};
    triviaData = data.meta?.trivia || [];
    matchDataReady = true;
    showReadyState();
    showTrivia();
  } catch (err) {
    alert('Failed to load custom game: ' + err.message);
    show('step3');
    hide('loadingScreen');
  }
};

// ============== INIT ==============
(function init() {
  initCustomBuilder();
})();
</script>
</body>
</html>
