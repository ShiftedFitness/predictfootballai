<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>PredictFootball.ai 501</title>
<style>
:root{--bg:#000;--card:#4f8b6e;--ink:#fff;--muted:#cfe5db;--btn:#111;--btnH:#222;--danger:#ff5a5a;--accent:#0b1}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;min-height:100vh;padding:22px}
.card{max-width:600px;margin:0 auto;background:var(--card);border-radius:22px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,.5);position:relative}
h2{margin:0 0 14px;font-size:22px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input{width:100%;display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.label{font-size:13px;color:#e8f3ee;font-weight:700}
input,select,button{width:100%;padding:12px 14px;border:none;border-radius:12px;font-size:16px}
input,select{background:#f7fffbd8;color:#0c1b15;-webkit-text-fill-color:#0c1b15} /* <-- black text incl. iOS */
button{background:var(--btn);color:#fff;cursor:pointer;transition:.15s}
button:hover{background:var(--btnH)}
.textbtn{background:none;color:#fff;text-decoration:underline;font-size:13px;padding:6px 4px;width:auto}

/* sections + game cards */
.section{background:rgba(0,0,0,.18);border-radius:16px;margin-bottom:14px;overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
.section-title{font-weight:900}
.chev{opacity:.9}
.section-body{padding:12px 14px;display:none}
.section.open .section-body{display:block}
.game-card{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(0,0,0,.14);border-radius:14px;padding:14px 16px;cursor:pointer;margin-bottom:10px}
.game-meta{font-size:12px;color:#e8f3ee}
.stars{color:gold}
.flagrow{display:inline-flex;gap:6px;align-items:center}
.badgeNI{display:inline-block;background:#111;color:#fff;font-weight:800;border-radius:10px;padding:2px 6px;font-size:11px;line-height:1}

/* scoreboard */
.scores{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 6px}
.pill{flex:1 1 45%;background:rgba(0,0,0,.25);border-radius:16px;padding:12px;text-align:center;cursor:pointer}
.pill.active{background:rgba(255,255,255,.15);outline:2px solid #fff}
.pill .name{font-weight:700}.pill .num{font-size:30px;font-weight:800}
.turn{text-align:center;margin:10px 0;font-weight:700}
.result{min-height:24px;text-align:center;margin:8px 0}

/* inline toast */
.inline-toast{margin:8px auto 0;width:100%;max-width:560px;background:rgba(0,0,0,.92);color:#fff;border-radius:16px;padding:12px 14px;box-shadow:0 10px 28px rgba(0,0,0,.5);opacity:0;transform:translateY(6px);transition:opacity .25s,transform .25s}
.inline-toast.show{opacity:1;transform:translateY(0)}
.toast-row{display:flex;align-items:center;gap:12px}
.badge{min-width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;background:#1f8a5e}
.toast-body{flex:1}.toast-title{font-weight:800;margin:0 0 4px}.toast-sub{opacity:.85;font-size:13px}
.toast-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;opacity:.85}
.toast-meta span{background:rgba(255,255,255,.08);padding:6px 8px;border-radius:9px}
.hint{margin:6px 0 8px;text-align:center;font-size:13px;color:var(--accent);font-weight:700}

/* loaders */
.loader{display:flex;align-items:center;justify-content:center;height:240px}
.loader span{font-size:20px;animation:pulse 1.2s infinite}
@keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
.randomising{font-size:18px;text-align:center;padding:24px 0;animation:pulse 1s infinite}
.orderList{margin-top:10px;background:rgba(0,0,0,.25);border-radius:12px;padding:10px 12px}
.hidden{display:none}

/* progress modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
.modal-backdrop.show{display:flex}
.modal{width:min(560px,92vw);background:#0f2a21;color:#fff;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.7);padding:16px 16px 14px;transform:translateY(8px);opacity:0;transition:transform .25s ease,opacity .2s ease}
.modal.show{transform:translateY(0);opacity:1}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.modal-title{font-weight:900;font-size:18px}
.close-btn{background:#2a3e36;border:none;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
.chain{background:#133a2e;padding:10px 12px;border-radius:12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;overflow:auto}
.pick-list{margin-top:10px;display:grid;gap:8px}
.pick{background:#0c241c;padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;font-size:14px}
.pick b{font-weight:800}.pick .meta{opacity:.85;font-size:12px}
.bust{color:#ff8a8a}
</style>
</head>
<body>

<!-- SETUP -->
<div class="card" id="setupCard">
  <div id="step1">
    <h2>1Ô∏è‚É£ Number of players</h2>
    <div class="input">
      <label class="label" for="numPlayers">Players</label>
      <select id="numPlayers">
        <option value="1">1</option><option value="2" selected>2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option>
      </select>
    </div>
    <button id="toStep2">Next</button>
  </div>

  <div id="step2" class="hidden">
    <h2>2Ô∏è‚É£ Player names</h2>
    <div id="nameFields"></div>
    <button id="toStep3">Next</button>
  </div>

  <div id="step3" class="hidden">
    <h2>3Ô∏è‚É£ Choose game</h2>

    <!-- Sections -->
    <div class="section open" id="sec-country">
      <div class="section-header" onclick="toggleSec('sec-country')">
        <div class="section-title">Premier League Players by Country</div><div class="chev">‚ñæ</div>
      </div>
      <div class="section-body" id="countryGames"></div>
    </div>

    <div class="section" id="sec-club">
      <div class="section-header" onclick="toggleSec('sec-club')">
        <div class="section-title">Premier League Players by Club</div><div class="chev">‚ñ∏</div>
      </div>
      <div class="section-body" id="clubGames"></div>
    </div>

    <div class="section" id="sec-competition">
      <div class="section-header" onclick="toggleSec('sec-competition')">
        <div class="section-title">Goals by Player by Competition</div><div class="chev">‚ñ∏</div>
      </div>
      <div class="section-body" id="compGames"></div>
    </div>

    <div class="section" id="sec-other">
      <div class="section-header" onclick="toggleSec('sec-other')">
        <div class="section-title">Other</div><div class="chev">‚ñ∏</div>
      </div>
      <div class="section-body" id="otherGames"></div>
    </div>
  </div>

  <div id="loadingScreen" class="hidden loader"><span>Loading game‚Ä¶</span></div>

  <div id="randomisingScreen" class="hidden">
    <div class="randomising">üé≤ Randomising order‚Ä¶</div>
    <div id="orderList" class="orderList hidden"></div>
    <button id="beginMatch" class="hidden">Start Match</button>
  </div>
</div>

<!-- GAMEPLAY -->
<div class="card hidden" id="playCard">
  <div class="scores" id="scoreGrid"></div>
  <div class="turn" id="turnInfo"></div>
  <div id="checkoutHint" class="hint hidden"></div>

  <div class="input" style="margin-top:8px;">
    <label for="guess" class="label">Your pick</label>
    <input id="guess" placeholder="Type a player"/>
  </div>
  <div class="row">
    <button id="submit">Submit</button>
    <button id="end" class="textbtn">End game</button>
  </div>

  <div class="result" id="result"></div>
  <div id="inlineToast" class="inline-toast"></div>
</div>

<!-- PROGRESS MODAL -->
<div id="modalBack" class="modal-backdrop">
  <div id="modal" class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Progress</div>
      <button id="closeModal" class="close-btn">Close</button>
    </div>
    <div><strong>Checkout chain</strong></div>
    <div id="chain" class="chain">‚Äî</div>
    <div class="pick-list" id="pickList"></div>
  </div>
</div>

<script>
const API={ start:'/.netlify/functions/start-game', validate:'/.netlify/functions/validate-player', score:'/.netlify/functions/score-round' };
const TTL=90*60*1000;

/* ---- GAME CATALOG ----
collection keys must match backend COLLECTION_MAP in validate-player.js
*/
const GAMES = {
  country: [
    { title:'Spain ‚Äî players in PL',     flag:'üá™üá∏', collection:'prem_country', filterKey:'Country', filterValue:'Spain',  fieldName:'Matches' },
    { title:'France ‚Äî players in PL',    flag:'üá´üá∑', collection:'prem_country', filterKey:'Country', filterValue:'France', fieldName:'Matches' },
    { title:'Brazil ‚Äî players in PL',    flag:'üáßüá∑', collection:'prem_country', filterKey:'Country', filterValue:'Brazil', fieldName:'Matches' },
  ],
  club: [
    /* FIX: filterKey=Club (not Team) */
    { title:'Man Utd ‚Äî players in PL',   flag:'üü•',  collection:'prem_club',    filterKey:'Club',    filterValue:'Man Utd',   fieldName:'Matches' },
    { title:'Sunderland ‚Äî players in PL',flag:'üî¥‚ö™Ô∏è',collection:'prem_club',    filterKey:'Club',    filterValue:'Sunderland', fieldName:'Matches' },
  ],
  competition: [
    { title:'Champions League ‚Äî goals since 1992', flag:'üèÜ', collection:'ucl_goals', fieldName:'Goals' }
  ],
 other: [
  {
    title: "British players in Europe‚Äôs Top 5 (ex-EPL) (ENG, SCO, WAL, NI)",
    flag: "üá¨üáß",
    collection: "british_europe",
    fieldName: "Matches"
  }
]
};

let playersCache=[], state=null, currentGame=null;

/* ---------- Setup flow ---------- */
document.getElementById('toStep2').onclick=()=>{
  const n=+document.getElementById('numPlayers').value;
  const wrap=document.getElementById('nameFields'); wrap.innerHTML='';
  for(let i=1;i<=n;i++){
    const c=document.createElement('div'); c.className='input';
    c.innerHTML=`<label class="label">Player ${i}</label><input id="pname${i}" placeholder="Enter name">`;
    wrap.appendChild(c);
  }
  show('step2'); hide('step1');
};

document.getElementById('toStep3').onclick=()=>{
  const n=+document.getElementById('numPlayers').value;
  const names=[]; for(let i=1;i<=n;i++){ names.push(document.getElementById(`pname${i}`).value||`Player ${i}`); }
  window.gameSetup={names};
  buildGameSections(); show('step3'); hide('step2');
};

function toggleSec(id){
  const sec=document.getElementById(id);
  const open=sec.classList.toggle('open');
  sec.querySelector('.chev').textContent = open ? '‚ñæ' : '‚ñ∏';
}

/* ---------- Build sections & preload stats ---------- */
function buildGameSections(){
  buildSection('countryGames', GAMES.country);
  buildSection('clubGames', GAMES.club);
  buildSection('compGames', GAMES.competition);
  buildSection('otherGames', GAMES.other, true);
}

function buildSection(containerId, list, isOther=false){
  const cont=document.getElementById(containerId); cont.innerHTML='';
  list.forEach(game=>{
    const el=document.createElement('div'); el.className='game-card';
    const left = `<div><div><b>${game.flag||''} ${game.title} ${isOther && game.flagsHTML ? game.flagsHTML : ''}</b></div><div class="game-meta" id="info-${hashGame(game)}">Loading‚Ä¶</div></div>`;
    el.innerHTML=`${left}<div>‚û§</div>`;
    el.onclick=()=> chooseGame(game);
    cont.appendChild(el);
    preloadStats(game);
  });
}

function hashGame(g){ return btoa(`${g.collection}|${g.filterKey||''}|${g.filterValue||''}|${g.fieldName}`).replace(/=+$/,''); }

async function preloadStats(game){
  const id=`info-${hashGame(game)}`;
  try{
    const url = new URL(API.validate, location.origin);
    url.searchParams.set('fetchAll','1');
    url.searchParams.set('collection', game.collection);
    if(game.filterKey)  url.searchParams.set('filterKey', game.filterKey);
    if(game.filterValue)url.searchParams.set('filterValue', game.filterValue);
    url.searchParams.set('fieldName', game.fieldName);
    const res=await fetch(url.toString());
    const data=await res.json();
    const total=data.length;
    const totalVal=data.reduce((a,b)=>a+Number(b[game.fieldName]||b.matches||b.goals||0),0);
    // Difficulty: base on dataset size (smaller = harder) + small bias per game family
    const group=(window.gameSetup?.names?.length||2);
    let base;
    if(game.collection==='ucl_goals'){ base = 1; }                 // easiest
    else if(game.collection==='prem_country' && game.filterValue==='Brazil'){ base = 4; } // harder
    else{
      base = total>=400?1 : total>=250?2 : total>=150?3 : total>=100?4 : 5;
    }
    const groupAdj=Math.min(1, Math.max(0, (group-2)>0 ? 1 : 0));   // more players ‚Üí +1 star max
    const diff=Math.min(5, Math.max(1, base + groupAdj));
    const fmt = n => Number(n||0).toLocaleString('en-GB');
    document.getElementById(id).innerHTML=
      `<span class="stars">${'‚òÖ'.repeat(diff)}${'‚òÜ'.repeat(5-diff)}</span> ‚Ä¢ ${fmt(total)} players ‚Ä¢ ${fmt(totalVal)} ${game.fieldName.toLowerCase()}`;
  }catch{ document.getElementById(id).textContent='‚Äî'; }
}

async function chooseGame(game){
  currentGame = game;
  hide('step3'); show('loadingScreen');
  try{
    playersCache = await fetchAllForGame(game);
  }catch(e){
    alert('Failed to load data. Try again.'); show('step3'); hide('loadingScreen'); return;
  }
  hide('loadingScreen'); show('randomisingScreen');
  await randomiseOrderAndShow();
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function randomiseOrderAndShow(){
  const names=[...(window.gameSetup?.names||['Player 1','Player 2'])];
  for(let i=0;i<8;i++){
    names.sort(()=>Math.random()-0.5);
    document.querySelector('#randomisingScreen .randomising').textContent='üé≤ Randomising order‚Ä¶ '+names.join(' ‚Ä¢ ');
    await sleep(120);
  }
  names.sort(()=>Math.random()-0.5);
  const orderEl=document.getElementById('orderList'); orderEl.classList.remove('hidden');
  orderEl.innerHTML='<b>Order:</b> '+names.map((n,i)=>`${i+1}. ${n}`).join('&nbsp;&nbsp;');
  const btn=document.getElementById('beginMatch'); btn.classList.remove('hidden');
  btn.onclick=()=>beginMatch(names);
}

async function beginMatch(names){
  state={
    players:names,
    scores:Array(names.length).fill(501),
    turn:0,
    used:new Set(),
    retry:false,
    historyScores:names.map(()=>[501]),
    picks:names.map(()=>[])
  };
  renderScoreGrid(); updateTurnUI();
  show('playCard'); hide('setupCard'); document.getElementById('guess').focus();
}

/* ---------- Data (per-game cache) ---------- */
async function fetchAllForGame(game){
  const key=`players_${game.collection}_${game.filterKey||'ALL'}_${game.filterValue||'ALL'}_${game.fieldName}`;
  const tsKey=`${key}_ts`;
  const now=Date.now(), ts=+localStorage.getItem(tsKey)||0;
  const cached=localStorage.getItem(key);
  if(cached && (now-ts)<TTL) return JSON.parse(cached);
  const url = new URL(API.validate, location.origin);
  url.searchParams.set('fetchAll','1');
  url.searchParams.set('collection', game.collection);
  if(game.filterKey)  url.searchParams.set('filterKey', game.filterKey);
  if(game.filterValue)url.searchParams.set('filterValue', game.filterValue);
  url.searchParams.set('fieldName', game.fieldName);
  const res=await fetch(url.toString());
  const data=await res.json();
  localStorage.setItem(key, JSON.stringify(data)); localStorage.setItem(tsKey, String(now));
  return data;
}

/* ---------- Gameplay UI ---------- */
function renderScoreGrid(){
  const grid=document.getElementById('scoreGrid'); grid.innerHTML='';
  state.players.forEach((name,idx)=>{
    const div=document.createElement('div');
    div.className='pill'+(idx===state.turn?' active':'');
    div.innerHTML=`<div class="name">${name}</div><div class="num" id="score_${idx}">${state.scores[idx]}</div>`;
    div.onclick=()=>openProgressModal(idx);
    grid.appendChild(div);
  });
}
function setActivePill(){ document.querySelectorAll('.pill').forEach((el,i)=> el.classList.toggle('active', i===state.turn)); }
function updateTurnUI(){ document.getElementById('turnInfo').textContent=`${state.players[state.turn]}'s turn`; updateCheckoutHint(); setActivePill(); }

function updateCheckoutHint(){
  const hint=document.getElementById('checkoutHint'); const remaining=state.scores[state.turn];
  if(remaining<=0 || playersCache.length===0){ hint.classList.add('hidden'); hint.textContent=''; return; }
  const getVal = (p)=> Number(p[currentGame.fieldName] ?? p.matches ?? p.goals ?? 0);
  const available=playersCache.filter(p=>!state.used.has((p.player||'').toLowerCase()));
  const direct=available.reduce((a,p)=>a+(getVal(p)===remaining?1:0),0);
  const freq=new Map(); for(const p of available){ const m=getVal(p); if(m>0 && m<=remaining) freq.set(m,(freq.get(m)||0)+1); }
  let pairs=0; for(const [m,c] of freq.entries()){ const n=remaining-m; if(n<m) continue; if(!freq.has(n)) continue; pairs+= (n===m)? c*(c-1)/2 : c*freq.get(n); }
  const fmt = n => Number(n||0).toLocaleString('en-GB');
  hint.innerHTML=`Checkout: <strong>${direct===0?'no':fmt(direct)}</strong> direct ¬∑ <strong>${pairs>10?'>10':fmt(pairs)}</strong> two-player combos`;
  hint.classList.remove('hidden');
}

/* ---------- Progress modal ---------- */
function openProgressModal(i){
  document.getElementById('modalTitle').textContent=`${state.players[i]} ‚Äî Progress`;
  document.getElementById('chain').textContent=state.historyScores[i].join(' ‚Üí ');
  const list=state.picks[i].slice(0,12).map(p=>`
    <div class="pick${p.bust?' bust':''}">
      <div><b>${p.name}</b> <span class="meta">-${p.matches}</span></div>
      <div class="meta">${p.from} ‚Üí ${p.to}${p.bust?' (bust)':''}</div>
    </div>`).join('') || '<div class="pick"><div>No picks yet</div></div>';
  document.getElementById('pickList').innerHTML=list;
  const back=document.getElementById('modalBack'); const modal=document.getElementById('modal');
  back.classList.add('show'); requestAnimationFrame(()=> modal.classList.add('show'));
}
function closeModal(){ const back=document.getElementById('modalBack'); const modal=document.getElementById('modal'); modal.classList.remove('show'); setTimeout(()=> back.classList.remove('show'), 160); }
document.getElementById('closeModal').onclick=closeModal;
document.getElementById('modalBack').onclick=(e)=>{ if(e.target.id==='modalBack') closeModal(); };

/* ---------- Inline toast ---------- */
let toastTimer=null;
function showImpactInline({ canonical, matches, starts, goals, mins }, before, after){
  const box=document.getElementById('inlineToast');
  const fmt=n=>Number(n||0).toLocaleString('en-GB');
  const field=currentGame.fieldName;
  box.innerHTML=`<div class="toast-row"><div class="badge">-${fmt(matches)}</div>
    <div class="toast-body"><div class="toast-title">${canonical}</div>
    <div class="toast-sub">${fmt(before)} ‚Üí ${fmt(after)}</div>
    <div class="toast-meta">
      <span>${field} ${fmt(matches)}</span>
      ${starts!==undefined?`<span>Starts ${fmt(starts)}</span>`:''}
      ${goals!==undefined?`<span>Goals ${fmt(goals)}</span>`:''}
      ${mins!==undefined?`<span>Mins ${fmt(mins)}</span>`:''}
    </div></div></div>`;
  box.classList.add('show'); if(toastTimer) clearTimeout(toastTimer); toastTimer=setTimeout(()=> box.classList.remove('show'),5000);
}
document.getElementById('guess').addEventListener('input',()=> document.getElementById('inlineToast').classList.remove('show'));

/* ---------- Submit / End ---------- */
document.getElementById('submit').onclick=onSubmit;
document.getElementById('end').onclick=()=>{ if(confirm('End this match?')) location.reload(); };

async function onSubmit(){
  const input=document.getElementById('guess'); const raw=input.value.trim(); if(!raw) return;
  const lower=raw.toLowerCase();

  if(state.used.has(lower)){
    if(!state.retry){ state.retry=true; setResult('‚ö†Ô∏è Already used. Try once more.'); input.focus(); return; }
    state.retry=false; setResult('‚ùå Duplicate. Turn passes.'); nextTurn(); return;
  }

  // validate for the chosen game
  let v; 
  try{
    const url = new URL(API.validate, location.origin);
    url.searchParams.set('collection', currentGame.collection);
    if(currentGame.filterKey)  url.searchParams.set('filterKey', currentGame.filterKey);
    if(currentGame.filterValue)url.searchParams.set('filterValue', currentGame.filterValue);
    url.searchParams.set('fieldName', currentGame.fieldName);
    v=await fetch(url.toString(),{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({guess:raw})
    }).then(r=>r.json());
  }catch(_){ v={valid:false}; }

  if(!v.valid){
    if(!state.retry){ state.retry=true; setResult('‚ùå Not found. Try once more.'); input.focus(); return; }
    state.retry=false; setResult('‚ùå Not found. Turn passes.'); nextTurn(); return;
  }

  state.retry=false;
  const canonical=(v.canonical||raw).toLowerCase();
  if(state.used.has(canonical)){ setResult('‚ö†Ô∏è Already used. Turn passes.'); nextTurn(); return; }

  // score
  const before=state.scores[state.turn];
  let s;
  try{
    s=await fetch(API.score,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({player:state.turn,scores:state.scores,deduct:v.matches})
    }).then(r=>r.json());
  }catch(_){ setResult('Error scoring.'); return; }

  // safety: ensure lengths match
  if(!s || !Array.isArray(s.scores) || s.scores.length !== state.scores.length){
    const patched=state.scores.slice();
    if(s && !s.bust){ patched[state.turn]=Math.max(0, state.scores[state.turn]-Number(v.matches||0)); }
    s={scores:patched,bust:s?.bust||false,win:patched[state.turn]===0,message:s?.message||''};
  }

  if(s.bust){
    setResult(`üí• Bust! ${v.canonical} has ${Number(v.matches).toLocaleString('en-GB')}. Score stays ${Number(state.scores[state.turn]).toLocaleString('en-GB')}.`);
    state.picks[state.turn].unshift({name:v.canonical,matches:v.matches,from:before,to:before,bust:true});
  }else{
    state.scores=s.scores;
    const after=state.scores[state.turn];
    const scoreEl=document.getElementById(`score_${state.turn}`);
    animateCount(scoreEl, before, after, 850);
    setResult(s.win ? `üéØ ${state.players[state.turn]} checked out with ${v.canonical} (${Number(v.matches).toLocaleString('en-GB')}).`
                    : `‚úÖ ${v.canonical}: ‚àí${Number(v.matches).toLocaleString('en-GB')}`);
    state.used.add(canonical);
    state.historyScores[state.turn].push(after);
    state.picks[state.turn].unshift({name:v.canonical,matches:v.matches,from:before,to:after,bust:false});
    showImpactInline(v, before, after);
  }

  if(s.win){ setTimeout(()=>location.reload(), 1200); return; }
  nextTurn();
}

function nextTurn(){ const input=document.getElementById('guess'); input.value=''; input.focus(); state.turn=(state.turn+1)%state.players.length; renderScoreGrid(); updateTurnUI(); }
function setResult(msg){ document.getElementById('result').textContent=msg; }

/* ---------- INIT ---------- */
(function initNames(){
  const n=+document.getElementById('numPlayers').value;
  const wrap=document.getElementById('nameFields');
  for(let i=1;i<=n;i++){
    const c=document.createElement('div'); c.className='input';
    c.innerHTML=`<label class="label">Player ${i}</label><input id="pname${i}" placeholder="Enter name">`;
    wrap.appendChild(c);
  }
})();
function show(id){ document.getElementById(id).classList.remove('hidden'); }
function hide(id){ document.getElementById(id).classList.add('hidden'); }
function animateCount(el, from, to, dur=850){
  const start=performance.now(); const diff=to-from;
  function step(t){ const p=Math.min(1,(t-start)/dur); const ease=p<.5?2*p*p:-1+(4-2*p)*p; el.textContent=Math.round(from+diff*ease); if(p<1) requestAnimationFrame(step); else el.textContent=String(to); }
  requestAnimationFrame(step);
}
</script>
</body>
</html>
