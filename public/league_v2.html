<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PredictFootball.ai – Tables</title>
<style>
  :root{
    --bg:#30A278; --card:#000000; --border:#1a1a1a; --text:#FFFFFF; --muted:#EAEAEA;
    --accent:#FFFFFF; --accentText:#000000; --points-bg:rgba(255,255,255,0.1); --points-color:#FFD700;
  }
  html, body { height:100%; }
  body{
    margin:0; background:#111; color:#fff; font-family:Inter,system-ui,Arial;
    display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  }
  .wrap{ max-width:750px; width:100%; margin:24px 12px; background:var(--bg); color:var(--text); border-radius:14px; padding:16px; }
  h2{ margin:0 0 12px; }

  .tabs{ display:flex; gap:8px; margin-bottom:12px }
  .tab{ background:#0e0e0e; color:#fff; border:1px solid #2a2a2a; padding:8px 12px; border-radius:999px; cursor:pointer }
  .tab.active{ background:#fff; color:#000; font-weight:800 }

  .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
  .muted{ color:var(--muted) }
  .scroll{ max-height:520px; overflow:auto; border-radius:12px }

  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th, .table td{ padding:10px 8px; border-bottom:1px solid #1f1f1f; text-align:left; white-space:nowrap }
  .table th{ font-size:12px; letter-spacing:.3px; color:#cfcfcf; text-transform:uppercase }

  .pos{ width:64px }
  .user{ max-width:260px; overflow:hidden; text-overflow:ellipsis }
  .acc{ width:90px; text-align:right }
  .center{ text-align:center }

  .pts{ width:90px; text-align:right; font-weight:700; background:var(--points-bg); color:var(--points-color); border-radius:6px }
  .highlight{ background:var(--accent); color:var(--accentText) !important }
  .highlight td{ color:var(--accentText) !important }
  .highlight td.pts{ background:var(--accent); color:var(--accentText) !important }

  .tick{ color:#7CFC00; font-weight:900 }
  .cross{ color:#FF6B6B; font-weight:900 }
  .small{ font-size:12px; color:#cfcfcf; margin-bottom:6px }
  select{ background:#0e0e0e; color:#fff; border:1px solid #2a2a2a; border-radius:8px; padding:6px 10px }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between }
</style>
</head>
<body>
  <div class="wrap">
    <h2>Tables</h2>

    <div class="tabs">
      <button class="tab active" id="tabOverall">Overall</button>
      <button class="tab" id="tabWeekly">Matchweek</button>
    </div>

    <!-- Overall -->
    <div id="overall" class="card">
      <div class="muted" id="overallCount"></div>
      <div class="scroll">
        <table class="table" id="overallTbl">
          <thead>
            <tr>
              <th class="pos">Pos</th>
              <th>Username</th>
              <th class="acc">% Acc</th>
              <th class="center">FH</th>
              <th class="center">Blanks</th>
              <th class="pts">Points</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">Sorted by points, then FH, then accuracy.</div>
    </div>

    <!-- Weekly -->
    <div id="weekly" class="card" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div>
          <span class="muted">Week</span>
          <select id="weekSel"></select>
        </div>
        <div class="muted" id="lockedMsg"></div>
      </div>

      <!-- Match order reminder -->
      <div id="matchMap" class="small"></div>

      <div class="scroll">
        <table class="table" id="weeklyTbl">
          <thead>
            <tr>
              <th class="pos">Pos</th>
              <th>Username</th>
              <th class="center">Pts</th>
              <th class="center">1</th>
              <th class="center">2</th>
              <th class="center">3</th>
              <th class="center">4</th>
              <th class="center">5</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">✓/✗ appear once results are scored. Before that, cells show your pick (1 = Home, 2 = Away, X = Draw).</div>
    </div>
  </div>

<script>
const base = '/.netlify/functions';
const qs = new URLSearchParams(location.search);
const highlightUserId = qs.get('userId') || '';
const currentWeek = Number(qs.get('week') || 1);

/* ---------- helpers ---------- */
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pct(acc){ return (Math.round(acc*1000)/10).toFixed(1); } // 1 decimal

/* ---------- OVERALL ---------- */
function trOverall(row){
  const tr = document.createElement('tr');
  if (String(row.id) === String(highlightUserId)) tr.classList.add('highlight');
  tr.innerHTML = `
    <td class="pos">${row.position}</td>
    <td class="user">${escapeHTML(row.name)}</td>
    <td class="acc">${pct(row.accuracy)}%</td>
    <td class="center">${row.fh ?? 0}</td>
    <td class="center">${row.blanks ?? 0}</td>
    <td class="pts">${row.points}</td>
  `;
  return tr;
}

async function loadOverall(){
  const res = await fetch(`${base}/leaderboard`, { cache: 'no-store' });
  if (!res.ok) { alert('Failed to load leaderboard'); return; }
  const data = await res.json();
  const rows = data.leaderboard || [];
  const body = document.querySelector('#overallTbl tbody');
  body.innerHTML = '';
  rows.forEach(r => body.appendChild(trOverall(r)));
  document.getElementById('overallCount').textContent = `${rows.length} players`;
}

/* ---------- WEEKLY ---------- */
function toSymbol(p){ return p==='HOME'?'1':(p==='AWAY'?'2':(p==='DRAW'?'X':'-')); }
function cellFor(pick, resultIsSet, isCorrect){
  if (resultIsSet) return isCorrect ? '<span class="tick">✓</span>' : '<span class="cross">✗</span>';
  return `<span>${toSymbol(pick)}</span>`;
}
function trWeekly(row, resultSetFlags){
  const tr = document.createElement('tr');
  if (String(row.userId) === String(highlightUserId)) tr.classList.add('highlight');
  const cells = row.picksRaw.map((p, i)=> `<td class="center">${cellFor(p, resultSetFlags[i], row.correct[i])}</td>`).join('');
  tr.innerHTML = `
    <td>${row.pos}</td>
    <td>${escapeHTML(row.name)}</td>
    <td class="center">${row.points}</td>
    ${cells}
  `;
  return tr;
}

async function loadWeekly(week) {
  const r = await fetch(`${base}/weekly-table?week=${week}`, { cache:'no-store' });
  if (!r.ok) {
    alert('Failed to load weekly table');
    return;
  }
  const j = await r.json();

  // Deadline / availability
  document.getElementById('lockedMsg').textContent =
    j.locked ? 'Live (deadline passed)' : 'Not available (deadline not passed)';

  // Match map header
  const map = (j.matches || []).map((m,i)=> `Match ${i+1}: ${m.home} v ${m.away}`);
  document.getElementById('matchMap').textContent = map.join('  •  ');

  // Which columns have an official result?
  const resultSet = (j.matches || []).map(m => {
    const v = (m && typeof m.correct === 'string') ? m.correct.trim().toUpperCase() : '';
    return v === 'HOME' || v === 'AWAY' || v === 'DRAW';
  });

  // Table rows
  const body = document.querySelector('#weeklyTbl tbody');
  body.innerHTML = '';
  (j.rows || []).forEach((r,i)=>{
    const row = Object.assign({ pos: i+1 }, r);
    body.appendChild(trWeekly(row, resultSet));
  });

  // Week selector: use availableWeeks from API
  const sel = document.getElementById('weekSel');
  sel.innerHTML = '';
  const weeks = j.availableWeeks && j.availableWeeks.length ? j.availableWeeks : [j.week || week];

  weeks.forEach(w => {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = `Week ${w}`;
    if (Number(w) === Number(j.week || week)) opt.selected = true;
    sel.appendChild(opt);
  });

  sel.onchange = ()=> loadWeekly(Number(sel.value));
}

/* ---------- Tabs ---------- */
document.getElementById('tabOverall').onclick = ()=>{
  document.getElementById('tabOverall').classList.add('active');
  document.getElementById('tabWeekly').classList.remove('active');
  document.getElementById('overall').style.display='';
  document.getElementById('weekly').style.display='none';
};
document.getElementById('tabWeekly').onclick = async ()=>{
  document.getElementById('tabWeekly').classList.add('active');
  document.getElementById('tabOverall').classList.remove('active');
  document.getElementById('overall').style.display='none';
  document.getElementById('weekly').style.display='';
  await loadWeekly(currentWeek);
};

/* ---------- Init ---------- */
loadOverall();
</script>
</body>
</html>
