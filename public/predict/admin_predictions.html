<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>TeleStats Fives – Predictions Inspector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/predict/telestats-theme.css"/>
  <style>
    html, body { height:100%; }
    body {
      margin:0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
    }
    .ts-page {
      max-width:900px;
      width:100%;
      margin:24px 12px;
      padding:16px;
    }
    .ts-page-title {
      margin:0 0 8px;
    }
    .row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-bottom:8px;
    }
    .ts-label {
      margin-bottom:4px;
    }
    .ts-input {
      min-width:140px;
    }
    .ts-btn {
      white-space:nowrap;
    }
    .status {
      margin-top:6px;
      white-space:pre-wrap;
      font-size:12px;
    }
    .match-card {
      margin-top:10px;
    }
    .match-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .pill {
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      font-size:11px;
      color:var(--text-muted);
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td {
      padding:6px 6px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      text-align:left;
    }
    th {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:var(--text-muted);
    }
    tr:last-child td { border-bottom:none; }
    .right { text-align:right; }
    .mono { font-family:Menlo,Consolas,monospace; font-size:12px; }
    .badge {
      display:inline-block;
      padding:1px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,0.2);
    }
    .badge-good { border-color:var(--accent-green); color:var(--accent-green); }
    .badge-bad  { border-color:var(--danger); color:var(--danger); }
    .error { color:var(--danger); }
    .success { color:var(--accent-green); }
    .ts-muted { color:var(--text-muted); font-size:12px; }
    .access-denied {
      text-align:center;
      padding:60px 20px;
    }
    .access-denied h1 {
      font-family:'Space Mono',monospace;
      font-size:28px;
      color:var(--danger);
      margin-bottom:12px;
    }
    .access-denied p {
      color:var(--text-muted);
      font-size:14px;
    }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/predict/auth.js"></script>
  <div id="mainContainer"></div>

<script>
const base = '/.netlify/functions';

function $(id){ return document.getElementById(id); }

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function setStatus(msg, type){
  const el = $('status');
  if (!el) return;
  el.textContent = msg || '';
  el.classList.remove('error','success','ts-muted');
  if (type) el.classList.add(type);
}

// Read ADMIN_SECRET from URL query param
function getAdminSecret() {
  const params = new URLSearchParams(location.search);
  const raw = params.get('ADMIN_SECRET');
  if (!raw) return '';
  try {
    return decodeURIComponent(raw);
  } catch {
    return raw;
  }
}

const ADMIN_SECRET = getAdminSecret();

async function fetchJSON(url, secret){
  const res = await fetch(url, {
    headers: {
      'x-admin-secret': secret || ''
    },
    cache:'no-store'
  });
  let txt = await res.text();
  let data;
  try {
    data = txt ? JSON.parse(txt) : {};
  } catch {
    throw new Error('Invalid JSON from server: ' + txt.slice(0,200));
  }
  if (!res.ok) {
    throw new Error(data.error || ('HTTP ' + res.status));
  }
  return data;
}

function renderResults(data){
  const container = $('results');
  container.innerHTML = '';

  if (!data || !Array.isArray(data.rows) || data.rows.length === 0){
    const div = document.createElement('div');
    div.className = 'ts-card';
    div.innerHTML = '<span class="ts-muted">No predictions found for those match IDs.</span>';
    container.appendChild(div);
    return;
  }

  // group rows by matchId
  const byMatch = {};
  for (const row of data.rows){
    const mid = String(row.matchId);
    if (!byMatch[mid]) byMatch[mid] = [];
    byMatch[mid].push(row);
  }

  Object.keys(byMatch).sort((a,b)=> Number(a)-Number(b)).forEach(mid => {
    const list = byMatch[mid];

    const card = document.createElement('div');
    card.className = 'ts-card match-card';

    const header = document.createElement('div');
    header.className = 'match-header';
    const left = document.createElement('div');
    left.innerHTML = `<strong>Match ${escapeHTML(mid)}</strong>`;
    const right = document.createElement('div');
    const weeks = Array.from(new Set(list.map(r => r.week || 0))).filter(Boolean).sort((a,b)=>a-b);
    right.innerHTML = `<span class="pill">Weeks: ${weeks.length ? weeks.join(', ') : '-'}</span>`;
    header.appendChild(left);
    header.appendChild(right);
    card.appendChild(header);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>User</th>
          <th>User ID</th>
          <th>Week</th>
          <th>Pick</th>
          <th class="right">Points</th>
          <th>Prediction ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector('tbody');

    list.sort((a,b)=> a.userName.localeCompare(b.userName)).forEach(r => {
      const tr = document.createElement('tr');
      const pts = (r.pointsAwarded === null || typeof r.pointsAwarded === 'undefined')
        ? ''
        : String(r.pointsAwarded);

      const badge = (r.pointsAwarded === 1)
        ? '<span class="badge badge-good">✓</span>'
        : (r.pointsAwarded === 0 ? '<span class="badge badge-bad">✗</span>' : '');

      tr.innerHTML = `
        <td>${escapeHTML(r.userName || '')}</td>
        <td class="mono">${escapeHTML(r.userId || '')}</td>
        <td>${r.week || '-'}</td>
        <td>${escapeHTML(r.pick || '')}</td>
        <td class="right">${pts} ${badge}</td>
        <td class="mono">${escapeHTML(r.id || '')}</td>
      `;
      tb.appendChild(tr);
    });

    card.appendChild(table);
    container.appendChild(card);
  });
}

function showAccessDenied() {
  const container = $('mainContainer');
  container.innerHTML = `
    <div class="access-denied">
      <h1>Access Denied</h1>
      <p>Admin access requires a valid session or ADMIN_SECRET in the URL.</p>
      <p style="color:var(--text-muted);font-size:14px;margin-top:20px">
        Usage: admin_predictions.html?ADMIN_SECRET=your_secret_here
      </p>
    </div>
  `;
}

function initUI() {
  const container = $('mainContainer');
  container.innerHTML = `
    <div class="ts-page">
      <h2 class="ts-page-title">Match Predictions Inspector</h2>
      <p class="ts-muted">
        Enter one or more Match IDs (e.g. <span class="mono">88</span> or <span class="mono">88,89,90</span>) to see all predictions for those fixtures.
        Prediction IDs are shown so you can edit/delete them via admin tools.
      </p>

      <div class="ts-card">
        <div class="row">
          <div>
            <label for="matchIds" class="ts-label">Match ID(s)</label>
            <input id="matchIds" class="ts-input" placeholder="e.g. 88 or 88,89,90"/>
          </div>
          <div>
            <label for="secret" class="ts-label">Admin Secret</label>
            <input id="secret" class="ts-input" type="password" placeholder="x-admin-secret"/>
          </div>
          <div>
            <button id="loadBtn" class="ts-btn ts-btn-primary">Load Predictions</button>
          </div>
        </div>
        <div id="status" class="status ts-muted"></div>
      </div>

      <div id="results"></div>
    </div>
  `;

  $('loadBtn').addEventListener('click', async ()=>{
    const matchIdsRaw = $('matchIds').value.trim();
    const secret = $('secret').value.trim();

    if (!matchIdsRaw){
      setStatus('Please enter at least one Match ID.', 'error');
      return;
    }

    setStatus('Loading predictions...', 'ts-muted');
    $('results').innerHTML = '';

    try {
      const url = `${base}/admin-get-predictions-by-match?matchId=${encodeURIComponent(matchIdsRaw)}`;
      const data = await fetchJSON(url, secret);
      setStatus(`Loaded ${data.total || 0} predictions for matchId(s): ${data.requestedMatchIds.join(', ')}`, 'success');
      renderResults(data);
    } catch (e) {
      console.error(e);
      setStatus('Error: ' + e.message, 'error');
    }
  });
}

// Check auth and initialize page
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize auth to get user session and admin status
  try {
    await PFAuth.initAuth();
  } catch (e) {
    // initAuth may redirect if no session, but catch for safety
    console.warn('Auth init issue:', e);
  }

  // Render navigation
  PFAuth.renderNav();

  // Check if user is admin OR if ADMIN_SECRET is provided in URL
  const isAdmin = PFAuth.isAdmin();
  const hasUrlSecret = !!ADMIN_SECRET;

  if (!isAdmin && !hasUrlSecret) {
    showAccessDenied();
    return;
  }

  // Valid access — show UI
  initUI();
});
</script>
</body>
</html>
