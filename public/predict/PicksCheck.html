<!doctype html>
<html lang="en">
<!--
  TeleStats Fives – Picks Check

  Authentication:
    Supabase session with admin status (PFAuth.isAdmin())
    Fallback: ADMIN_SECRET URL parameter

  Purpose:
    Check which users have NOT submitted picks for a given matchweek.
    - Auto-loads the current/latest matchweek on page load
    - Shows total users, submitted count, and outstanding count
    - Lists all users who haven't submitted picks
    - Allows selecting any previous week to check historical data
-->
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TeleStats Fives – Picks Check</title>
<link rel="stylesheet" href="/predict/telestats-theme.css"/>
<style>
  body{margin:0;display:flex;justify-content:center}
  .ts-page{max-width:780px;width:100%;padding:20px 16px 40px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .ts-input,.ts-select{min-width:120px}
  .access-denied{text-align:center;padding:60px 20px}
  .access-denied h1{font-family:'Space Mono',monospace;font-size:28px;color:var(--danger);margin-bottom:12px}
  .access-denied p{color:var(--text-muted);font-size:14px}
  .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:16px 0}
  .stat-card{background:var(--bg-panel);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:16px;text-align:center}
  .stat-value{font-size:2em;font-weight:800;margin-bottom:4px;color:var(--text-primary)}
  .stat-label{color:var(--text-muted);font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
  .stat-card.success .stat-value{color:var(--accent-green)}
  .stat-card.warning .stat-value{color:#ff9800}
  .stat-card.danger .stat-value{color:var(--danger)}
  .user-list{margin-top:16px}
  .user-list h3{margin:0 0 12px;font-size:14px;color:var(--text-primary)}
  .user-chip{display:inline-block;background:var(--bg-panel);padding:6px 12px;border-radius:16px;margin:4px;font-size:13px;border:1px solid rgba(255,255,255,0.06)}
  .user-chip .id{color:var(--text-muted);margin-left:4px;font-size:11px}
  .match-breakdown{margin-top:16px}
  .match-item{background:var(--bg-panel);border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04)}
  .match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .match-fixture{font-weight:600;color:var(--text-primary)}
  .match-status{font-size:12px;padding:4px 8px;border-radius:4px;font-weight:600}
  .match-status.complete{background:rgba(50,255,126,0.15);color:var(--accent-green)}
  .match-status.incomplete{background:rgba(255,152,0,0.15);color:#ff9800}
  .match-missing{font-size:12px;color:var(--text-muted);margin-top:6px}
  #status{white-space:pre-wrap;margin-top:6px;color:var(--text-muted)}
  .loading{text-align:center;padding:40px;color:var(--text-muted)}
  @keyframes spin{to{transform:rotate(360deg)}}
  .spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.2);border-top-color:var(--accent-cyan);border-radius:50%;margin-right:8px;vertical-align:-3px;animation:spin .7s linear infinite}
  .all-good{background:rgba(50,255,126,0.08);border:1px solid rgba(50,255,126,0.2);border-radius:10px;padding:24px;text-align:center;margin-top:16px}
  .all-good h3{color:var(--accent-green);margin:0 0 8px}
  .all-good p{color:var(--text-muted);margin:0}
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/predict/auth.js"></script>
<script src="/predict/predict-data.js"></script>

<div id="mainContainer"></div>

<script>
const NETLIFY_BASE = '/.netlify/functions';

// Read ADMIN_SECRET from URL query param (backward compat for API calls)
function getAdminSecret() {
  const params = new URLSearchParams(location.search);
  const raw = params.get('ADMIN_SECRET');
  if (!raw) return '';
  try { return decodeURIComponent(raw); } catch { return raw; }
}

const ADMIN_SECRET = getAdminSecret();

// State
let availableWeeks = [];
let currentWeek = null;
let latestWeek = null;

// Helper: get element by ID
function $(id) {
  const el = document.getElementById(id);
  return el;
}

// Helper: safe fetch with Supabase JWT auth + admin secret fallback
async function adminFetch(url, options = {}) {
  const fullUrl = url.startsWith('http') ? url : `${NETLIFY_BASE}${url}`;

  // Get Supabase session token for auth
  let authToken = '';
  try {
    const { data: { session } } = await PFAuth.supabase.auth.getSession();
    if (session && session.access_token) authToken = session.access_token;
  } catch (e) { console.warn('Could not get Supabase token for admin fetch:', e); }

  const headers = {
    'Content-Type': 'application/json',
    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {}),
    ...(ADMIN_SECRET ? { 'x-admin-secret': ADMIN_SECRET } : {}),
    ...(options.headers || {})
  };

  const response = await fetch(fullUrl, { ...options, headers, cache: 'no-store' });
  const text = await response.text();

  let data;
  try {
    data = JSON.parse(text);
  } catch {
    data = { raw: text };
  }

  if (!response.ok) {
    throw new Error(data.error || `HTTP ${response.status}`);
  }

  return data;
}

// Show status message
function setStatus(msg) {
  const s = $('status');
  if (s) s.textContent = msg;
}

// Loading button wrapper
function withLoading(btn, fn) {
  if (!btn) return fn();
  const orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Loading...';
  return fn().finally(() => {
    btn.disabled = false;
    btn.innerHTML = orig;
  });
}

// Fetch available weeks
async function fetchWeeks() {
  try {
    const data = await PredictData.getWeeks();
    availableWeeks = data.weeks || [];
    latestWeek = data.recommendedPickWeek || data.latest || (availableWeeks.length ? availableWeeks[availableWeeks.length - 1] : 1);
    return { weeks: availableWeeks, latest: latestWeek };
  } catch (e) {
    setStatus(`Failed to fetch weeks: ${e.message}`);
    return { weeks: [], latest: 1 };
  }
}

// Load picks check data for a week
async function loadPicksCheck(week) {
  const checkBtn = $('checkBtn');
  return withLoading(checkBtn, async () => {
    try {
      const data = await PredictData.getMissingPredictions(week);
      renderResults(data, week);
      currentWeek = week;
    } catch (e) {
      setStatus(`Failed to load picks data: ${e.message}`);
      $('results').innerHTML = '';
    }
  });
}

// Calculate unique missing users across all matches
function getUniqueMissingUsers(matches) {
  const seen = new Map();
  for (const m of matches) {
    for (const u of (m.missingUsers || [])) {
      if (!seen.has(u.id)) {
        seen.set(u.id, u);
      }
    }
  }
  return Array.from(seen.values());
}

// Render results
function renderResults(data, week) {
  const resultsDiv = $('results');

  const totalUsers = data.expectedUsers || 0;
  const matches = data.matches || [];
  const uniqueMissing = getUniqueMissingUsers(matches);
  const submittedUsers = totalUsers - uniqueMissing.length;
  const outstandingUsers = uniqueMissing.length;

  // Determine stat card classes based on completion
  const completionPct = totalUsers > 0 ? (submittedUsers / totalUsers) * 100 : 0;
  const outstandingClass = outstandingUsers === 0 ? 'success' : outstandingUsers > 5 ? 'danger' : 'warning';

  let html = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">${totalUsers}</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card success">
        <div class="stat-value">${submittedUsers}</div>
        <div class="stat-label">Submitted</div>
      </div>
      <div class="stat-card ${outstandingClass}">
        <div class="stat-value">${outstandingUsers}</div>
        <div class="stat-label">Outstanding</div>
      </div>
    </div>
  `;

  if (outstandingUsers === 0) {
    html += `
      <div class="all-good">
        <h3>All users have submitted picks!</h3>
        <p>Week ${week} has 100% participation - no outstanding submissions.</p>
      </div>
    `;
  } else {
    // Outstanding users list
    html += `
      <div class="user-list">
        <h3>Outstanding Users (${outstandingUsers})</h3>
        <div class="user-chips">
          ${uniqueMissing.map(u => `
            <span class="user-chip">${u.name}<span class="id">#${u.id}</span></span>
          `).join('')}
        </div>
      </div>
    `;

    // Per-match breakdown
    html += `
      <div class="match-breakdown">
        <h3 style="margin:16px 0 12px;font-size:14px;color:var(--text-primary)">Per-Match Breakdown</h3>
        ${matches.map(m => {
          const isComplete = m.missingCount === 0;
          return `
            <div class="match-item">
              <div class="match-header">
                <span class="match-fixture">${m.fixture}</span>
                <span class="match-status ${isComplete ? 'complete' : 'incomplete'}">
                  ${m.predictionsCount}/${m.expectedUsers} picks
                </span>
              </div>
              ${!isComplete ? `
                <div class="match-missing">
                  Missing: ${m.missingUsers.map(u => u.name).join(', ')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  resultsDiv.innerHTML = html;
  setStatus(`Week ${week}: ${submittedUsers}/${totalUsers} users submitted (${Math.round(completionPct)}%)`);
}

// Initialize UI
function initUI() {
  const container = $('mainContainer');
  container.innerHTML = `
    <div class="ts-page">
      <h2 class="ts-page-title">Picks Check</h2>
      <p class="ts-muted" style="margin:0 0 16px">Check which users have not submitted picks for a matchweek.</p>

      <div class="ts-card">
        <div class="row">
          <div>
            <label class="ts-label">Week</label>
            <select id="weekSelect" class="ts-select">
              <option value="">Loading...</option>
            </select>
          </div>
          <div>
            <button class="ts-btn ts-btn-primary" id="checkBtn">Check Picks</button>
          </div>
        </div>
        <div id="status" style="margin-top:6px"></div>
      </div>

      <div id="results"></div>

      <div class="ts-card" style="margin-top:16px">
        <p style="margin:0;font-size:12px;color:var(--text-muted)">
          <strong>Tip:</strong> This page shows unique users who haven't submitted any picks for the selected week.
          The per-match breakdown shows which specific matches each user is missing.
        </p>
      </div>
    </div>
  `;

  setupEventListeners();
}

// Setup event listeners
function setupEventListeners() {
  const checkBtn = $('checkBtn');
  const weekSelect = $('weekSelect');

  checkBtn.onclick = () => {
    const week = Number(weekSelect.value);
    if (week) {
      loadPicksCheck(week);
    }
  };

  weekSelect.onchange = () => {
    const week = Number(weekSelect.value);
    if (week) {
      loadPicksCheck(week);
    }
  };
}

// Populate week dropdown
function populateWeekDropdown(weeks, selectedWeek) {
  const weekSelect = $('weekSelect');
  if (!weekSelect) return;

  weekSelect.innerHTML = weeks
    .slice()
    .reverse()
    .map(w => `<option value="${w}" ${w === selectedWeek ? 'selected' : ''}>Week ${w}${w === latestWeek ? ' (Latest)' : ''}</option>`)
    .join('');
}

// Show access denied page
function showAccessDenied() {
  const container = $('mainContainer');
  container.innerHTML = `
    <div class="access-denied">
      <h1>Access Denied</h1>
      <p>You need admin privileges to access this page.</p>
      <p style="margin-top:20px">
        <a href="/predict/" style="color:var(--accent-cyan)">Back to Picks</a>
      </p>
    </div>
  `;
}

// Validate admin secret (backward compat for URL-based access)
async function validateSecret() {
  if (!ADMIN_SECRET) return false;
  return true;
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize auth to get user session and admin status
  try {
    await PFAuth.initAuth();
  } catch (e) {
    // initAuth may redirect if no session, but catch for safety
    console.warn('Auth init issue:', e);
  }

  // Render navigation
  PFAuth.renderNav();

  // Check if user is admin OR if ADMIN_SECRET is provided in URL
  const isAdmin = PFAuth.isAdmin();
  const hasUrlSecret = !!ADMIN_SECRET;

  if (!isAdmin && !hasUrlSecret) {
    showAccessDenied();
    return;
  }

  // If using URL secret, validate it
  if (hasUrlSecret && !isAdmin) {
    $('mainContainer').innerHTML = '<div class="loading"><span class="spinner"></span>Validating access...</div>';
    const isValid = await validateSecret();
    if (!isValid) {
      showAccessDenied();
      return;
    }
  }

  // Valid access - show UI
  initUI();

  // Fetch available weeks
  setStatus('Loading weeks...');
  const { weeks, latest } = await fetchWeeks();

  if (weeks.length > 0) {
    populateWeekDropdown(weeks, latest);
    // Auto-load the latest week
    await loadPicksCheck(latest);
  } else {
    setStatus('No weeks found in the system.');
  }
});
</script>
</body>
</html>
