<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeleStats Fives – Picks</title>
  <link rel="stylesheet" href="/predict/telestats-theme.css"/>
  <style>
    #picks { width: 100%; }
    .ts-picks-panel pre { white-space: pre-wrap; word-break: break-word; font-family: 'Space Mono', monospace; font-size: 13px; }
  </style>
</head>
<body>
  <div id="picks" class="ts-page">
    <div class="ts-picks-panel" id="status">
      <span class="ts-spinner"></span> Loading…
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/predict/auth.js"></script>
  <script src="/predict/picks-widget.js"></script>

  <script>
    (async function init() {
      const ORIGIN = location.origin;
      const FN = (name) => `${ORIGIN}/.netlify/functions/${name}`;

      const statusEl = document.getElementById('status');
      const setStatus = (msg, extra) => {
        if (!statusEl) return;
        statusEl.innerHTML = msg + (extra ? `<pre class="ts-muted">${extra}</pre>` : '');
      };

      // Authenticate via Supabase (falls back to ?userId= URL param for Adalo compat)
      const userId = await PFAuth.initAuth();
      PFAuth.renderNav();

      const qs = new URLSearchParams(location.search);
      const urlWeek = qs.get('week');

      // Wait for widget to load
      async function waitForWidget(ms = 8000) {
        const start = Date.now();
        while (Date.now() - start < ms) {
          if (window.PredictFootballPicks && typeof window.PredictFootballPicks.render === 'function') return true;
          await new Promise(r => setTimeout(r, 100));
        }
        return false;
      }

      // Choose week
      let weekToUse = urlWeek ? Number(urlWeek) : null;

      // Prefer user's Current Week (if you have it)
      if (!weekToUse) {
        try {
          const r = await fetch(`${FN('get-user')}?userId=${encodeURIComponent(userId)}`, { cache:'no-store' });
          if (r.ok) {
            const j = await r.json();
            const cw = j?.user?.['Current Week'] ?? j?.user?.['Current_Week'] ?? j?.user?.currentWeek;
            if (cw) weekToUse = Number(cw);
          }
        } catch (e) {
          console.warn('get-user lookup failed', e);
        }
      }

      // Fallback to weeks endpoint
      if (!weekToUse) {
        try {
          const r = await fetch(FN('weeks'), { cache:'no-store' });
          if (!r.ok) throw new Error(`weeks ${r.status}`);
          const j = await r.json();
          weekToUse = j?.recommendedPickWeek || j?.latest || 1;
        } catch (e) {
          console.warn('weeks lookup failed', e);
          weekToUse = 1;
        }
      }

      const ready = await waitForWidget();
      if (!ready) {
        setStatus(
          'Error: picks widget script did not load.',
          'Expected window.PredictFootballPicks.render()\nCheck that /picks-widget.js exists and has no JS errors.'
        );
        return;
      }

      try {
        window.PredictFootballPicks.render(
          document.getElementById('picks'),
          { base: `${ORIGIN}/.netlify/functions`, week: weekToUse, userId }
        );
        const panel = document.getElementById('status');
        if (panel && panel.parentNode) panel.parentNode.removeChild(panel);
      } catch (e) {
        console.error(e);
        setStatus('Error rendering picks widget.', String(e));
      }
    })();
  </script>
</body>
</html>
