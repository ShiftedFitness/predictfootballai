<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PredictFootball.ai – Picks</title>
  <style>
    body { margin:0; padding:0; background:#111; color:#fff;
      font-family: Inter, system-ui, Arial; display:flex; justify-content:center; }
    #picks { width:100%; }
    .panel { max-width:750px; width:100%; margin:24px 12px; background:#30A278; color:#fff; border-radius:14px; padding:16px; }
    .muted { opacity:.85 }
    pre { white-space:pre-wrap; word-break:break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .btn { display:inline-block; margin-top:10px; background:#fff; color:#000; border:0; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; }
  </style>
</head>
<body>
  <div id="picks">
    <div class="panel" id="status">Loading…</div>
  </div>

  <script src="/predict/picks-widget.js"></script>

  <script>
    (async function init() {
      const ORIGIN = location.origin;
      const FN = (name) => `${ORIGIN}/.netlify/functions/${name}`;

      const statusEl = document.getElementById('status');
      const setStatus = (msg, extra) => {
        if (!statusEl) return;
        statusEl.innerHTML = msg + (extra ? `<pre class="muted">${extra}</pre>` : '');
      };

      const qs = new URLSearchParams(location.search);
      const urlWeek = qs.get('week');
      const urlUser = qs.get('userId');

      // ✅ Hard stop if userId is missing/invalid
      const userIdOk = (urlUser && urlUser !== 'undefined' && urlUser !== 'null' && String(urlUser).trim() !== '');
      if (!userIdOk) {
        setStatus(
          `<strong>You need to log in to see and submit picks.</strong><br/><span class="muted">Please return to the app and log in, then open Picks again.</span>`
        );
        return;
      }
      const userId = String(urlUser).trim();

      // Wait for widget to load
      async function waitForWidget(ms = 8000) {
        const start = Date.now();
        while (Date.now() - start < ms) {
          if (window.PredictFootballPicks && typeof window.PredictFootballPicks.render === 'function') return true;
          await new Promise(r => setTimeout(r, 100));
        }
        return false;
      }

      // Choose week
      let weekToUse = urlWeek ? Number(urlWeek) : null;

      // Prefer user's Current Week (if you have it)
      if (!weekToUse) {
        try {
          // ✅ You will add/confirm this function exists:
          // GET /.netlify/functions/get-user?userId=XX  -> { ok:true, user:{ "Current Week": 16, ... } }
          const r = await fetch(`${FN('get-user')}?userId=${encodeURIComponent(userId)}`, { cache:'no-store' });
          if (r.ok) {
            const j = await r.json();
            const cw = j?.user?.['Current Week'] ?? j?.user?.['Current_Week'] ?? j?.user?.currentWeek;
            if (cw) weekToUse = Number(cw);
          }
        } catch (e) {
          console.warn('get-user lookup failed', e);
        }
      }

      // Fallback to weeks endpoint
      if (!weekToUse) {
        try {
          const r = await fetch(FN('weeks'), { cache:'no-store' });
          if (!r.ok) throw new Error(`weeks ${r.status}`);
          const j = await r.json();
          weekToUse = j?.recommendedPickWeek || j?.latest || 1;
        } catch (e) {
          console.warn('weeks lookup failed', e);
          weekToUse = 1;
        }
      }

      const ready = await waitForWidget();
      if (!ready) {
        setStatus(
          'Error: picks widget script did not load.',
          'Expected window.PredictFootballPicks.render()\nCheck that /picks-widget.js exists and has no JS errors.'
        );
        return;
      }

      try {
        window.PredictFootballPicks.render(
          document.getElementById('picks'),
          { base: `${ORIGIN}/.netlify/functions`, week: weekToUse, userId }
        );
        const panel = document.getElementById('status');
        if (panel && panel.parentNode) panel.parentNode.removeChild(panel);
      } catch (e) {
        console.error(e);
        setStatus('Error rendering picks widget.', String(e));
      }
    })();
  </script>
</body>
</html>
