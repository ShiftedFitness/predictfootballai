<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TeleStats Fives – Log In</title>
<link rel="stylesheet" href="/predict/telestats-theme.css"/>
<style>
  body {
    justify-content: center;
    align-items: flex-start;
    padding-top: 48px;
  }
  .login-wrap {
    max-width: 420px;
    width: 100%;
    margin: 0 16px;
  }
  .login-header {
    text-align: center;
    margin-bottom: 24px;
  }
  .login-header img {
    height: 40px;
    width: auto;
    margin-bottom: 12px;
  }
  .login-header h1 {
    font-family: 'Space Mono', monospace;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: -0.5px;
    margin-bottom: 4px;
  }
  .login-header h1 .accent { color: var(--accent-cyan); }
  .login-header .subtitle {
    color: var(--text-muted);
    font-size: 14px;
  }

  .login-card {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: 14px;
    padding: 28px 24px;
  }
  .form-group { margin-bottom: 16px; }
  .form-group label {
    display: block;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .form-group input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    background: var(--bg-panel);
    color: var(--text-primary);
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 15px;
    outline: none;
    transition: border-color 0.15s;
  }
  .form-group input::placeholder { color: var(--text-muted); }
  .form-group input:focus { border-color: var(--accent-cyan); }

  .login-btn {
    width: 100%;
    padding: 13px;
    border: none;
    border-radius: 10px;
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .login-btn:hover { opacity: 0.9; }
  .login-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .login-btn-primary {
    background: var(--accent-yellow);
    color: #0B0F12;
  }
  .login-btn-secondary {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    font-size: 13px;
    color: var(--text-muted);
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,255,255,0.1);
  }

  .link-btn {
    background: none;
    border: none;
    color: var(--accent-cyan);
    font-size: 13px;
    text-decoration: none;
    cursor: pointer;
    padding: 0;
    opacity: 0.85;
    font-family: 'Inter', system-ui, sans-serif;
  }
  .link-btn:hover { opacity: 1; }

  .msg { padding: 10px 14px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: none; }
  .msg-error { background: rgba(224, 85, 85, 0.15); border: 1px solid rgba(224, 85, 85, 0.3); color: var(--danger); }
  .msg-success { background: rgba(50, 255, 126, 0.1); border: 1px solid rgba(50, 255, 126, 0.2); color: var(--accent-green); }

  .views > div { display: none; }
  .views > div.active { display: block; }

  .login-footer {
    margin-top: 20px;
    text-align: center;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    opacity: 0.5;
  }
</style>
</head>
<body>

<div class="login-wrap">
  <div class="login-header">
    <img src="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png" alt="TeleStats"/>
    <h1>Tele<span class="accent">Stats</span> Fives</h1>
    <p class="subtitle">Sign in to make your picks</p>
  </div>

  <div class="login-card">
    <!-- Messages -->
    <div id="msgError" class="msg msg-error"></div>
    <div id="msgSuccess" class="msg msg-success"></div>

    <div class="views">

      <!-- LOGIN VIEW -->
      <div id="viewLogin" class="active">
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="your@email.com" required autocomplete="email"/>
          </div>
          <div class="form-group">
            <label for="loginPass">Password</label>
            <input type="password" id="loginPass" placeholder="Password" required autocomplete="current-password"/>
          </div>
          <button type="submit" class="login-btn login-btn-primary" id="loginBtn">Sign In</button>
        </form>

        <div style="margin-top:12px; text-align:right;">
          <button class="link-btn" onclick="showView('forgot')">Forgot password?</button>
        </div>

        <div class="divider">or</div>

        <button class="login-btn login-btn-secondary" id="magicBtn" onclick="sendMagicLink()">
          Send me a magic link instead
        </button>
      </div>

      <!-- FORGOT PASSWORD VIEW -->
      <div id="viewForgot">
        <p style="margin:0 0 16px; font-size:14px; color:var(--text-secondary);">
          Enter your email and we'll send you a link to set a new password.
        </p>
        <form id="forgotForm">
          <div class="form-group">
            <label for="forgotEmail">Email</label>
            <input type="email" id="forgotEmail" placeholder="your@email.com" required autocomplete="email"/>
          </div>
          <button type="submit" class="login-btn login-btn-primary" id="forgotBtn">Send Reset Link</button>
        </form>
        <div style="margin-top:12px;">
          <button class="link-btn" onclick="showView('login')">Back to sign in</button>
        </div>
      </div>

      <!-- MAGIC LINK SENT VIEW -->
      <div id="viewMagicSent">
        <p style="font-size:15px; line-height:1.5; color:var(--text-secondary);">
          Check your inbox for a magic link. Click the link in the email to sign in — no password needed.
        </p>
        <button class="login-btn login-btn-secondary" onclick="showView('login')" style="margin-top:8px;">Back to sign in</button>
      </div>

      <!-- RESET SENT VIEW -->
      <div id="viewResetSent">
        <p style="font-size:15px; line-height:1.5; color:var(--text-secondary);">
          Password reset email sent. Check your inbox and follow the link to set a new password.
        </p>
        <button class="login-btn login-btn-secondary" onclick="showView('login')" style="margin-top:8px;">Back to sign in</button>
      </div>

      <!-- UPDATE PASSWORD VIEW (shown after clicking reset link) -->
      <div id="viewUpdatePassword">
        <p style="margin:0 0 16px; font-size:14px; color:var(--text-secondary);">
          Choose a new password for your account.
        </p>
        <form id="updatePasswordForm">
          <div class="form-group">
            <label for="newPass">New Password</label>
            <input type="password" id="newPass" placeholder="New password (min 6 chars)" required minlength="6" autocomplete="new-password"/>
          </div>
          <div class="form-group">
            <label for="confirmPass">Confirm Password</label>
            <input type="password" id="confirmPass" placeholder="Confirm new password" required minlength="6" autocomplete="new-password"/>
          </div>
          <button type="submit" class="login-btn login-btn-primary" id="updatePassBtn">Set New Password</button>
        </form>
      </div>

      <!-- PASSWORD UPDATED VIEW -->
      <div id="viewPasswordUpdated">
        <p style="font-size:15px; line-height:1.5; color:var(--text-secondary);">
          Your password has been updated. You can now sign in with your new password.
        </p>
        <button class="login-btn login-btn-primary" onclick="location.href='/predict/'" style="margin-top:8px;">Continue to App</button>
      </div>

    </div>

    <div class="login-footer">TeleStats Fives</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/predict/auth.js"></script>
<script>
(async function () {
  const sb = PFAuth.supabase;
  const qs = new URLSearchParams(location.search);
  const redirectTo = qs.get('redirect') || '/predict/';

  // Define showView EARLY so it's available when onAuthStateChange fires
  window.showView = function (name) {
    document.getElementById('msgError').style.display = 'none';
    document.getElementById('msgSuccess').style.display = 'none';
    document.querySelectorAll('.views > div').forEach(d => d.classList.remove('active'));
    const el = document.getElementById('view' + name.charAt(0).toUpperCase() + name.slice(1));
    if (el) el.classList.add('active');
  };

  // Check URL hash for recovery type BEFORE getSession() processes the tokens
  const hashParams = new URLSearchParams(location.hash.substring(1));
  const isRecovery = hashParams.get('type') === 'recovery';

  // Register onAuthStateChange BEFORE getSession() to catch all events
  let recoveryHandled = false;
  let updatingPassword = false;
  sb.auth.onAuthStateChange(async (event, session) => {
    if (updatingPassword) return;
    if ((event === 'SIGNED_IN' || event === 'PASSWORD_RECOVERY') && session) {
      if (event === 'PASSWORD_RECOVERY') {
        recoveryHandled = true;
        showView('updatePassword');
        return;
      }
      await handleSuccessfulAuth(session);
    }
  });

  // Now process the session (this consumes hash tokens)
  const { data: { session } } = await sb.auth.getSession();

  // If URL indicated recovery but onAuthStateChange didn't fire yet, show form
  if (isRecovery && session && !recoveryHandled) {
    showView('updatePassword');
    return;
  }

  if (session && session.user && !isRecovery) {
    const email = session.user.email;
    const emailVariants = [email];
    if (email.endsWith('@googlemail.com')) {
      emailVariants.push(email.replace('@googlemail.com', '@gmail.com'));
    } else if (email.endsWith('@gmail.com')) {
      emailVariants.push(email.replace('@gmail.com', '@googlemail.com'));
    }
    const { data: row } = await sb
      .from('predict_users')
      .select('id')
      .in('email', emailVariants)
      .maybeSingle();
    if (row) {
      location.href = redirectTo;
      return;
    }
  }

  /* ---- Helpers ---- */
  function showMsg(type, text) {
    const errEl = document.getElementById('msgError');
    const sucEl = document.getElementById('msgSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if (type === 'error') { errEl.textContent = text; errEl.style.display = 'block'; }
    if (type === 'success') { sucEl.textContent = text; sucEl.style.display = 'block'; }
  }

  function clearMsg() {
    document.getElementById('msgError').style.display = 'none';
    document.getElementById('msgSuccess').style.display = 'none';
  }

  async function handleSuccessfulAuth(session) {
    const email = session.user.email;
    const emailVariants = [email];
    if (email.endsWith('@googlemail.com')) {
      emailVariants.push(email.replace('@googlemail.com', '@gmail.com'));
    } else if (email.endsWith('@gmail.com')) {
      emailVariants.push(email.replace('@gmail.com', '@googlemail.com'));
    }
    const { data: row } = await sb
      .from('predict_users')
      .select('id, adalo_id, email, username, full_name, is_admin')
      .in('email', emailVariants)
      .maybeSingle();

    if (!row) {
      showMsg('error', 'Your email is not registered in the game. Contact the admin.');
      await sb.auth.signOut();
      return;
    }

    const effectiveId = row.adalo_id || row.id;

    localStorage.setItem('pf_user', JSON.stringify({
      userId: effectiveId,
      email: row.email,
      username: row.username,
      fullName: row.full_name,
      isAdmin: row.is_admin
    }));

    location.href = redirectTo;
  }

  /* ---- Login form ---- */
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearMsg();
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    const btn = document.getElementById('loginBtn');

    btn.disabled = true;
    btn.textContent = 'Signing in…';

    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });

    btn.disabled = false;
    btn.textContent = 'Sign In';

    if (error) {
      showMsg('error', error.message === 'Invalid login credentials'
        ? 'Invalid email or password. Try "Forgot password" or a magic link if this is your first time.'
        : error.message);
      return;
    }

    await handleSuccessfulAuth(data.session);
  });

  /* ---- Forgot password form ---- */
  document.getElementById('forgotForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearMsg();
    const email = document.getElementById('forgotEmail').value.trim();
    const btn = document.getElementById('forgotBtn');

    btn.disabled = true;
    btn.textContent = 'Sending…';

    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + '/predict/login.html'
    });

    btn.disabled = false;
    btn.textContent = 'Send Reset Link';

    if (error) {
      showMsg('error', error.message);
      return;
    }

    showView('resetSent');
  });

  /* ---- Update password form ---- */
  document.getElementById('updatePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearMsg();
    const newPass = document.getElementById('newPass').value;
    const confirmPass = document.getElementById('confirmPass').value;
    const btn = document.getElementById('updatePassBtn');

    if (newPass !== confirmPass) {
      showMsg('error', 'Passwords do not match.');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Updating…';

    updatingPassword = true;
    const { error } = await sb.auth.updateUser({ password: newPass });
    updatingPassword = false;

    btn.disabled = false;
    btn.textContent = 'Set New Password';

    if (error) {
      showMsg('error', error.message);
      return;
    }

    showView('passwordUpdated');
  });

  /* ---- Magic link ---- */
  window.sendMagicLink = async function () {
    clearMsg();
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) {
      showMsg('error', 'Enter your email address first, then click "Send me a magic link".');
      return;
    }

    const btn = document.getElementById('magicBtn');
    btn.disabled = true;
    btn.textContent = 'Sending…';

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: location.origin + '/predict/login.html?redirect=' + encodeURIComponent(redirectTo) }
    });

    btn.disabled = false;
    btn.textContent = 'Send me a magic link instead';

    if (error) {
      showMsg('error', error.message);
      return;
    }

    showView('magicSent');
  };
})();
</script>
</body>
</html>
