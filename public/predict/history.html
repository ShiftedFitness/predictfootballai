<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PredictFootball.ai – History</title>
<style>
  :root{ --bg:#30A278; --card:#000; --border:#1a1a1a; --text:#fff; --muted:#EAEAEA; --accent:#fff; --accentText:#000; }
  html, body { height:100% }
  body{ margin:0; background:#111; color:#fff; font-family:Inter,system-ui,Arial; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
  .wrap{ max-width:750px; width:100%; margin:24px 12px; background:var(--bg); color:var(--text); border-radius:14px; padding:16px; }
  h2{ margin:0 0 12px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between }
  .muted{ color:var(--muted) }
  .controls{ gap:8px; margin-bottom:8px }
  select{ background:#0e0e0e; color:#fff; border:1px solid #2a2a2a; border-radius:8px; padding:8px 10px; }
  .btn{ background:var(--accent); color:var(--accentText); border:0; font-weight:800; padding:8px 12px; border-radius:8px; cursor:pointer }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .stat{ background:#0e0e0e; border:1px solid #1f1f1f; padding:10px; border-radius:10px; text-align:center }
  .stat h4{ margin:0; font-size:12px; color:#cfcfcf; text-transform:uppercase; letter-spacing:.3px }
  .stat .v{ font-size:18px; font-weight:800; margin-top:4px }

  .table{ width:100%; border-collapse:collapse; font-size:14px; }
  .table th, .table td{ padding:10px 8px; border-bottom:1px solid #1f1f1f; text-align:left; }
  .table th{ font-size:12px; color:#cfcfcf; text-transform:uppercase; letter-spacing:.3px }
  .table tr:last-child td{ border-bottom:none }

  .center{ text-align:center }
  .good{ color:#7CFC00 }  /* lime for correct */
  .bad{ color:#FF6B6B }   /* red for wrong */
  .pick-badge{ margin-left:6px; font-weight:900 }
</style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/predict/auth.js"></script>
  <div class="wrap">
    <h2>Historical Results</h2>

    <div class="card">
      <div class="row controls">
        <div>
          <label class="muted" for="weekSel">Week</label><br/>
          <select id="weekSel"></select>
        </div>
        <div>
          <label class="muted" for="compareSel">Compare With</label><br/>
          <select id="compareSel" style="min-width:220px"></select>
        </div>
        <div>
          <button id="applyBtn" class="btn">Apply</button>
        </div>
      </div>
      <div class="muted" id="weekInfo"></div>
    </div>

    <div class="card">
      <div class="grid2">
        <div class="stat"><h4>Your Points</h4><div id="myPts" class="v">-</div></div>
        <div class="stat"><h4><span id="compNamePts">Compare</span> Points</h4><div id="hisPts" class="v">-</div></div>
        <div class="stat"><h4>Your Accuracy</h4><div id="myAcc" class="v">-</div></div>
        <div class="stat"><h4><span id="compNameAcc">Compare</span> Accuracy</h4><div id="hisAcc" class="v">-</div></div>
      </div>
    </div>

    <div class="card">
      <table class="table" id="matchTbl">
        <thead>
          <tr>
            <th>Fixture</th>
            <th class="center">Your Pick</th>
            <th class="center">Correct</th>
            <th class="center"><span id="compNameCol">Compare</span> Pick</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" id="legends" style="margin-top:6px"></div>
    </div>
  </div>

<script>
const base = '/.netlify/functions';
const qs   = new URLSearchParams(location.search);
let userId         = qs.get('userId') || '';
const currentWeek  = qs.get('week') || '';
const compareIdQ   = qs.get('compareId') || '1';

(async () => {
  userId = await PFAuth.initAuth();
  PFAuth.renderNav();
  load({ currentWeek, viewWeek: qs.get('viewWeek'), compareId: compareIdQ });
})();

async function fetchJSON(u){ const r = await fetch(u, { cache:'no-store' }); if(!r.ok) throw new Error(await r.text()); return r.json(); }

async function load({ currentWeek, viewWeek, compareId }) {
  const url = new URL(`${base}/history`, location.origin);
  url.searchParams.set('userId', userId);
  if (currentWeek) url.searchParams.set('week', currentWeek);
  if (viewWeek)    url.searchParams.set('viewWeek', viewWeek);
  if (compareId)   url.searchParams.set('compareId', compareId);

  const data = await fetchJSON(url.toString());

  // Weeks dropdown (descending), select the week actually shown
  const weekSel = document.getElementById('weekSel');
  weekSel.innerHTML = '';
  (data.availableWeeks || []).forEach(w=>{
    const opt = document.createElement('option');
    opt.value = w; opt.textContent = `Week ${w}`;
    if (Number(w) === Number(data.viewWeek)) opt.selected = true;
    weekSel.appendChild(opt);
  });

  // Compare dropdown (names), select current compare id
  const compareSel = document.getElementById('compareSel');
  compareSel.innerHTML = '';
  (data.users || []).forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.id; opt.textContent = u.name;
    if (String(u.id) === String(data.compare?.id)) opt.selected = true;
    compareSel.appendChild(opt);
  });

  // Info line
  document.getElementById('weekInfo').textContent =
    `Viewing Week ${data.viewWeek} • ${data.weekLocked ? 'Locked (results in)' : 'Open'}`;

  // Stat card labels to use compare user's name
  document.getElementById('compNamePts').textContent  = data.compare.name || 'Compare';
  document.getElementById('compNameAcc').textContent  = data.compare.name || 'Compare';
  document.getElementById('compNameCol').textContent  = data.compare.name || 'Compare';

  // Stats
  document.getElementById('myPts').textContent  = data.me.points;
  document.getElementById('hisPts').textContent = data.compare.points;
  document.getElementById('myAcc').textContent  = (Math.round(data.me.accuracy*1000)/10).toFixed(1) + '%';
  document.getElementById('hisAcc').textContent = (Math.round(data.compare.accuracy*1000)/10).toFixed(1) + '%';

  // Table rows — put ✓/✗ next to each pick (you + compare)
  const tb = document.querySelector('#matchTbl tbody');
  tb.innerHTML = '';
  (data.rows || []).forEach(r=>{
    const yourOk = !!r.myPick && !!r.correct && r.myPick === r.correct;
    const hisOk  = !!r.hisPick && !!r.correct && r.hisPick === r.correct;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(r.fixture)}</td>
      <td class="center">${escapeHTML(label(r.myPick))}${badge(yourOk)}</td>
      <td class="center">${escapeHTML(label(r.correct))}</td>
      <td class="center">${escapeHTML(label(r.hisPick))}${badge(hisOk)}</td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById('legends').textContent =
    `${data.me.name} vs ${data.compare.name} • Picks shown as HOME / DRAW / AWAY`;

  // Apply = force exact week + selected compare
  document.getElementById('applyBtn').onclick = ()=>{
    const selectedWeek = weekSel.value;
    const selectedCompareId = compareSel.value || '1';
    const next = new URL(location.href);
    next.searchParams.set('userId', userId);
    next.searchParams.set('week', currentWeek || '');   // keep the "current week" for defaulting
    next.searchParams.set('viewWeek', selectedWeek);     // explicitly show this week next load
    next.searchParams.set('compareId', selectedCompareId);
    location.href = next.toString();
  };
}

function label(x){ return (x || '-'); }
function badge(ok){ return ok ? ' <span class="pick-badge good">✓</span>' : ' <span class="pick-badge bad">✗</span>'; }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
