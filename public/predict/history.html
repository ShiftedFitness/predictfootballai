<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TeleStats Fives â€“ History</title>
<link rel="stylesheet" href="/predict/telestats-theme.css"/>
<style>
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between }
  .controls{ gap:8px; margin-bottom:8px }
  .center{ text-align:center }
  .good{ color:var(--accent-green) }
  .bad{ color:var(--danger) }
  .pick-badge{ margin-left:6px; font-weight:900 }
</style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/predict/auth.js"></script>
  <script src="/predict/predict-data.js"></script>

  <div class="ts-page">
    <h2 class="ts-page-title">Pick History</h2>

    <div class="ts-card">
      <div class="row controls">
        <div>
          <label class="ts-label" for="weekSel">Week</label>
          <select id="weekSel" class="ts-select"></select>
        </div>
        <div>
          <label class="ts-label" for="compareSel">Compare With</label>
          <select id="compareSel" class="ts-select" style="min-width:200px"></select>
        </div>
        <div style="align-self:flex-end;">
          <button id="applyBtn" class="ts-btn ts-btn-primary">Apply</button>
        </div>
      </div>
      <div class="ts-muted" id="weekInfo"></div>
    </div>

    <div class="ts-card">
      <div class="ts-stats">
        <div class="ts-stat"><div class="ts-stat-label">Your Points</div><div id="myPts" class="ts-stat-value">-</div></div>
        <div class="ts-stat"><div class="ts-stat-label"><span id="compNamePts">Compare</span> Points</div><div id="hisPts" class="ts-stat-value">-</div></div>
        <div class="ts-stat"><div class="ts-stat-label">Your Accuracy</div><div id="myAcc" class="ts-stat-value">-</div></div>
        <div class="ts-stat"><div class="ts-stat-label"><span id="compNameAcc">Compare</span> Accuracy</div><div id="hisAcc" class="ts-stat-value">-</div></div>
      </div>
    </div>

    <div class="ts-card">
      <table class="ts-table" id="matchTbl">
        <thead>
          <tr>
            <th>Fixture</th>
            <th class="center">Your Pick</th>
            <th class="center">Correct</th>
            <th class="center"><span id="compNameCol">Compare</span> Pick</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="ts-muted" id="legends" style="margin-top:6px"></div>
    </div>
  </div>

<script>
const base = '/.netlify/functions';
const qs   = new URLSearchParams(location.search);
let userId         = qs.get('userId') || '';
const currentWeek  = qs.get('week') || '';
const compareIdQ   = qs.get('compareId') || '1';

(async () => {
  userId = await PFAuth.initAuth();
  PFAuth.renderNav();
  load({ currentWeek, viewWeek: qs.get('viewWeek'), compareId: compareIdQ });
})();

async function load({ currentWeek, viewWeek, compareId }) {
  let data;
  try {
    data = await PredictData.getHistory(userId, viewWeek || currentWeek, compareId);
  } catch (e) {
    console.error('getHistory failed', e);
    alert('Failed to load history');
    return;
  }

  // Weeks dropdown
  const weekSel = document.getElementById('weekSel');
  weekSel.innerHTML = '';
  (data.availableWeeks || []).forEach(w=>{
    const opt = document.createElement('option');
    opt.value = w; opt.textContent = `Week ${w}`;
    if (Number(w) === Number(data.viewWeek)) opt.selected = true;
    weekSel.appendChild(opt);
  });

  // Compare dropdown
  const compareSel = document.getElementById('compareSel');
  compareSel.innerHTML = '';
  (data.users || []).forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.id; opt.textContent = u.name;
    if (String(u.id) === String(data.compare?.id)) opt.selected = true;
    compareSel.appendChild(opt);
  });

  // Info line
  document.getElementById('weekInfo').textContent =
    `Viewing Week ${data.viewWeek} \u2022 ${data.weekLocked ? 'Locked (results in)' : 'Open'}`;

  // Stat card labels
  document.getElementById('compNamePts').textContent  = data.compare.name || 'Compare';
  document.getElementById('compNameAcc').textContent  = data.compare.name || 'Compare';
  document.getElementById('compNameCol').textContent  = data.compare.name || 'Compare';

  // Stats
  document.getElementById('myPts').textContent  = data.me.points;
  document.getElementById('hisPts').textContent = data.compare.points;
  document.getElementById('myAcc').textContent  = (Math.round(data.me.accuracy*1000)/10).toFixed(1) + '%';
  document.getElementById('hisAcc').textContent = (Math.round(data.compare.accuracy*1000)/10).toFixed(1) + '%';

  // Table rows
  const tb = document.querySelector('#matchTbl tbody');
  tb.innerHTML = '';
  (data.rows || []).forEach(r=>{
    const yourOk = !!r.myPick && !!r.correct && r.myPick === r.correct;
    const hisOk  = !!r.hisPick && !!r.correct && r.hisPick === r.correct;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(r.fixture)}</td>
      <td class="center">${escapeHTML(label(r.myPick))}${badge(yourOk)}</td>
      <td class="center">${escapeHTML(label(r.correct))}</td>
      <td class="center">${escapeHTML(label(r.hisPick))}${badge(hisOk)}</td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById('legends').textContent =
    `${data.me.name} vs ${data.compare.name} \u2022 Picks shown as HOME / DRAW / AWAY`;

  // Apply button
  document.getElementById('applyBtn').onclick = ()=>{
    const selectedWeek = weekSel.value;
    const selectedCompareId = compareSel.value || '1';
    const next = new URL(location.href);
    next.searchParams.set('userId', userId);
    next.searchParams.set('week', currentWeek || '');
    next.searchParams.set('viewWeek', selectedWeek);
    next.searchParams.set('compareId', selectedCompareId);
    location.href = next.toString();
  };
}

function label(x){ return (x || '-'); }
function badge(ok){ return ok ? ' <span class="pick-badge good">&#10003;</span>' : ' <span class="pick-badge bad">&#10007;</span>'; }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
