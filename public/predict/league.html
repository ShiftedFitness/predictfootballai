<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TeleStats Fives â€“ League Table</title>
<link rel="stylesheet" href="/predict/telestats-theme.css"/>
<style>
  .pos{ width:64px }
  .user{ max-width:260px; overflow:hidden; text-overflow:ellipsis }
  .acc{ width:90px; text-align:right }
  .center{ text-align:center }
  .pts{ width:90px; text-align:right; font-weight:700; color:var(--accent-yellow); }
  .highlight td { color:var(--accent-cyan) !important; font-weight:600; }
  .highlight td.pts { color:var(--accent-yellow) !important; }
  .tick{ color:var(--accent-green); font-weight:900 }
  .cross{ color:var(--danger); font-weight:900 }
  .small{ font-size:12px; color:var(--text-muted); margin-bottom:6px }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between }
</style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/predict/auth.js"></script>

  <div class="ts-page">
    <h2 class="ts-page-title">League Table</h2>

    <div class="ts-tabs">
      <button class="ts-tab active" id="tabOverall">Overall</button>
      <button class="ts-tab" id="tabWeekly">Matchweek</button>
    </div>

    <!-- Overall -->
    <div id="overall" class="ts-card">
      <div class="ts-muted" id="overallCount"></div>
      <div class="ts-scroll">
        <table class="ts-table" id="overallTbl">
          <thead>
            <tr>
              <th class="pos">Pos</th>
              <th>Username</th>
              <th class="acc">% Acc</th>
              <th class="center">FH</th>
              <th class="center">Blanks</th>
              <th class="pts">Points</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="ts-muted" style="margin-top:8px">Sorted by points, then FH, then accuracy.</div>
    </div>

    <!-- Weekly -->
    <div id="weekly" class="ts-card" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <div>
          <span class="ts-muted">Week</span>
          <select id="weekSel" class="ts-select"></select>
        </div>
        <div class="ts-muted" id="lockedMsg"></div>
      </div>

      <!-- Match order reminder -->
      <div id="matchMap" class="small"></div>

      <div class="ts-scroll">
        <table class="ts-table" id="weeklyTbl">
          <thead>
            <tr>
              <th class="pos">Pos</th>
              <th>Username</th>
              <th class="center">Pts</th>
              <th class="center">1</th>
              <th class="center">2</th>
              <th class="center">3</th>
              <th class="center">4</th>
              <th class="center">5</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="ts-muted" style="margin-top:8px">Ticks/crosses appear once results are scored. Before that, cells show your pick (1 = Home, 2 = Away, X = Draw).</div>
    </div>
  </div>

<script>
const DEBUG = false;
const base = '/.netlify/functions';
const qs = new URLSearchParams(location.search);

let currentWeek = qs.get('week') ? Number(qs.get('week')) : null;
let weeklyInitialized = false;
let highlightUserId = qs.get('userId') || '';

function debugLog(...args) {
  if (DEBUG) console.log('[league_v2]', ...args);
}

/* ---------- helpers ---------- */
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pct(acc){ return (Math.round(acc*1000)/10).toFixed(1); }

/* ---------- OVERALL ---------- */
function trOverall(row){
  const tr = document.createElement('tr');
  if (String(row.id) === String(highlightUserId)) tr.classList.add('highlight');
  tr.innerHTML = `
    <td class="pos">${row.position}</td>
    <td class="user">${escapeHTML(row.name)}</td>
    <td class="acc">${pct(row.accuracy)}%</td>
    <td class="center">${row.fh ?? 0}</td>
    <td class="center">${row.blanks ?? 0}</td>
    <td class="pts">${row.points}</td>
  `;
  return tr;
}

async function loadOverall(){
  const res = await fetch(`${base}/leaderboard`, { cache: 'no-store' });
  if (!res.ok) { alert('Failed to load leaderboard'); return; }
  const data = await res.json();
  const rows = data.leaderboard || [];
  const body = document.querySelector('#overallTbl tbody');
  body.innerHTML = '';
  rows.forEach(r => body.appendChild(trOverall(r)));
  document.getElementById('overallCount').textContent = `${rows.length} players`;
}

/* ---------- WEEKLY ---------- */
function toSymbol(p){ return p==='HOME'?'1':(p==='AWAY'?'2':(p==='DRAW'?'X':'-')); }
function cellFor(pick, resultIsSet, isCorrect){
  if (resultIsSet) return isCorrect ? '<span class="tick">&#10003;</span>' : '<span class="cross">&#10007;</span>';
  return `<span>${toSymbol(pick)}</span>`;
}
function trWeekly(row, resultSetFlags){
  const tr = document.createElement('tr');
  if (String(row.userId) === String(highlightUserId)) tr.classList.add('highlight');
  const cells = row.picksRaw.map((p, i)=> `<td class="center">${cellFor(p, resultSetFlags[i], row.correct[i])}</td>`).join('');
  tr.innerHTML = `
    <td>${row.pos}</td>
    <td>${escapeHTML(row.name)}</td>
    <td class="center">${row.points}</td>
    ${cells}
  `;
  return tr;
}

async function loadWeekly(week) {
  debugLog('loadWeekly called with week:', week);
  const weekNum = Number(week);
  if (!weekNum || isNaN(weekNum)) {
    debugLog('Invalid week, fetching available weeks first...');
    try {
      const weeksRes = await fetch(`${base}/weeks`, { cache: 'no-store' });
      if (weeksRes.ok) {
        const weeksData = await weeksRes.json();
        const fallbackWeek = weeksData.recommendedViewWeek || weeksData.latest || 1;
        debugLog('Using fallback week:', fallbackWeek);
        return loadWeekly(fallbackWeek);
      }
    } catch (e) {
      debugLog('Failed to fetch weeks for fallback:', e);
    }
    return;
  }

  const r = await fetch(`${base}/weekly-table?week=${weekNum}`, { cache:'no-store' });
  if (!r.ok) { debugLog('API error:', r.status); alert('Failed to load weekly table'); return; }
  const j = await r.json();
  debugLog('API response:', { week: j.week, locked: j.locked, rowCount: (j.rows||[]).length, availableWeeks: j.availableWeeks });

  const availableWeeks = j.availableWeeks && j.availableWeeks.length ? j.availableWeeks : [];
  if (availableWeeks.length > 0 && !availableWeeks.includes(weekNum)) {
    const defaultWeek = availableWeeks[0];
    debugLog('Requested week not available, reloading with:', defaultWeek);
    return loadWeekly(defaultWeek);
  }

  currentWeek = weekNum;
  document.getElementById('lockedMsg').textContent =
    j.locked ? 'Live (deadline passed)' : 'Not available (deadline not passed)';

  const map = (j.matches || []).map((m,i)=> `Match ${i+1}: ${m.home} v ${m.away}`);
  document.getElementById('matchMap').textContent = map.join('  \u2022  ');

  const resultSet = (j.matches || []).map(m => {
    const v = (m && typeof m.correct === 'string') ? m.correct.trim().toUpperCase() : '';
    return v === 'HOME' || v === 'AWAY' || v === 'DRAW';
  });

  const body = document.querySelector('#weeklyTbl tbody');
  body.innerHTML = '';
  (j.rows || []).forEach((r,i)=>{
    const row = Object.assign({ pos: i+1 }, r);
    body.appendChild(trWeekly(row, resultSet));
  });

  const sel = document.getElementById('weekSel');
  sel.innerHTML = '';
  const weeks = availableWeeks.length ? availableWeeks : [j.week || week];
  debugLog('Building dropdown with', weeks.length, 'options, selecting week:', currentWeek);

  weeks.forEach(w => {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = `Week ${w}`;
    if (Number(w) === currentWeek) opt.selected = true;
    sel.appendChild(opt);
  });

  sel.onchange = () => loadWeekly(Number(sel.value));
}

/* ---------- Tabs ---------- */
document.getElementById('tabOverall').onclick = ()=>{
  document.getElementById('tabOverall').classList.add('active');
  document.getElementById('tabWeekly').classList.remove('active');
  document.getElementById('overall').style.display='';
  document.getElementById('weekly').style.display='none';
};

document.getElementById('tabWeekly').onclick = async ()=>{
  document.getElementById('tabWeekly').classList.add('active');
  document.getElementById('tabOverall').classList.remove('active');
  document.getElementById('overall').style.display='none';
  document.getElementById('weekly').style.display='';
  await initWeeklyTab();
};

/* ---------- Weekly Tab Initialization ---------- */
async function initWeeklyTab() {
  debugLog('initWeeklyTab called, currentWeek:', currentWeek, 'initialized:', weeklyInitialized);
  if (currentWeek && weeklyInitialized) {
    debugLog('Using cached currentWeek:', currentWeek);
    await loadWeekly(currentWeek);
    return;
  }
  debugLog('Initializing weekly tab, calling loadWeekly with:', currentWeek || 'null (will auto-detect)');
  await loadWeekly(currentWeek);
  weeklyInitialized = true;
}

/* ---------- Init ---------- */
(async () => {
  const userId = await PFAuth.initAuth();
  highlightUserId = highlightUserId || userId;
  PFAuth.renderNav();
  loadOverall();
})();
</script>
</body>
</html>
