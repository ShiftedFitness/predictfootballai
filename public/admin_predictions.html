<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>PredictFootball.ai – Match Predictions Inspector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#30A278;
      --card:#000000;
      --border:#1a1a1a;
      --text:#FFFFFF;
      --muted:#EAEAEA;
      --accent:#FFFFFF;
      --accentText:#000000;
    }
    html, body { height:100%; }
    body {
      margin:0;
      background:#111;
      color:#fff;
      font-family:Inter,system-ui,Arial;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
    }
    .wrap {
      max-width:900px;
      width:100%;
      margin:24px 12px;
      background:var(--bg);
      color:var(--text);
      border-radius:14px;
      padding:16px;
    }
    h2 { margin:0 0 8px; }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-bottom:8px;
    }
    label {
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    input {
      background:#0e0e0e;
      color:#fff;
      border:1px solid #2a2a2a;
      border-radius:8px;
      padding:8px 10px;
      min-width:140px;
    }
    .btn {
      background:var(--accent);
      color:var(--accentText);
      border:0;
      padding:9px 14px;
      border-radius:8px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .muted { color:var(--muted); font-size:12px; }

    .status { margin-top:6px; white-space:pre-wrap; font-size:12px; }

    .match-card {
      margin-top:10px;
      border-radius:10px;
      border:1px solid #2a2a2a;
      padding:10px;
      background:#050505;
    }
    .match-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .pill {
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #444;
      font-size:11px;
      color:#ddd;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td {
      padding:6px 6px;
      border-bottom:1px solid #1f1f1f;
      text-align:left;
    }
    th {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:#cfcfcf;
    }
    tr:last-child td { border-bottom:none; }

    .right { text-align:right; }
    .mono { font-family:Menlo,Consolas,monospace; font-size:12px; }
    .badge {
      display:inline-block;
      padding:1px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #444;
    }
    .badge-good { border-color:#7CFC00; color:#7CFC00; }
    .badge-bad  { border-color:#FF6B6B; color:#FF6B6B; }

    .error { color:#FF6B6B; }
    .success { color:#7CFC00; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Match Predictions Inspector</h2>
    <p class="muted">
      Enter one or more Match IDs (e.g. <span class="mono">88</span> or <span class="mono">88,89,90</span>) to see all predictions for those fixtures.
      Prediction IDs are shown so you can edit/delete them via admin tools.
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label for="matchIds">Match ID(s)</label>
          <input id="matchIds" placeholder="e.g. 88 or 88,89,90"/>
        </div>
        <div>
          <label for="secret">Admin Secret</label>
          <input id="secret" type="password" placeholder="x-admin-secret"/>
        </div>
        <div>
          <button id="loadBtn" class="btn">Load Predictions</button>
        </div>
      </div>
      <div id="status" class="status muted"></div>
    </div>

    <div id="results"></div>
  </div>

<script>
const base = '/.netlify/functions';

function $(id){ return document.getElementById(id); }

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function setStatus(msg, type){
  const el = $('status');
  if (!el) return;
  el.textContent = msg || '';
  el.classList.remove('error','success');
  if (type) el.classList.add(type);
}

async function fetchJSON(url, secret){
  const res = await fetch(url, {
    headers: {
      'x-admin-secret': secret || ''
    },
    cache:'no-store'
  });
  let txt = await res.text();
  let data;
  try {
    data = txt ? JSON.parse(txt) : {};
  } catch {
    throw new Error('Invalid JSON from server: ' + txt.slice(0,200));
  }
  if (!res.ok) {
    throw new Error(data.error || ('HTTP ' + res.status));
  }
  return data;
}

function renderResults(data){
  const container = $('results');
  container.innerHTML = '';

  if (!data || !Array.isArray(data.rows) || data.rows.length === 0){
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = '<span class="muted">No predictions found for those match IDs.</span>';
    container.appendChild(div);
    return;
  }

  // group rows by matchId
  const byMatch = {};
  for (const row of data.rows){
    const mid = String(row.matchId);
    if (!byMatch[mid]) byMatch[mid] = [];
    byMatch[mid].push(row);
  }

  Object.keys(byMatch).sort((a,b)=> Number(a)-Number(b)).forEach(mid => {
    const list = byMatch[mid];

    const card = document.createElement('div');
    card.className = 'card match-card';

    const header = document.createElement('div');
    header.className = 'match-header';
    const left = document.createElement('div');
    left.innerHTML = `<strong>Match ${escapeHTML(mid)}</strong>`;
    const right = document.createElement('div');
    const weeks = Array.from(new Set(list.map(r => r.week || 0))).filter(Boolean).sort((a,b)=>a-b);
    right.innerHTML = `<span class="pill">Weeks: ${weeks.length ? weeks.join(', ') : '-'}</span>`;
    header.appendChild(left);
    header.appendChild(right);
    card.appendChild(header);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>User</th>
          <th>User ID</th>
          <th>Week</th>
          <th>Pick</th>
          <th class="right">Points</th>
          <th>Prediction ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector('tbody');

    list.sort((a,b)=> a.userName.localeCompare(b.userName)).forEach(r => {
      const tr = document.createElement('tr');
      const pts = (r.pointsAwarded === null || typeof r.pointsAwarded === 'undefined')
        ? ''
        : String(r.pointsAwarded);

      const badge = (r.pointsAwarded === 1)
        ? '<span class="badge badge-good">✓</span>'
        : (r.pointsAwarded === 0 ? '<span class="badge badge-bad">✗</span>' : '');

      tr.innerHTML = `
        <td>${escapeHTML(r.userName || '')}</td>
        <td class="mono">${escapeHTML(r.userId || '')}</td>
        <td>${r.week || '-'}</td>
        <td>${escapeHTML(r.pick || '')}</td>
        <td class="right">${pts} ${badge}</td>
        <td class="mono">${escapeHTML(r.id || '')}</td>
      `;
      tb.appendChild(tr);
    });

    card.appendChild(table);
    container.appendChild(card);
  });
}

$('loadBtn').addEventListener('click', async ()=>{
  const matchIdsRaw = $('matchIds').value.trim();
  const secret = $('secret').value.trim();

  if (!matchIdsRaw){
    setStatus('Please enter at least one Match ID.', 'error');
    return;
  }

  setStatus('Loading predictions...', 'muted');
  $('results').innerHTML = '';

  try {
    const url = `${base}/admin-get-predictions-by-match?matchId=${encodeURIComponent(matchIdsRaw)}`;
    const data = await fetchJSON(url, secret);
    setStatus(`Loaded ${data.total || 0} predictions for matchId(s): ${data.requestedMatchIds.join(', ')}`, 'success');
    renderResults(data);
  } catch (e) {
    console.error(e);
    setStatus('Error: ' + e.message, 'error');
  }
});
</script>
</body>
</html>
