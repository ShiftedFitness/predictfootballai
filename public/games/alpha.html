<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TeleStats - Player Alphabet</title>
<meta name="description" content="Go A-Z naming players by surname initial. Race the clock or take your time. How many letters can you fill?"/>
<meta property="og:site_name" content="TeleStats"/>
<meta property="og:type" content="website"/>
<meta property="og:title" content="Player Alphabet — TeleStats"/>
<meta property="og:description" content="Go A-Z naming Premier League players by surname initial. How many letters can you fill?"/>
<meta property="og:image" content="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png"/>
<meta property="og:url" content="https://telestats.net/games/alpha.html"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Player Alphabet — TeleStats"/>
<meta name="twitter:description" content="Go A-Z naming Premier League players by surname initial."/>
<meta name="twitter:image" content="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png"/>
<link rel="stylesheet" href="../telestats-theme.css"/>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  min-height: 100vh;
  padding: 12px;
  line-height: 1.4;
}
.container { max-width: 480px; margin: 0 auto; }
.header { text-align: center; padding: 16px 0 8px; }
.header h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
.header h1 .accent { color: var(--accent-cyan); }
.header .subtitle { color: var(--muted); font-size: 13px; margin-top: 4px; }
.back-link { display: inline-block; color: var(--muted); text-decoration: none; font-size: 13px; margin-bottom: 8px; }
.back-link:hover { color: var(--accent-cyan); }

.card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
.card h2 { font-size: 17px; font-weight: 700; margin-bottom: 12px; }

/* Setup sections */
.section { background: var(--card-dark); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
.section-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; cursor: pointer; }
.section-header:hover { background: rgba(255,255,255,0.03); }
.section-title { font-weight: 700; font-size: 15px; }
.chev { opacity: 0.7; transition: transform 0.2s; font-size: 12px; }
.section.open .chev { transform: rotate(180deg); }
.section-body { display: none; padding: 0 0 4px; }
.section.open .section-body { display: block; }
.scope-card { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid rgba(255,255,255,0.05); }
.scope-card:last-child { border-bottom: none; }
.scope-card:hover { background: rgba(255,255,255,0.06); }
.scope-card.selected { background: rgba(0,229,255,0.10); }
.scope-card .sc-icon { font-size: 18px; margin-right: 10px; }
.scope-card .sc-dot { width: 18px; height: 18px; border-radius: 4px; margin-right: 10px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2); }
.scope-card .sc-label { font-weight: 600; font-size: 13px; flex: 1; }
.scope-card .sc-arrow { opacity: 0.5; font-size: 14px; }

/* Timer toggle */
.timer-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--card-dark); border-radius: 10px; }
.timer-row label { font-size: 14px; font-weight: 600; flex: 1; }
.timer-row select { background: var(--btn); border: none; color: var(--ink); padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; }
.toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--btn); border-radius: 24px; transition: 0.3s; }
.toggle-slider:before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
.toggle-switch input:checked + .toggle-slider { background: var(--accent-cyan); }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }

.go-btn { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.15s; }
.go-btn.primary { background: var(--accent-yellow); color: #000; }
.go-btn.primary:hover { background: #E6C009; }
.go-btn:disabled { background: var(--btn); color: var(--muted); cursor: not-allowed; }
.go-btn.secondary { background: var(--btn); color: var(--ink); margin-top: 10px; }

/* Game area */
.letter-strip { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-bottom: 16px; }
.letter-cell { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; background: var(--card-dark); color: var(--muted); transition: all 0.2s; }
.letter-cell.active { background: var(--accent-cyan); color: #000; transform: scale(1.15); }
.letter-cell.done { background: rgba(34,197,94,0.2); color: #22c55e; }
.letter-cell.skipped { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.15); text-decoration: line-through; }
.letter-cell.missed { background: rgba(239,68,68,0.15); color: #ef4444; }

.current-letter { text-align: center; margin-bottom: 16px; }
.current-letter .big { font-size: 64px; font-weight: 800; color: var(--accent-cyan); font-family: 'Space Mono', monospace; }
.current-letter .hint { font-size: 13px; color: var(--muted); }

.timer-bar { height: 6px; background: var(--card-dark); border-radius: 3px; margin-bottom: 16px; overflow: hidden; }
.timer-bar .fill { height: 100%; background: var(--accent-cyan); transition: width 0.1s linear; border-radius: 3px; }
.timer-bar .fill.warning { background: var(--accent-yellow); }
.timer-bar .fill.danger { background: var(--danger); }

.search-input { width: 100%; padding: 14px 16px; background: var(--card-dark); border: 2px solid transparent; border-radius: 12px; color: var(--ink); font-size: 15px; outline: none; margin-bottom: 8px; }
.search-input:focus { border-color: var(--accent-cyan); }
.search-input::placeholder { color: var(--muted); }

.player-list { max-height: 200px; overflow-y: auto; margin-bottom: 12px; }
.player-item { padding: 10px 14px; border-radius: 8px; cursor: pointer; transition: background 0.1s; font-size: 14px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.04); }
.player-item:hover { background: var(--btn); }

.reveal-btn { display: inline-block; padding: 8px 16px; background: var(--card-dark); border: 1px solid var(--muted); border-radius: 8px; color: var(--muted); font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; }
.reveal-btn:hover { background: var(--btn); color: var(--ink); }

.result-msg { text-align: center; padding: 10px; border-radius: 8px; font-weight: 700; font-size: 14px; margin-bottom: 8px; }
.result-msg.correct { background: rgba(34,197,94,0.15); color: #22c55e; }
.result-msg.wrong { background: rgba(239,68,68,0.15); color: #ef4444; }
.result-msg.timeout { background: rgba(251,191,36,0.15); color: var(--accent-yellow); }
.result-msg.skip { background: rgba(255,255,255,0.05); color: var(--muted); }

/* Score */
.score-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 16px; }
.score-item { text-align: center; }
.score-item .num { font-size: 28px; font-weight: 800; font-family: 'Space Mono', monospace; }
.score-item .lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; }
.score-item .num.green { color: #22c55e; }
.score-item .num.red { color: #ef4444; }
.score-item .num.grey { color: var(--muted); }

/* Sticky start footer */
.start-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 16px calc(12px + env(safe-area-inset-bottom)); background: linear-gradient(transparent, var(--bg) 20%); z-index: 100; display: flex; justify-content: center; pointer-events: none; opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; }
.start-footer.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
.start-footer .go-btn { max-width: 480px; width: 100%; }

.hidden { display: none !important; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--muted); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
  <div class="ts-header">
    <img src="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png" alt="TeleStats" class="ts-logo"/>
    <span>ALPHABET</span>
    <span class="ts-time" id="tsClock">--:--</span>
  </div>

  <a href="index.html" class="back-link">&larr; All Games</a>

  <div class="header">
    <h1>Player <span class="accent">Alphabet</span></h1>
    <div class="subtitle">Find a player for each letter A-Z by surname. How many can you get?</div>
  </div>

  <div class="game-meta-links">
    <button class="game-meta-link" onclick="showRules()">&#9432; How to Play</button>
    <button class="game-meta-link" onclick="showGameSettings()">&#9881; Settings</button>
  </div>

  <!-- SETUP -->
  <div id="step1">
    <div class="card">
      <h2>Choose Team</h2>
      <div id="scopeList"></div>
    </div>
  </div>

  <!-- Hidden timer settings (defaults: ON, 20s) — accessible via settings overlay -->
  <input type="hidden" id="timerToggle" checked/>
  <select id="timerLength" style="display:none;">
    <option value="20" selected>20s</option>
  </select>

  <!-- GAME -->
  <div id="step2" class="hidden">
    <div class="letter-strip" id="letterStrip"></div>

    <div class="score-row">
      <div class="score-item"><div class="num green" id="scoreCorrect">0</div><div class="lbl">Found</div></div>
      <div class="score-item"><div class="num red" id="scoreMissed">0</div><div class="lbl">Missed</div></div>
      <div class="score-item"><div class="num grey" id="scoreSkipped">0</div><div class="lbl">Skipped</div></div>
    </div>

    <div class="current-letter">
      <div class="big" id="currentBig">A</div>
      <div class="hint" id="currentHint">Find a player whose surname starts with A</div>
    </div>

    <div id="timerBarWrap" class="timer-bar"><div class="fill" id="timerFill" style="width:100%"></div></div>

    <div id="resultMsg" class="result-msg hidden"></div>

    <input type="text" class="search-input" id="searchInput" placeholder="Type a player name..." autocomplete="off"/>
    <div class="player-list" id="playerList"></div>

    <div style="text-align:center;">
      <button class="reveal-btn" id="revealBtn" onclick="revealAnswer()">Show a valid answer</button>
      <button class="reveal-btn" id="skipBtn" onclick="skipLetter()" style="margin-left:8px;">Skip letter</button>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="step3" class="hidden">
    <div class="card">
      <div style="text-align:center;">
        <h2>Game Complete!</h2>
        <div id="finalScoreDisplay" style="font-size:56px;font-weight:800;color:var(--accent-cyan);font-family:'Space Mono',monospace;margin:12px 0 4px;">0</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">Score out of 100</div>
        <div class="score-row" style="margin-top:16px;">
          <div class="score-item"><div class="num green" id="finalCorrect">0</div><div class="lbl">Found</div></div>
          <div class="score-item"><div class="num red" id="finalMissed">0</div><div class="lbl">Missed</div></div>
          <div class="score-item"><div class="num grey" id="finalRevealed">0</div><div class="lbl">Revealed</div></div>
          <div class="score-item"><div class="num grey" id="finalSkipped">0</div><div class="lbl">No players</div></div>
        </div>
      </div>
      <div id="finalSummary" style="margin-top:16px;"></div>
    </div>
    <button class="go-btn primary" onclick="startGame()">Play Again</button>
    <button class="go-btn secondary" onclick="backToSetup()">Change Team</button>
  </div>
</div>

<!-- Sticky start button footer -->
<div class="start-footer" id="startFooter">
  <button class="go-btn primary" id="startBtn" onclick="startGame()">Start Game</button>
</div>

<!-- How to Play Modal -->
<div class="game-rules-overlay" id="rulesOverlay" onclick="if(event.target===this)closeRules()">
  <div class="game-rules-modal">
    <button class="game-rules-close" onclick="closeRules()">&times;</button>
    <h3>How to Play Alphabet</h3>
    <div class="rule-step"><div class="rule-num">1</div><div class="rule-text">Choose a <strong>team or league</strong> to play with.</div></div>
    <div class="rule-step"><div class="rule-num">2</div><div class="rule-text">You'll go through each letter <strong>A to Z</strong>. Name a player whose surname starts with that letter.</div></div>
    <div class="rule-step"><div class="rule-num">3</div><div class="rule-text">With the timer enabled, you have <strong>20 seconds per letter</strong> (customisable in Settings).</div></div>
    <div class="rule-step"><div class="rule-num">4</div><div class="rule-text">If you're stuck, you can <strong>reveal an answer</strong> or <strong>skip</strong> the letter.</div></div>
    <div class="rule-step"><div class="rule-num">5</div><div class="rule-text">Your score is based on how many letters you complete — try to get <strong>all 26</strong>!</div></div>
  </div>
</div>

<!-- Settings Modal -->
<div class="game-rules-overlay" id="settingsOverlay" onclick="if(event.target===this)closeGameSettings()">
  <div class="game-rules-modal">
    <button class="game-rules-close" onclick="closeGameSettings()">&times;</button>
    <h3>Settings</h3>
    <div class="game-settings-row">
      <div class="game-settings-label">Timer<small>Time limit per letter</small></div>
      <label class="toggle-switch"><input type="checkbox" id="settingsTimerToggle" checked onchange="timerEnabled=this.checked"/><span class="toggle-slider"></span></label>
    </div>
    <div class="game-settings-row">
      <div class="game-settings-label">Seconds per letter</div>
      <select id="settingsTimerLength" style="padding:6px 10px;border-radius:6px;background:var(--bg-elevated);color:var(--text-primary);border:1px solid rgba(255,255,255,0.08);font-size:13px;" onchange="timerSeconds=parseInt(this.value);document.getElementById('timerLength').value=this.value;">
        <option value="10">10s</option>
        <option value="15">15s</option>
        <option value="20" selected>20s</option>
        <option value="30">30s</option>
        <option value="45">45s</option>
        <option value="60">60s</option>
      </select>
    </div>
  </div>
</div>
<script>
function showRules(){document.getElementById('rulesOverlay').classList.add('active');}
function closeRules(){document.getElementById('rulesOverlay').classList.remove('active');}
function showGameSettings(){
  document.getElementById('settingsTimerToggle').checked=timerEnabled;
  document.getElementById('settingsTimerLength').value=timerSeconds;
  document.getElementById('settingsOverlay').classList.add('active');
}
function closeGameSettings(){document.getElementById('settingsOverlay').classList.remove('active');}
</script>

<footer style="text-align:center;padding:16px 16px 72px;font-size:11px;color:var(--muted);opacity:0.6;">
  TeleStats.net &middot; Built by <a href="https://shiftedlabs.io" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">Shifted.Labs</a>
</footer>

<script>
const API_BASE = '/.netlify/functions';
const $ = id => document.getElementById(id);

const LEAGUE_ICONS = {
  epl: '\uD83C\uDFF4\uDB40\uDC67\uDB40\uDC62\uDB40\uDC65\uDB40\uDC6E\uDB40\uDC67\uDB40\uDC7F',
  laliga: '\uD83C\uDDEA\uD83C\uDDF8',
  seriea: '\uD83C\uDDEE\uD83C\uDDF9',
  bundesliga: '\uD83C\uDDE9\uD83C\uDDEA',
  ligue1: '\uD83C\uDDEB\uD83C\uDDF7',
};

const CLUB_COLOURS = {
  // EPL
  'Arsenal': '#EF0107', 'Aston Villa': '#670E36', 'Blackburn Rovers': '#009EDB', 'Bolton Wanderers': '#1D2D5A',
  'Bournemouth': '#DA291C', 'Brentford': '#E30613', 'Brighton': '#0057B8', 'Burnley': '#6C1D45',
  'Charlton Athletic': '#D4021D', 'Chelsea': '#034694', 'Coventry City': '#00A3E0', 'Crystal Palace': '#1B458F',
  'Derby County': '#000000', 'Everton': '#003399', 'Fulham': '#000000', 'Ipswich Town': '#0044AA',
  'Leeds United': '#FFCD00', 'Leicester City': '#003090', 'Liverpool': '#C8102E', 'Manchester City': '#6CABDD',
  'Manchester United': '#DA291C', 'Middlesbrough': '#E4002B', 'Newcastle United': '#000000',
  'Norwich City': '#FFF200', 'Nottingham Forest': '#DD0000', 'Portsmouth': '#001489',
  'Queens Park Rangers': '#005CAB', 'Reading': '#004494', 'Sheffield United': '#EE2737',
  'Sheffield Wednesday': '#0066B2', 'Southampton': '#D71920', 'Stoke City': '#E03A3E',
  'Sunderland': '#EB172B', 'Swansea City': '#000000', 'Tottenham Hotspur': '#132257',
  'Watford': '#FBEE23', 'West Bromwich Albion': '#122F67', 'West Ham United': '#7A263A',
  'Wigan Athletic': '#1D59AF', 'Wimbledon': '#00008B', 'Wolverhampton Wanderers': '#FDB913',
  // La Liga
  'Athletic Club': '#EE2523', 'Valencia': '#EE3524', 'Barcelona': '#A50044', 'Real Madrid': '#FEBE10',
  'Atlético Madrid': '#CB3524', 'Sevilla': '#D4021D', 'Real Sociedad': '#143C8B', 'Espanyol': '#007FC8',
  'Real Betis': '#00954C', 'Celta Vigo': '#8AC3EE', 'Villarreal': '#FFCD00', 'Dep La Coruña': '#0033A0',
  'Osasuna': '#D91A2A', 'Mallorca': '#E20613', 'Valladolid': '#5A2D82', 'Getafe': '#004FA3',
  'Zaragoza': '#004C99', 'Rayo Vallecano': '#E53027', 'Racing Sant': '#00A651', 'Málaga': '#009EE3',
  'Alavés': '#003DA5', 'Levante': '#BD0811', 'Sporting Gijón': '#CC2229', 'Granada': '#E30613',
  'Tenerife': '#1C3A7A',
  // Bundesliga
  'Bayern Munich': '#DC052D', 'Dortmund': '#FDE100', 'Leverkusen': '#E32221', 'Werder Bremen': '#1D9053',
  'Stuttgart': '#E32219', 'Gladbach': '#000000', 'Schalke 04': '#004D9D', 'Wolfsburg': '#65B32E',
  'Eintracht Frankfurt': '#E1000F', 'Hamburger SV': '#005B9A', 'Freiburg': '#000000', 'Hertha BSC': '#005BA6',
  'Köln': '#ED1C24', 'Mainz 05': '#ED1C24', 'Hoffenheim': '#1961B5', 'Bochum': '#005BA6',
  'Hannover 96': '#1E8C35', 'Nürnberg': '#8B0000', 'Augsburg': '#BA3733', 'Kaiserslautern': '#E3000B',
  'Arminia': '#00447C', 'Hansa Rostock': '#003D7E', '1860 Munich': '#00529C', 'RB Leipzig': '#DD0741',
  'MSV Duisburg': '#004B93',
  // Serie A
  'Lazio': '#87D8F7', 'Inter': '#009DDC', 'Milan': '#FB090B', 'Roma': '#8E1F2F',
  'Udinese': '#000000', 'Juventus': '#000000', 'Fiorentina': '#482C83', 'Atalanta': '#1E71B8',
  'Cagliari': '#8B0000', 'Sampdoria': '#0065A4', 'Bologna': '#1A2F48', 'Napoli': '#009FE3',
  'Parma': '#FEDD00', 'Torino': '#8B1A2B', 'Genoa': '#93192A', 'Chievo': '#1C3C8B',
  'Empoli': '#005BA6', 'Lecce': '#FFED00', 'Hellas Verona': '#003DA5', 'Palermo': '#F1AABB',
  'Sassuolo': '#00A850', 'Brescia': '#004B93', 'Siena': '#000000', 'Reggina': '#6D2247',
  'Catania': '#E3000B',
  // Ligue 1
  'Rennes': '#E4002B', 'Lyon': '#003DA5', 'Paris Saint-Germain': '#004170', 'Marseille': '#009FE3',
  'Monaco': '#C8102E', 'Lille': '#D71920', 'Bordeaux': '#13244A', 'Nice': '#000000',
  'Nantes': '#FFED00', 'Montpellier': '#003DA5', 'Toulouse': '#5B2B82', 'Saint-Étienne': '#006A3D',
  'Lens': '#E2001A', 'Strasbourg': '#009FE3', 'Auxerre': '#FFFFFF', 'Metz': '#6D2832',
  'Lorient': '#F47920', 'Bastia': '#009FE3', 'Sochaux': '#FEDD00', 'Guingamp': '#E30613',
  'Nancy': '#E4002B', 'Reims': '#E30613', 'Caen': '#003DA5', 'Troyes': '#004FA3',
  'Angers': '#000000',
};

let leagues = [];
let scopes = [];
let selectedScope = null;
let alphabetData = []; // [{letter, count, players}]
let currentLetterIdx = 0;
let scoreCorrect = 0;
let scoreMissed = 0;
let scoreSkipped = 0;
let scoreRevealed = 0;
let timerEnabled = true;
let timerSeconds = 20;
let timerInterval = null;
let timerRemaining = 0;
let letterResults = {}; // letter -> { status: 'correct'|'missed'|'skipped'|'revealed', answer: string }
let processing = false;
let currentLetterRevealed = false; // tracks if "Show answer" was used for this letter

async function init() {
  try {
    const res = await fetch(`${API_BASE}/alpha_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get_scopes' }),
    });
    const data = await res.json();
    leagues = data.leagues || [];
    scopes = data.scopes || [];
    renderScopes();
  } catch (err) {
    console.error('Init error:', err);
  }
}

function renderScopes() {
  const container = $('scopeList');
  container.innerHTML = '';

  for (let i = 0; i < leagues.length; i++) {
    const league = leagues[i];
    const leagueScopes = scopes.filter(s => s.league === league.key);
    const overallScope = leagueScopes.find(s => s.type === 'league');
    const clubScopes = leagueScopes.filter(s => s.type === 'club')
      .sort((a, b) => a.label.localeCompare(b.label));

    const sec = document.createElement('div');
    sec.className = 'section'; // all collapsed by default

    const icon = LEAGUE_ICONS[league.key] || '\u26BD';
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `<div class="section-title">${icon} ${league.name} <span class="section-count" style="font-size:12px;color:var(--muted);font-weight:400;">(${clubScopes.length + (overallScope ? 1 : 0)})</span></div><div class="chev">\u25BC</div>`;
    header.onclick = (e) => {
      e.stopPropagation();
      container.querySelectorAll('.section').forEach(s => { if (s !== sec) s.classList.remove('open'); });
      sec.classList.toggle('open');
    };
    sec.appendChild(header);

    const body = document.createElement('div');
    body.className = 'section-body';
    if (overallScope) body.appendChild(makeScopeCard(overallScope));
    for (const s of clubScopes) body.appendChild(makeScopeCard(s));
    sec.appendChild(body);
    container.appendChild(sec);
  }
}

function getClubColour(scope) {
  // Try full clubName from backend, then try the label
  // The backend scope has id like "epl_club_arsenal" — we match by label text to CLUB_COLOURS keys
  for (const [name, colour] of Object.entries(CLUB_COLOURS)) {
    if (scope.label === name || name.includes(scope.label) || scope.label.includes(name)) return colour;
  }
  // Try matching short names
  const shortMap = {
    'Man Utd': 'Manchester United', 'Man City': 'Manchester City', 'Spurs': 'Tottenham Hotspur',
    'West Ham': 'West Ham United', 'West Brom': 'West Bromwich Albion', 'Wolves': 'Wolverhampton Wanderers',
    'Sheff Utd': 'Sheffield United', 'Sheff Wed': 'Sheffield Wednesday', 'QPR': 'Queens Park Rangers',
    'Nottm Forest': 'Nottingham Forest', 'Newcastle': 'Newcastle United', 'PSG': 'Paris Saint-Germain',
    'Frankfurt': 'Eintracht Frankfurt', 'Atlético': 'Atlético Madrid',
  };
  const fullName = shortMap[scope.label];
  if (fullName && CLUB_COLOURS[fullName]) return CLUB_COLOURS[fullName];
  return '#555';
}

function makeScopeCard(s) {
  const card = document.createElement('div');
  card.className = 'scope-card';
  if (s.type === 'league') {
    card.innerHTML = `<span class="sc-icon">\uD83C\uDFC6</span><span class="sc-label">${s.label}</span><span class="sc-arrow">\u203A</span>`;
  } else {
    const colour = getClubColour(s);
    card.innerHTML = `<span class="sc-dot" style="background:${colour}"></span><span class="sc-label">${s.label}</span><span class="sc-arrow">\u203A</span>`;
  }
  card.onclick = (e) => {
    e.stopPropagation();
    $('scopeList').querySelectorAll('.scope-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedScope = s.id;
    $('startFooter').classList.add('visible');
  };
  return card;
}

function toggleTimer() {
  // Timer defaults to ON (20s). Settings accessible via settings overlay.
  timerEnabled = true;
}

async function startGame() {
  timerSeconds = parseInt($('timerLength').value) || 20;
  $('startBtn').disabled = true;
  $('startBtn').innerHTML = '<span class="spinner"></span> Loading...';
  $('startFooter').classList.remove('visible');

  try {
    const res = await fetch(`${API_BASE}/alpha_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get_alphabet', scopeId: selectedScope }),
    });
    const data = await res.json();
    if (data.error) { alert('Error: ' + data.error); return; }

    alphabetData = data.letters || [];
    currentLetterIdx = 0;
    scoreCorrect = 0;
    scoreMissed = 0;
    scoreSkipped = 0;
    scoreRevealed = 0;
    letterResults = {};
    processing = false;
    currentLetterRevealed = false;

    $('step1').classList.add('hidden');
    $('step2').classList.remove('hidden');
    $('step3').classList.add('hidden');

    renderLetterStrip();
    updateScores();
    advanceToNextLetter();
  } catch (err) {
    alert('Failed to start: ' + err.message);
  }
  $('startBtn').disabled = false;
  $('startBtn').textContent = 'Start Game';
  if ($('step1').classList.contains('hidden')) {
    $('startFooter').classList.remove('visible');
  }
}

function renderLetterStrip() {
  const strip = $('letterStrip');
  strip.innerHTML = '';
  for (let i = 0; i < 26; i++) {
    const letter = String.fromCharCode(65 + i);
    const cell = document.createElement('div');
    cell.className = 'letter-cell';
    cell.id = 'cell_' + letter;
    cell.textContent = letter;
    strip.appendChild(cell);
  }
}

function updateLetterCell(letter, status) {
  const cell = $('cell_' + letter);
  if (!cell) return;
  cell.className = 'letter-cell ' + status;
}

function updateScores() {
  $('scoreCorrect').textContent = scoreCorrect;
  $('scoreMissed').textContent = scoreMissed;
  $('scoreSkipped').textContent = scoreSkipped;
}

function advanceToNextLetter() {
  stopTimer();
  $('resultMsg').classList.add('hidden');
  $('searchInput').value = '';
  $('playerList').innerHTML = '';
  processing = false;
  currentLetterRevealed = false;

  // Skip letters with no players
  while (currentLetterIdx < 26) {
    const ld = alphabetData[currentLetterIdx];
    if (ld && ld.count > 0) break;
    // Auto-skip
    if (ld) {
      updateLetterCell(ld.letter, 'skipped');
      letterResults[ld.letter] = { status: 'skipped', answer: null };
      scoreSkipped++;
    }
    currentLetterIdx++;
  }

  if (currentLetterIdx >= 26) {
    endGame();
    return;
  }

  const ld = alphabetData[currentLetterIdx];
  $('currentBig').textContent = ld.letter;
  $('currentHint').textContent = `Find a player whose surname starts with ${ld.letter} (${ld.count} available)`;
  updateLetterCell(ld.letter, 'active');
  updateScores();

  // Focus search input
  $('searchInput').focus();

  // Start timer
  if (timerEnabled) startTimer();
}

function startTimer() {
  timerRemaining = timerSeconds;
  $('timerBarWrap').classList.remove('hidden');
  updateTimerBar();
  timerInterval = setInterval(() => {
    timerRemaining -= 0.1;
    if (timerRemaining <= 0) {
      timerRemaining = 0;
      updateTimerBar();
      onTimeout();
    } else {
      updateTimerBar();
    }
  }, 100);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function updateTimerBar() {
  const pct = Math.max(0, (timerRemaining / timerSeconds) * 100);
  const fill = $('timerFill');
  fill.style.width = pct + '%';
  fill.classList.remove('warning', 'danger');
  if (pct < 20) fill.classList.add('danger');
  else if (pct < 50) fill.classList.add('warning');
}

function onTimeout() {
  stopTimer();
  if (processing) return;
  processing = true;

  const ld = alphabetData[currentLetterIdx];
  scoreMissed++;
  updateLetterCell(ld.letter, 'missed');
  letterResults[ld.letter] = { status: 'missed', answer: ld.players[0] || null };

  showResult('timeout', `Time's up! A valid answer was: ${ld.players[0] || '?'}`);

  setTimeout(() => {
    currentLetterIdx++;
    advanceToNextLetter();
  }, 1500);
}

function showResult(type, msg) {
  const el = $('resultMsg');
  el.className = 'result-msg ' + type;
  el.textContent = msg;
  el.classList.remove('hidden');
}

// Search input — show match count until exactly 1 match, then reveal name
$('searchInput').addEventListener('input', () => {
  if (processing) return;
  const query = $('searchInput').value.trim().toLowerCase();
  if (query.length < 2) {
    $('playerList').innerHTML = '';
    return;
  }

  const ld = alphabetData[currentLetterIdx];
  if (!ld) return;

  const matches = ld.players.filter(name => name.toLowerCase().includes(query));

  if (matches.length === 0) {
    $('playerList').innerHTML = '<div class="player-item" style="color:var(--muted);cursor:default;">No matches</div>';
  } else if (matches.length === 1) {
    // Exactly 1 match — reveal name and let user click
    $('playerList').innerHTML = `<div class="player-item" onclick="selectPlayer('${escHtml(matches[0])}')">${escHtml(matches[0])}</div>`;
  } else {
    // Multiple matches — show count only
    $('playerList').innerHTML = `<div class="player-item" style="color:var(--muted);cursor:default;">${matches.length} players match</div>`;
  }
});

function escHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function selectPlayer(name) {
  if (processing) return;
  processing = true;
  stopTimer();

  const ld = alphabetData[currentLetterIdx];
  const isValid = ld.players.some(p => p === name);

  if (isValid) {
    if (currentLetterRevealed) {
      // Player used "Show answer" before entering — counts as revealed, not correct
      scoreRevealed++;
      updateLetterCell(ld.letter, 'done');
      letterResults[ld.letter] = { status: 'revealed', answer: name };
      showResult('correct', '\u2713 ' + name + ' (revealed)');
    } else {
      scoreCorrect++;
      updateLetterCell(ld.letter, 'done');
      letterResults[ld.letter] = { status: 'correct', answer: name };
      showResult('correct', '\u2713 ' + name);
    }
  } else {
    processing = false;
    showResult('wrong', '\u2717 Not a valid player for this letter');
    if (timerEnabled && timerRemaining > 0) return;
    return;
  }

  setTimeout(() => {
    currentLetterIdx++;
    advanceToNextLetter();
  }, 1000);
}

function revealAnswer() {
  const ld = alphabetData[currentLetterIdx];
  if (!ld || ld.count === 0) return;
  currentLetterRevealed = true;
  const answer = ld.players[Math.floor(Math.random() * ld.players.length)];
  showResult('skip', `A valid answer: ${answer}`);
}

function skipLetter() {
  if (processing) return;
  processing = true;
  stopTimer();

  const ld = alphabetData[currentLetterIdx];
  scoreMissed++;
  updateLetterCell(ld.letter, 'missed');
  letterResults[ld.letter] = { status: 'missed', answer: ld.players[0] || null };
  showResult('wrong', `Skipped! A valid answer was: ${ld.players[0] || '?'}`);

  setTimeout(() => {
    currentLetterIdx++;
    advanceToNextLetter();
  }, 1200);
}

function endGame() {
  stopTimer();
  $('step2').classList.add('hidden');
  $('step3').classList.remove('hidden');

  $('finalCorrect').textContent = scoreCorrect;
  $('finalMissed').textContent = scoreMissed;
  $('finalRevealed').textContent = scoreRevealed;
  $('finalSkipped').textContent = scoreSkipped;

  // Calculate 0-100 score
  // Letters that had players = total playable letters
  const playableLetters = alphabetData.filter(l => l.count > 0).length;
  let score = 0;
  if (playableLetters > 0) {
    // Correct = 1 point, revealed = 0.5 points, missed = 0
    const rawScore = (scoreCorrect + scoreRevealed * 0.5) / playableLetters;
    score = Math.round(rawScore * 100);
  }
  $('finalScoreDisplay').textContent = score;

  // Build summary
  let html = '<div style="font-size:13px;">';
  for (let i = 0; i < 26; i++) {
    const letter = String.fromCharCode(65 + i);
    const r = letterResults[letter];
    if (!r) continue;
    let color, icon;
    if (r.status === 'correct') { color = '#22c55e'; icon = '\u2713'; }
    else if (r.status === 'revealed') { color = 'var(--accent-yellow)'; icon = '\uD83D\uDCA1'; }
    else if (r.status === 'missed') { color = '#ef4444'; icon = '\u2717'; }
    else { color = 'var(--muted)'; icon = '\u2014'; }
    html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);">`;
    html += `<span style="width:24px;font-weight:800;color:${color};">${letter}</span>`;
    html += `<span style="color:${color};width:16px;">${icon}</span>`;
    html += `<span style="flex:1;color:var(--muted);">${r.answer || (r.status === 'skipped' ? 'No players' : '')}${r.status === 'revealed' ? ' (revealed)' : ''}</span>`;
    html += `</div>`;
  }
  html += '</div>';
  $('finalSummary').innerHTML = html;
}

function backToSetup() {
  $('step1').classList.remove('hidden');
  $('step2').classList.add('hidden');
  $('step3').classList.add('hidden');
  if (selectedScope) $('startFooter').classList.add('visible');
}

init();

setInterval(() => {
  const now = new Date();
  const el = $('tsClock');
  if (el) el.textContent = now.toTimeString().slice(0, 5);
}, 1000);
$('tsClock').textContent = new Date().toTimeString().slice(0, 5);
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/ts-auth.js"></script>
<script src="/js/ts-data.js"></script>
<script src="/js/ts-nav.js"></script>
<script>
(async function tsIntegrate() {
  await TSAuth.init();
  TSNav.render();

  // Hook endGame to log session
  const _origEndGame = window.endGame;
  window.endGame = function () {
    _origEndGame();
    tsLogAlphaSession();
  };

  async function tsLogAlphaSession() {
    try {
      const scopeLabel = selectedScope || '';
      const playableLetters = alphabetData.filter(l => l.count > 0).length;
      const rawScore = playableLetters > 0
        ? Math.round(((scoreCorrect + scoreRevealed * 0.5) / playableLetters) * 100)
        : 0;
      const result = await TSData.logGameSession({
        game_type: 'player_alphabet',
        game_category: scopeLabel,
        score: rawScore,
        max_possible_score: 100,
        correct_answers: scoreCorrect,
        total_questions: playableLetters,
        is_perfect_round: scoreCorrect === playableLetters && scoreMissed === 0,
        completed: true
      });
      if (result && !result.error) {
        TSNav.showXPToast(result);
        TSNav.showShareCard({
          game_type: 'player_alphabet',
          game_category: scopeLabel,
          correct_answers: scoreCorrect,
          score: rawScore,
          is_perfect_round: scoreCorrect === playableLetters && scoreMissed === 0,
          xp_earned: result.xp_earned
        });
      }
    } catch (e) { console.warn('[TS] session log failed:', e); }
  }
})();
</script>
</body>
</html>
