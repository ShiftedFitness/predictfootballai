<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>TeleStats - Who Am I?</title>
<meta name="description" content="A mystery player is chosen. Clues are revealed one by one. Can you guess who it is before all clues are shown?"/>
<meta property="og:site_name" content="TeleStats"/>
<meta property="og:type" content="website"/>
<meta property="og:title" content="Who Am I? — TeleStats"/>
<meta property="og:description" content="A mystery player is chosen. Clues are revealed one by one. Can you guess who it is?"/>
<meta property="og:image" content="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png"/>
<meta property="og:url" content="https://telestats.net/games/whoami.html"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Who Am I? — TeleStats"/>
<meta name="twitter:description" content="A mystery player is chosen. Clues are revealed one by one. Can you guess who it is?"/>
<meta name="twitter:image" content="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png"/>
<link rel="stylesheet" href="../telestats-theme.css"/>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  padding: 12px;
  line-height: 1.4;
}

.container { max-width: 480px; margin: 0 auto; }

.back-link {
  display: inline-block;
  color: var(--muted);
  text-decoration: none;
  font-size: 13px;
  margin-bottom: 8px;
}
.back-link:hover { color: var(--accent-cyan); }

.header {
  text-align: center;
  padding: 16px 0 8px;
}
.header h1 {
  font-size: 26px;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.header h1 span { color: var(--accent-cyan); }
.header .subtitle {
  color: var(--muted);
  font-size: 13px;
  margin-top: 4px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}
.card h2 { font-size: 17px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.5px; }

.option-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 16px;
}
.option-btn {
  background: var(--card-dark);
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 12px 10px;
  color: var(--ink);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.option-btn .color-dot {
  display: inline-block;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  vertical-align: middle;
  margin-bottom: 4px;
  border: 1px solid rgba(255,255,255,0.2);
}
.option-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }
.option-btn.wide { grid-column: 1 / -1; }

/* Bullseye-style scope sections */
.section { background: var(--card-dark); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
.section-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; cursor: pointer; transition: background 0.15s; }
.section-header:hover { background: rgba(255,255,255,0.03); }
.section-title { font-weight: 700; font-size: 15px; }
.section-count { font-size: 12px; color: var(--muted); font-weight: 400; }
.chev { opacity: 0.7; transition: transform 0.2s; font-size: 12px; }
.section.open .chev { transform: rotate(180deg); }
.section-body { display: none; padding: 0 0 4px; }
.section.open .section-body { display: block; }
.scope-card { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid rgba(255,255,255,0.05); }
.scope-card:last-child { border-bottom: none; }
.scope-card:hover { background: rgba(255,255,255,0.06); }
.scope-card.selected { background: rgba(0,229,255,0.10); }
.scope-card .sc-icon { font-size: 18px; margin-right: 10px; }
.scope-card .sc-dot { width: 18px; height: 18px; border-radius: 4px; margin-right: 10px; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2); }
.scope-card .sc-label { font-weight: 600; font-size: 13px; flex: 1; }
.scope-card .sc-arrow { opacity: 0.5; font-size: 14px; }

.go-btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  letter-spacing: 0.3px;
}

/* ====== DIFFICULTY SELECTOR ====== */
.difficulty-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}
.diff-btn {
  background: var(--card-dark);
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 12px 8px;
  color: var(--ink);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
}
.diff-btn:hover { border-color: rgba(0,229,255,0.4); background: var(--btn); }
.diff-btn.selected { border-color: var(--accent-cyan); background: rgba(0,229,255,0.10); box-shadow: inset 0 0 0 1px var(--accent-cyan); }
.diff-btn .diff-icon { font-size: 20px; display: block; margin-bottom: 4px; }
.diff-btn .diff-label { font-size: 13px; font-weight: 700; display: block; }
.diff-btn .diff-desc { font-size: 10px; color: var(--muted); display: block; margin-top: 2px; }

/* ====== BLANKS DISPLAY ====== */
.blanks-container {
  text-align: center;
  padding: 20px 8px;
  min-height: 80px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 2px;
}
.blank-word {
  display: inline-flex;
  gap: 3px;
  margin: 4px 8px;
}
.blank-char {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 34px;
  border-bottom: 3px solid var(--accent-cyan);
  font-size: 20px;
  font-weight: 800;
  font-family: 'Courier New', monospace;
  color: transparent;
  transition: color 0.3s, border-color 0.3s, transform 0.3s;
  text-transform: uppercase;
}
.blank-char.revealed {
  color: var(--accent-cyan);
  transform: scale(1.1);
}
.blank-char.correct {
  color: var(--accent-green);
  border-color: var(--accent-green);
}
.blank-char.wrong {
  color: var(--danger);
  border-color: var(--danger);
}
.blank-char.hyphen, .blank-char.apostrophe {
  color: var(--accent-cyan);
  border-bottom-color: transparent;
  width: 14px;
}

.clue-list {
  list-style: none;
}
.clue-item {
  padding: 14px 16px;
  background: var(--card-dark);
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--ink);
  border-left: 3px solid var(--accent-cyan);
  opacity: 0;
  transform: translateX(-8px);
  transition: all 0.35s ease;
}
.clue-item.revealed {
  opacity: 1;
  transform: translateX(0);
}
.clue-item.locked {
  opacity: 0.3;
  border-left-color: var(--btn);
  color: var(--muted);
}
.clue-item .clue-number {
  display: inline-block;
  background: var(--accent-cyan);
  color: #000;
  font-size: 10px;
  font-weight: 800;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  border-radius: 50%;
  margin-right: 10px;
}
.clue-item.locked .clue-number { background: var(--btn); color: var(--muted); }

/* ====== GUESS AREA WITH SUGGESTIONS ====== */
.guess-area {
  margin-top: 16px;
}
.input-wrapper {
  position: relative;
}
.guess-input {
  width: 100%;
  padding: 14px 16px;
  background: var(--card-dark);
  border: 2px solid transparent;
  border-radius: 10px;
  color: var(--ink);
  font-size: 15px;
  outline: none;
  margin-bottom: 0;
}
.guess-input:focus { border-color: var(--accent); }
.guess-input::placeholder { color: var(--muted); }

.suggestions-dropdown {
  position: absolute;
  bottom: 100%;
  left: 0;
  right: 0;
  background: var(--card-dark);
  border: 1px solid var(--btn);
  border-radius: 12px;
  margin-bottom: 6px;
  max-height: 280px;
  overflow-y: auto;
  z-index: 50;
  box-shadow: 0 -8px 24px rgba(0,0,0,0.5);
}
.suggestions-dropdown.hidden { display: none; }

.suggestion-item {
  padding: 12px 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  transition: background 0.1s;
}
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item:hover { background: var(--bg-elevated); }
.suggestion-item:first-child { border-radius: 12px 12px 0 0; }
.suggestion-item:last-child { border-radius: 0 0 12px 12px; }
.suggestion-item:only-child { border-radius: 12px; }

.suggestion-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--ink);
}
.suggestion-meta {
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
}

.suggestion-loading {
  padding: 12px 16px;
  text-align: center;
  font-size: 13px;
  color: var(--muted);
}

.guess-feedback {
  text-align: center;
  padding: 8px;
  font-size: 14px;
  font-weight: 600;
  min-height: 36px;
}
.guess-feedback.wrong { color: var(--danger); }
.guess-feedback.correct { color: var(--accent-green); }

.reveal-card {
  text-align: center;
  padding: 24px;
}
.reveal-card .player-name {
  font-size: 28px;
  font-weight: 800;
  color: var(--accent-cyan);
  margin-bottom: 8px;
  font-family: 'Space Mono', monospace;
  letter-spacing: -1px;
}
.reveal-card .player-meta {
  font-size: 14px;
  color: var(--muted);
}
.reveal-card .result-badge {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 700;
  margin-top: 12px;
  font-family: 'Space Mono', monospace;
  letter-spacing: 0.5px;
}
.reveal-card .result-badge.win { background: var(--accent-green); color: #0B0F12; }
.reveal-card .result-badge.lose { background: var(--danger); color: #fff; }

.clue-counter {
  background: var(--accent-magenta);
  color: #fff;
  display: inline-block;
  padding: 4px 12px;
  border-radius: 3px;
  font-family: 'Space Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 8px;
}

.scope-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--card-dark);
  padding: 6px 14px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 12px;
  font-family: 'Space Mono', monospace;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.scope-badge .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-cyan);
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--muted);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.hidden { display: none !important; }

.btn-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.btn-row .go-btn { flex: 1; }

@keyframes popIn {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.2); }
  100% { transform: scale(1.1); opacity: 1; }
}
.blank-char.pop {
  animation: popIn 0.3s ease forwards;
}
</style>
</head>
<body>

<div class="ts-header">
  <img src="https://res.cloudinary.com/dbfvogb95/image/upload/v1770835428/Screenshot_2026-02-11_at_19.43.16_m7urul.png" alt="TeleStats" class="ts-logo"/>
  <span>EPL &middot; WHO AM I?</span>
  <span class="ts-time" id="tsTime"></span>
</div>

<div class="container">
  <a href="index.html" class="back-link">&larr; All Games</a>

  <div class="header">
    <h1>Who Am <span>I?</span></h1>
    <div class="subtitle">Guess the mystery player from clues</div>
  </div>

  <div class="game-meta-links">
    <button class="game-meta-link" onclick="showRules()">&#9432; How to Play</button>
  </div>

  <!-- STEP 1: SETUP -->
  <div id="step1">
    <div class="card">
      <h2>Difficulty</h2>
      <div class="difficulty-grid" id="difficultyGrid">
        <button class="diff-btn selected" data-diff="easy">
          <span class="diff-icon">&#11088;</span>
          <span class="diff-label">Easy</span>
          <span class="diff-desc">Household names</span>
        </button>
        <button class="diff-btn" data-diff="medium">
          <span class="diff-icon">&#128293;</span>
          <span class="diff-label">Medium</span>
          <span class="diff-desc">Solid careers</span>
        </button>
        <button class="diff-btn" data-diff="hard">
          <span class="diff-icon">&#128128;</span>
          <span class="diff-label">Hard</span>
          <span class="diff-desc">1-3 season wonders</span>
        </button>
      </div>
    </div>
    <div class="card">
      <h2>Choose Team</h2>
      <div id="scopeGrid"></div>
    </div>
    <button class="go-btn primary" id="startBtn" disabled>Start Game</button>
  </div>

  <!-- STEP 2: GAME -->
  <div id="step2" class="hidden">
    <div class="scope-badge" id="gameBadge"></div>

    <div class="card">
      <div class="blanks-container" id="blanksDisplay"></div>
    </div>

    <div class="card">
      <div class="clue-counter" id="clueCounter">Clue 1 of 5</div>
      <ul class="clue-list" id="clueList"></ul>

      <button class="go-btn secondary" id="nextClueBtn">Reveal Next Clue</button>
    </div>

    <div class="card">
      <div class="guess-area">
        <div class="input-wrapper">
          <div id="suggestionsDropdown" class="suggestions-dropdown hidden"></div>
          <input type="text" class="guess-input" id="guessInput" placeholder="Type player name..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        </div>
        <div class="guess-feedback" id="guessFeedback"></div>
        <button class="go-btn primary" id="guessBtn">Guess</button>
      </div>
    </div>

    <!-- Reveal card (shown on win or give up) -->
    <div id="revealCard" class="card hidden">
      <div class="reveal-card">
        <div class="player-name" id="revealName"></div>
        <div class="player-meta" id="revealMeta"></div>
        <div class="result-badge" id="resultBadge"></div>
      </div>
    </div>

    <div class="btn-row" id="actionBtns">
      <button class="go-btn secondary" id="giveUpBtn">Give Up</button>
      <button class="go-btn primary hidden" id="playAgainBtn">Play Again</button>
    </div>
  </div>
</div>

<!-- How to Play Modal -->
<div class="game-rules-overlay" id="rulesOverlay" onclick="if(event.target===this)closeRules()">
  <div class="game-rules-modal">
    <button class="game-rules-close" onclick="closeRules()">&times;</button>
    <h3>How to Play Who Am I?</h3>
    <div class="rule-step"><div class="rule-num">1</div><div class="rule-text">Choose a <strong>difficulty</strong> — Easy gives more clues, Hard gives fewer.</div></div>
    <div class="rule-step"><div class="rule-num">2</div><div class="rule-text">Pick a <strong>team or league</strong> for your mystery players.</div></div>
    <div class="rule-step"><div class="rule-num">3</div><div class="rule-text">Clues are revealed one at a time — career stats, clubs played for, nationality, and more.</div></div>
    <div class="rule-step"><div class="rule-num">4</div><div class="rule-text">Guess the player at any point. The <strong>fewer clues</strong> you need, the higher your score!</div></div>
    <div class="rule-step"><div class="rule-num">5</div><div class="rule-text">Work through multiple rounds and try to <strong>maximise your total score</strong>.</div></div>
  </div>
</div>
<script>
function showRules(){document.getElementById('rulesOverlay').classList.add('active');}
function closeRules(){document.getElementById('rulesOverlay').classList.remove('active');}
</script>

<footer style="text-align:center;padding:16px 16px 72px;font-size:11px;color:var(--muted);opacity:0.6;">
  TeleStats.net &middot; Built by <a href="https://shiftedlabs.io" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">Shifted.Labs</a>
</footer>

<script>
const API_BASE = '/.netlify/functions';
const $ = id => document.getElementById(id);

const CLUB_COLOURS = {
  'club_arsenal': '#EF0107',
  'club_astonvilla': '#670E36',
  'club_blackburn': '#009EE0',
  'club_bolton': '#263C7F',
  'club_bournemouth': '#DA291C',
  'club_brentford': '#E30613',
  'club_brighton': '#0057B8',
  'club_burnley': '#6C1D45',
  'club_charlton': '#D4021D',
  'club_chelsea': '#034694',
  'club_coventry': '#27A9E1',
  'club_crystalpalace': '#1B458F',
  'club_derby': '#000000',
  'club_everton': '#003399',
  'club_fulham': '#000000',
  'club_ipswich': '#0033A0',
  'club_leeds': '#FFCD00',
  'club_leicester': '#003090',
  'club_liverpool': '#C8102E',
  'club_mancity': '#6CABDD',
  'club_manutd': '#DA291C',
  'club_middlesbrough': '#E11B22',
  'club_newcastle': '#241F20',
  'club_norwich': '#00A650',
  'club_nottmforest': '#DD0000',
  'club_portsmouth': '#001489',
  'club_qpr': '#1D5BA4',
  'club_reading': '#004494',
  'club_sheffutd': '#EE2737',
  'club_sheffwed': '#0066B3',
  'club_southampton': '#D71920',
  'club_stoke': '#E03A3E',
  'club_sunderland': '#EB172B',
  'club_swansea': '#000000',
  'club_tottenham': '#132257',
  'club_watford': '#FBEC5D',
  'club_westbrom': '#122F67',
  'club_westham': '#7A263A',
  'club_wigan': '#0033A0',
  'club_wimbledon': '#00008B',
  'club_wolves': '#FDB913',
};

const SCOPES = [
  { id: 'epl_alltime', label: 'Premier League (All-time)', type: 'league' },
  { id: 'club_arsenal',     label: 'Arsenal',        type: 'club' },
  { id: 'club_astonvilla',  label: 'Aston Villa',    type: 'club' },
  { id: 'club_blackburn',   label: 'Blackburn',      type: 'club' },
  { id: 'club_bolton',      label: 'Bolton',         type: 'club' },
  { id: 'club_bournemouth', label: 'Bournemouth',    type: 'club' },
  { id: 'club_brentford',   label: 'Brentford',      type: 'club' },
  { id: 'club_brighton',    label: 'Brighton',       type: 'club' },
  { id: 'club_burnley',     label: 'Burnley',        type: 'club' },
  { id: 'club_charlton',    label: 'Charlton',       type: 'club' },
  { id: 'club_chelsea',     label: 'Chelsea',        type: 'club' },
  { id: 'club_coventry',    label: 'Coventry',       type: 'club' },
  { id: 'club_crystalpalace', label: 'Crystal Palace', type: 'club' },
  { id: 'club_derby',       label: 'Derby',          type: 'club' },
  { id: 'club_everton',     label: 'Everton',        type: 'club' },
  { id: 'club_fulham',      label: 'Fulham',         type: 'club' },
  { id: 'club_ipswich',     label: 'Ipswich',        type: 'club' },
  { id: 'club_leeds',       label: 'Leeds',          type: 'club' },
  { id: 'club_leicester',   label: 'Leicester',      type: 'club' },
  { id: 'club_liverpool',   label: 'Liverpool',      type: 'club' },
  { id: 'club_mancity',     label: 'Man City',       type: 'club' },
  { id: 'club_manutd',      label: 'Man Utd',        type: 'club' },
  { id: 'club_middlesbrough', label: 'Middlesbrough', type: 'club' },
  { id: 'club_newcastle',   label: 'Newcastle',      type: 'club' },
  { id: 'club_norwich',     label: 'Norwich',        type: 'club' },
  { id: 'club_nottmforest', label: 'Nottm Forest',   type: 'club' },
  { id: 'club_portsmouth',  label: 'Portsmouth',     type: 'club' },
  { id: 'club_qpr',         label: 'QPR',            type: 'club' },
  { id: 'club_reading',     label: 'Reading',        type: 'club' },
  { id: 'club_sheffutd',    label: 'Sheff Utd',      type: 'club' },
  { id: 'club_sheffwed',    label: 'Sheff Wed',      type: 'club' },
  { id: 'club_southampton', label: 'Southampton',    type: 'club' },
  { id: 'club_stoke',       label: 'Stoke',          type: 'club' },
  { id: 'club_sunderland',  label: 'Sunderland',     type: 'club' },
  { id: 'club_swansea',     label: 'Swansea',        type: 'club' },
  { id: 'club_tottenham',   label: 'Spurs',          type: 'club' },
  { id: 'club_watford',     label: 'Watford',        type: 'club' },
  { id: 'club_westbrom',    label: 'West Brom',      type: 'club' },
  { id: 'club_westham',     label: 'West Ham',       type: 'club' },
  { id: 'club_wigan',       label: 'Wigan',          type: 'club' },
  { id: 'club_wimbledon',   label: 'Wimbledon',      type: 'club' },
  { id: 'club_wolves',      label: 'Wolves',         type: 'club' },
];

let selectedScope = null;
let selectedDifficulty = 'easy'; // default to easy
let gameData = null;
let cluesRevealed = 0;
let gameOver = false;
let guessCount = 0;
let searchDebounce = null;
let selectedSuggestion = null; // the player name selected from dropdown

// ============================================================
// SCOPE SECTIONS (Bullseye-style)
// ============================================================
function makeScopeSection(title, items, open) {
  const sec = document.createElement('div');
  sec.className = 'section' + (open ? ' open' : '');
  const header = document.createElement('div');
  header.className = 'section-header';
  header.innerHTML = `<div class="section-title">${title}</div><div class="chev">\u25BC</div>`;
  header.onclick = () => sec.classList.toggle('open');
  sec.appendChild(header);

  const body = document.createElement('div');
  body.className = 'section-body';
  for (const s of items) {
    const card = document.createElement('div');
    card.className = 'scope-card';
    const colour = CLUB_COLOURS[s.id];
    if (s.type === 'league') {
      card.innerHTML = `<span class="sc-icon">\uD83C\uDFC6</span><span class="sc-label">${s.label}</span><span class="sc-arrow">\u203A</span>`;
    } else {
      card.innerHTML = `<span class="sc-dot" style="background:${colour || '#555'}"></span><span class="sc-label">${s.label}</span><span class="sc-arrow">\u203A</span>`;
    }
    card.onclick = () => {
      $('scopeGrid').querySelectorAll('.scope-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedScope = s.id;
      $('startBtn').disabled = false;
    };
    body.appendChild(card);
  }
  sec.appendChild(body);
  return sec;
}

// ============================================================
// INIT
// ============================================================
function init() {
  const grid = $('scopeGrid');
  grid.innerHTML = '';

  const leagueScopes = SCOPES.filter(s => s.type === 'league');
  const clubScopes = SCOPES.filter(s => s.type === 'club');

  if (leagueScopes.length > 0) grid.appendChild(makeScopeSection('Combined', leagueScopes, true));
  if (clubScopes.length > 0) grid.appendChild(makeScopeSection('Teams (' + clubScopes.length + ')', clubScopes, false));

  // Difficulty buttons
  $('difficultyGrid').querySelectorAll('.diff-btn').forEach(btn => {
    btn.onclick = () => {
      selectedDifficulty = btn.dataset.diff;
      $('difficultyGrid').querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
  });

  $('startBtn').onclick = startGame;
  $('nextClueBtn').onclick = revealNextClue;
  $('guessBtn').onclick = submitGuess;
  $('giveUpBtn').onclick = giveUp;
  $('playAgainBtn').onclick = resetToSetup;

  // Typeahead search on input
  $('guessInput').addEventListener('input', () => {
    selectedSuggestion = null;
    clearTimeout(searchDebounce);
    const q = $('guessInput').value.trim();
    if (q.length < 2) {
      hideSuggestions();
      return;
    }
    searchDebounce = setTimeout(() => doSearch(q), 250);
  });

  // Submit on Enter
  $('guessInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      hideSuggestions();
      submitGuess();
    }
  });

  // Close suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.guess-area')) {
      hideSuggestions();
    }
  });
}

// ============================================================
// BLANKS RENDERING
// ============================================================
function renderBlanks(name, revealedName, colorClass) {
  const container = $('blanksDisplay');
  container.innerHTML = '';

  if (!name) return;

  // Split name into words
  const words = name.split(' ');

  for (let wi = 0; wi < words.length; wi++) {
    const wordEl = document.createElement('span');
    wordEl.className = 'blank-word';

    for (let ci = 0; ci < words[wi].length; ci++) {
      const ch = words[wi][ci];
      const charEl = document.createElement('span');
      charEl.className = 'blank-char';

      if (ch === '-') {
        charEl.className = 'blank-char hyphen';
        charEl.textContent = '-';
      } else if (ch === "'") {
        charEl.className = 'blank-char apostrophe';
        charEl.textContent = "'";
      } else {
        // If we have a revealed name, show the letter
        if (revealedName) {
          charEl.textContent = ch;
          charEl.classList.add('revealed');
          if (colorClass) charEl.classList.add(colorClass);
        }
      }

      wordEl.appendChild(charEl);
    }

    container.appendChild(wordEl);
  }
}

/**
 * Animate filling in the blanks letter by letter, then flash color.
 * For wrong guesses, temporarily rebuilds blanks to match the guessed name.
 * Returns a promise that resolves when animation is done.
 */
function animateBlanksReveal(guessedName, isCorrect) {
  return new Promise(resolve => {
    const container = $('blanksDisplay');
    const colorClass = isCorrect ? 'correct' : 'wrong';

    if (!isCorrect) {
      // For wrong guesses: rebuild blanks to match the guessed name structure
      container.innerHTML = '';
      const words = guessedName.trim().split(/\s+/);
      for (const word of words) {
        const wordEl = document.createElement('span');
        wordEl.className = 'blank-word';
        for (const ch of word) {
          const charEl = document.createElement('span');
          if (ch === '-') {
            charEl.className = 'blank-char hyphen';
            charEl.textContent = '-';
          } else if (ch === "'") {
            charEl.className = 'blank-char apostrophe';
            charEl.textContent = "'";
          } else {
            charEl.className = 'blank-char';
          }
          wordEl.appendChild(charEl);
        }
        container.appendChild(wordEl);
      }
    }

    const allChars = container.querySelectorAll('.blank-char:not(.hyphen):not(.apostrophe)');

    // Build flat array of letters from guessedName
    const letters = [];
    for (const word of guessedName.trim().split(/\s+/)) {
      for (const ch of word) {
        if (ch !== '-' && ch !== "'") letters.push(ch);
      }
    }

    let idx = 0;

    function revealNext() {
      if (idx >= allChars.length || idx >= letters.length) {
        // Flash all at once with final color
        setTimeout(() => {
          allChars.forEach(el => {
            el.classList.add(colorClass);
          });
          resolve();
        }, 200);
        return;
      }

      const el = allChars[idx];
      el.textContent = letters[idx];
      el.classList.add('revealed', 'pop', colorClass);
      idx++;
      setTimeout(revealNext, 60);
    }

    revealNext();
  });
}

// ============================================================
// PLAYER SEARCH / SUGGESTIONS
// ============================================================
// Cache search results to avoid repeated API calls for same/similar queries
const searchCache = new Map();

async function doSearch(query) {
  if (gameOver) return;

  const dropdown = $('suggestionsDropdown');
  const cacheKey = `${selectedScope}_${query.toLowerCase()}`;

  // Check cache first
  if (searchCache.has(cacheKey)) {
    renderSuggestions(searchCache.get(cacheKey));
    return;
  }

  dropdown.innerHTML = '<div class="suggestion-loading"><span class="spinner"></span></div>';
  dropdown.classList.remove('hidden');

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'search_players',
        scopeId: selectedScope,
        query,
      }),
    });
    const data = await res.json();

    if (gameOver) { hideSuggestions(); return; }

    const players = data.players || [];
    searchCache.set(cacheKey, players);
    renderSuggestions(players);

  } catch (err) {
    console.error('Search error:', err);
    dropdown.innerHTML = '<div class="suggestion-loading" style="color:var(--danger);">Search failed</div>';
  }
}

function renderSuggestions(players) {
  const dropdown = $('suggestionsDropdown');
  dropdown.classList.remove('hidden');

  if (players.length === 0) {
    dropdown.innerHTML = '<div class="suggestion-loading" style="color:var(--muted);">No players found</div>';
    return;
  }

  dropdown.innerHTML = players.map(p => `
    <div class="suggestion-item" data-name="${escHtml(p.name)}">
      <span class="suggestion-name">${escHtml(p.name)}</span>
      <span class="suggestion-meta">${p.nationality} &middot; ${p.appearances} apps</span>
    </div>
  `).join('');

  dropdown.querySelectorAll('.suggestion-item').forEach(item => {
    item.onclick = (e) => {
      e.stopPropagation();
      const name = item.dataset.name;
      selectedSuggestion = name;
      $('guessInput').value = name;
      hideSuggestions();
      submitGuess();
    };
  });
}

function hideSuggestions() {
  $('suggestionsDropdown').classList.add('hidden');
  $('suggestionsDropdown').innerHTML = '';
}

function escHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ============================================================
// GAME FLOW
// ============================================================
async function startGame() {
  $('startBtn').disabled = true;
  $('startBtn').innerHTML = '<span class="spinner"></span> Loading...';

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'start_game', scopeId: selectedScope, difficulty: selectedDifficulty }),
    });
    gameData = await res.json();

    if (gameData.error) throw new Error(gameData.error);

    cluesRevealed = 0;
    gameOver = false;
    guessCount = 0;
    selectedSuggestion = null;

    // Setup UI
    const scopeLabel = SCOPES.find(s => s.id === selectedScope)?.label || '';
    const diffLabel = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
    $('gameBadge').innerHTML = `<span class="dot"></span> ${scopeLabel} &middot; ${diffLabel}`;

    // Display blanks from the pattern
    renderBlanksFromPattern(gameData.blanks);

    // Setup clue items (all locked initially)
    const clueList = $('clueList');
    clueList.innerHTML = '';
    for (let i = 0; i < gameData.clues.length; i++) {
      const li = document.createElement('li');
      li.className = 'clue-item locked';
      li.id = `clue${i}`;
      li.innerHTML = `<span class="clue-number">${i + 1}</span> ?`;
      clueList.appendChild(li);
    }

    // Reveal first clue
    revealNextClue();

    // Show game
    $('step1').classList.add('hidden');
    $('step2').classList.remove('hidden');
    $('revealCard').classList.add('hidden');
    $('playAgainBtn').classList.add('hidden');
    $('giveUpBtn').classList.remove('hidden');
    $('guessInput').value = '';
    $('guessFeedback').textContent = '';
    $('guessFeedback').className = 'guess-feedback';
    $('guessBtn').disabled = false;
    $('guessInput').disabled = false;
    $('nextClueBtn').classList.remove('hidden');
    hideSuggestions();

    setTimeout(() => $('guessInput').focus(), 200);

  } catch (err) {
    alert('Failed to start game: ' + err.message);
  }

  $('startBtn').disabled = false;
  $('startBtn').textContent = 'Start Game';
}

/**
 * Render blanks from the server-provided pattern string.
 * Parses the pattern to reconstruct word structure.
 */
function renderBlanksFromPattern(blanksStr) {
  const container = $('blanksDisplay');
  container.innerHTML = '';

  if (!blanksStr) return;

  // The pattern uses: _ for letters, double space for word gaps, - for hyphens, ' for apostrophes
  // Split by triple-space (word separator) — the blanks format uses "   " between words
  const rawWords = blanksStr.split(/\s{3,}/);

  for (const rawWord of rawWords) {
    const wordEl = document.createElement('span');
    wordEl.className = 'blank-word';

    // Each char in the word is separated by single space
    const chars = rawWord.split(' ').filter(c => c !== '');

    for (const ch of chars) {
      const charEl = document.createElement('span');
      if (ch === '-') {
        charEl.className = 'blank-char hyphen';
        charEl.textContent = '-';
      } else if (ch === "'") {
        charEl.className = 'blank-char apostrophe';
        charEl.textContent = "'";
      } else {
        charEl.className = 'blank-char';
        // Leave empty for underscore blanks
      }
      wordEl.appendChild(charEl);
    }

    container.appendChild(wordEl);
  }
}

function revealNextClue() {
  if (cluesRevealed >= gameData.clues.length || gameOver) return;

  const clueEl = $(`clue${cluesRevealed}`);
  const clueText = gameData.clues[cluesRevealed];
  clueEl.innerHTML = `<span class="clue-number">${cluesRevealed + 1}</span> ${clueText}`;
  clueEl.classList.remove('locked');
  clueEl.classList.add('revealed');

  cluesRevealed++;
  $('clueCounter').textContent = `Clue ${cluesRevealed} of ${gameData.clues.length}`;

  if (cluesRevealed >= gameData.clues.length) {
    $('nextClueBtn').classList.add('hidden');
  }
}

async function submitGuess() {
  const guess = $('guessInput').value.trim();
  if (guess.length < 2 || gameOver) return;

  guessCount++;
  $('guessBtn').disabled = true;
  $('guessBtn').innerHTML = '<span class="spinner"></span>';
  $('guessInput').disabled = true;
  hideSuggestions();

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'check_answer',
        scopeId: selectedScope,
        playerId: gameData.playerId,
        guess,
      }),
    });
    const result = await res.json();

    if (result.correct) {
      gameOver = true;
      // Animate the correct answer into blanks
      await animateBlanksReveal(result.player.name, true);
      showResult(true, result.player);
    } else {
      // Animate the guessed name into blanks, then flash red and reset
      await animateBlanksReveal(guess, false);
      await sleep(600);
      // Reset blanks back to empty underscores
      renderBlanksFromPattern(gameData.blanks);
      $('guessFeedback').textContent = 'Wrong! Try again...';
      $('guessFeedback').className = 'guess-feedback wrong';
      $('guessInput').value = '';
      $('guessInput').disabled = false;
      $('guessInput').focus();
    }
  } catch (err) {
    $('guessFeedback').textContent = 'Error checking answer. Try again.';
    $('guessFeedback').className = 'guess-feedback wrong';
    $('guessInput').disabled = false;
  }

  $('guessBtn').disabled = false;
  $('guessBtn').textContent = 'Guess';
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function giveUp() {
  gameOver = true;
  $('giveUpBtn').disabled = true;
  $('guessInput').disabled = true;
  hideSuggestions();

  try {
    const res = await fetch(`${API_BASE}/whoami_start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'check_answer',
        scopeId: selectedScope,
        playerId: gameData.playerId,
        guess: '__GIVE_UP__',
        giveUp: true,
      }),
    });
    const result = await res.json();

    // Animate the answer into blanks (red for give up)
    await animateBlanksReveal(result.player.name, false);
    showResult(false, result.player);
  } catch (err) {
    $('guessFeedback').textContent = 'Failed to reveal answer.';
  }

  $('giveUpBtn').disabled = false;
}

function showResult(won, player) {
  // Collapse clues to a summary line instead of showing all expanded
  const clueList = $('clueList');
  clueList.style.maxHeight = '0';
  clueList.style.overflow = 'hidden';
  clueList.style.transition = 'max-height 0.3s ease';
  $('nextClueBtn').classList.add('hidden');
  $('clueCounter').textContent = `${cluesRevealed} clue${cluesRevealed !== 1 ? 's' : ''} revealed`;
  $('clueCounter').style.cursor = 'pointer';
  $('clueCounter').onclick = () => {
    // Toggle clue visibility
    if (clueList.style.maxHeight === '0px' || clueList.style.maxHeight === '0') {
      // Reveal all clues before showing
      for (let i = 0; i < gameData.clues.length; i++) {
        const clueEl = $(`clue${i}`);
        const clueText = gameData.clues[i];
        clueEl.innerHTML = `<span class="clue-number">${i + 1}</span> ${clueText}`;
        clueEl.classList.remove('locked');
        clueEl.classList.add('revealed');
      }
      clueList.style.maxHeight = '500px';
      $('clueCounter').textContent = `${cluesRevealed} clues ▲ hide`;
    } else {
      clueList.style.maxHeight = '0';
      $('clueCounter').textContent = `${cluesRevealed} clue${cluesRevealed !== 1 ? 's' : ''} revealed ▼ show`;
    }
  };
  $('clueCounter').textContent += ' ▼ show';

  // Show reveal card
  $('revealName').textContent = player.name;
  const apps = player.stats ? player.stats.appearances : (player.appearances || 0);
  const goals = player.stats ? player.stats.goals : (player.goals || 0);
  const natLabel = player.nationalityLabel || player.nationality || '';
  $('revealMeta').textContent = `${natLabel} | ${apps} apps | ${goals} goals`;

  const badge = $('resultBadge');
  if (won) {
    const clueWord = cluesRevealed === 1 ? 'clue' : 'clues';
    badge.textContent = `Guessed in ${guessCount} ${guessCount === 1 ? 'try' : 'tries'} with ${cluesRevealed} ${clueWord}!`;
    badge.className = 'result-badge win';
  } else {
    badge.textContent = 'Better luck next time!';
    badge.className = 'result-badge lose';
  }

  $('revealCard').classList.remove('hidden');
  $('giveUpBtn').classList.add('hidden');
  $('playAgainBtn').classList.remove('hidden');
  $('guessInput').disabled = true;
  $('guessBtn').disabled = true;

  // Scroll result card into view
  setTimeout(() => {
    $('revealCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function resetToSetup() {
  $('step2').classList.add('hidden');
  $('step1').classList.remove('hidden');
  gameData = null;
  cluesRevealed = 0;
  gameOver = false;
  guessCount = 0;
  selectedSuggestion = null;
  hideSuggestions();
  // Keep scope and difficulty selections for quick replay
}

// ============================================================
// BOOT
// ============================================================
init();

// ============================================================
// TELESTATS CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const el = document.getElementById('tsTime');
  if (el) el.textContent = hh + ':' + mm;
}
updateClock();
setInterval(updateClock, 30000);
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/ts-auth.js"></script>
<script src="/js/ts-data.js"></script>
<script src="/js/ts-nav.js"></script>
<script>
(async function tsIntegrate() {
  await TSAuth.init();
  TSNav.render();

  // Hook showResult to log session
  const _origShowResult = window.showResult;
  window.showResult = function (won, player) {
    _origShowResult(won, player);
    tsLogWhoAmISession(won);
  };

  async function tsLogWhoAmISession(won) {
    try {
      const scopeLabel = selectedScope || '';
      const result = await TSData.logGameSession({
        game_type: 'who_am_i',
        game_category: scopeLabel,
        score: won ? Math.max(1, 6 - cluesRevealed) : 0,
        correct_answers: won ? 1 : 0,
        total_questions: 1,
        guesses_used: guessCount,
        is_perfect_round: won && cluesRevealed <= 1,
        completed: true
      });
      if (result && !result.error) {
        TSNav.showXPToast(result);
        TSNav.showShareCard({
          game_type: 'who_am_i',
          game_category: scopeLabel,
          guesses_used: guessCount,
          is_perfect_round: won && cluesRevealed <= 1,
          xp_earned: result.xp_earned
        });
      }
    } catch (e) { console.warn('[TS] session log failed:', e); }
  }
})();
</script>
</body>
</html>
