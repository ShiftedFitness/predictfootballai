<script>
const base='/.netlify/functions';

function h(t){ return document.getElementById(t); }
function setStatus(msg){ h('status').textContent = msg; }
function withLoading(btn, fn){
  const orig = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span style="display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;margin-right:8px;vertical-align:-2px;animation:spin .7s linear infinite"></span>Working…';
  return fn().finally(()=>{ btn.disabled=false; btn.innerHTML=orig; });
}
(function addSpinCss(){
  const s=document.createElement('style');
  s.textContent='@keyframes spin{to{transform:rotate(360deg)}}';
  document.head.appendChild(s);
})();

function row(match){
  const sel = (val)=>`<option ${val==='HOME'?'selected':''}>HOME</option>
                      <option ${val==='DRAW'?'selected':''}>DRAW</option>
                      <option ${val==='AWAY'?'selected':''}>AWAY</option>`;
  return `<tr data-id="${match.id}">
    <td>${match.id}</td>
    <td>${match['Home Team']} v ${match['Away Team']}</td>
    <td><select class="result">${sel((match['Correct Result']||'').toUpperCase())}</select></td>
  </tr>`;
}

// Load matches
h('load').onclick = ()=> withLoading(h('load'), async ()=>{
  const week = Number(h('week').value);
  const res = await fetch(`${base}/get-week?week=${encodeURIComponent(week)}&userId=0`, { cache:'no-store' });
  const data = await res.json();
  const m = data.matches || [];
  setStatus(`Loaded ${m.length} matches`);
  h('matches').innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Fixture</th><th>Correct Result</th></tr></thead>
      <tbody>${m.map(row).join('')}</tbody>
    </table>`;
  // prefill next week = current + 1
  h('nextWeek').value = String(week + 1);
});

// Apply results & (optionally) lock
h('applyResults').onclick = ()=> withLoading(h('applyResults'), async ()=>{
  const secret = h('secret').value.trim();
  const week = Number(h('week').value);
  const rows = Array.from(document.querySelectorAll('#matches tbody tr'));
  const results = rows.map(r => ({
    match_id: r.getAttribute('data-id'),
    correct: r.querySelector('select').value
  }));
  const res = await fetch(`${base}/admin-set-results`, {
    method:'POST',
    headers:{'Content-Type':'application/json','x-admin-secret':secret},
    body: JSON.stringify({ week, results })
  });
  const txt = await res.text();
  setStatus('Database updated ✓');    // show quick confirmation
  setTimeout(()=> setStatus(txt), 600); // then show details
});

// Score week
h('scoreWeek').onclick = ()=> withLoading(h('scoreWeek'), async ()=>{
  const secret = h('secret').value.trim();
  const week = Number(h('week').value);
  const res = await fetch(`${base}/admin-score-week`, {
    method:'POST',
    headers:{'Content-Type':'application/json','x-admin-secret':secret},
    body: JSON.stringify({ week })
  });
  const txt = await res.text();
  setStatus('Database updated ✓');
  setTimeout(()=> setStatus(txt), 600);
});

// Build seed rows once
(function buildSeedTable(){
  const tb = h('seedTbl').querySelector('tbody');
  tb.innerHTML = '';
  for (let i=1;i<=5;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i}</td><td><input class="home" placeholder="Home ${i}"/></td><td><input class="away" placeholder="Away ${i}"/></td>`;
    tb.appendChild(tr);
  }
})();

// Seed next week (with datetime-local picker)
h('seedBtn').onclick = ()=> withLoading(h('seedBtn'), async ()=>{
  const secret = h('secret').value.trim();
  const week = Number(h('nextWeek').value);
  const dt = h('nextLock').value; // yyyy-MM-ddTHH:mm (local)
  if (!dt) { setStatus('Please choose a lockout date & time'); return; }
  // Convert to ISO string in local time
  const lockoutIso = new Date(dt).toISOString();

  const rows = Array.from(document.querySelectorAll('#seedTbl tbody tr'));
  const fixtures = rows.map(r => ({
    home: r.querySelector('.home').value.trim(),
    away: r.querySelector('.away').value.trim()
  }));
  if (fixtures.some(f => !f.home || !f.away)) { setStatus('Please fill all 5 fixtures'); return; }

  const res = await fetch(`${base}/admin-seed-week`, {
    method:'POST',
    headers:{'Content-Type':'application/json','x-admin-secret':secret},
    body: JSON.stringify({ week, lockoutTime: lockoutIso, fixtures })
  });
  const txt = await res.text();
  setStatus('Database updated ✓');
  setTimeout(()=> setStatus(txt), 600);
});
</script>
